<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>MAK Taksit Asistanı</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#a78bfa">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/a78bfa/ffffff?text=MAK">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrBefore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrAfter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/localizedFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/tr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-primary: #1e293b; --bg-secondary: #0f172a; --bg-tertiary: #334155;
            --text-primary: #e2e8f0; --text-secondary: #94a3b8; --border-color: #475569;
            --accent-color: #a78bfa; --accent-color-dark: #8b5cf6;
            --accent-bg-light: #a78bfa26; --accent-text-light: var(--accent-color);
            --font-size-base: 16px;
        }
        .theme-sunset { /* Neon Gün Batımı */
            --bg-primary: #2c1b3e; --bg-secondary: #1a0f29; --bg-tertiary: #402a5c;
            --text-primary: #f5eaff; --text-secondary: #d1c4e9; --border-color: #5a3c82;
            --accent-color: #ff79c6; --accent-color-dark: #ff4da6;
            --accent-bg-light: #ff79c626; --accent-text-light: #ff79c6;
        }
        .theme-ocean { /* Okyanus Esintisi */
            --bg-primary: #ffffff; --bg-secondary: #f0f9ff; --bg-tertiary: #e0f2fe;
            --text-primary: #082f49; --text-secondary: #075985; --border-color: #bae6fd;
            --accent-color: #0ea5e9; --accent-color-dark: #0284c7;
            --accent-bg-light: #0ea5e926; --accent-text-light: var(--accent-color-dark);
        }
        .theme-graphite { /* Grafit ve Altın */
            --bg-primary: #282c34; --bg-secondary: #1e2228; --bg-tertiary: #3e444c;
            --text-primary: #dce1e8; --text-secondary: #a0a8b4; --border-color: #4b5263;
            --accent-color: #d4af37; --accent-color-dark: #c09b2d;
            --accent-bg-light: #d4af3726; --accent-text-light: #e6c35c;
        }
        .theme-mint { /* Nane Şekeri */
            --bg-primary: #f0fdf4; --bg-secondary: #dcfce7; --bg-tertiary: #bbf7d0;
            --text-primary: #14532d; --text-secondary: #166534; --border-color: #86efac;
            --accent-color: #4ade80; --accent-color-dark: #22c55e;
            --accent-bg-light: #4ade8026; --accent-text-light: #16a34a;
        }
        .theme-aurora { /* Kuzey Işıkları */
            --bg-primary: #0d1117; --bg-secondary: #010409; --bg-tertiary: #161b22;
            --text-primary: #e6edf3; --text-secondary: #a1aab4; --border-color: #30363d;
            --accent-color: #58a6ff; --accent-color-dark: #388bfd;
            --accent-bg-light: #58a6ff26; --accent-text-light: #58a6ff;
        }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-secondary);
            color: var(--text-primary); font-size: var(--font-size-base);
            transition: background-color 0.3s, color 0.3s;
            padding-bottom: 80px;
        }
        input[type="text"], input[type="search"], textarea, input[type="number"], input[type="date"], input[type="month"], select { 
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        input::placeholder, textarea::placeholder { color: var(--text-secondary); }
        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-dynamic { border-color: var(--border-color); }
        .accent-text { color: var(--accent-color); }
        .accent-bg { background-color: var(--accent-color-dark); }
        .accent-bg-hover:hover { background-color: var(--accent-color); }
        .ring-accent:focus { --tw-ring-color: var(--accent-color); }
        .tab-button { transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; }
        .tab-active { 
            background-color: var(--accent-bg-light) !important; 
            color: var(--accent-text-light) !important; 
        }
        .sort-active { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .panel { display: none; animation: fadeIn 0.5s ease-in-out; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .item-fade-out { animation: fadeOut 0.3s ease-out forwards; }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }
        .hidden { display: none; }
        input[type="month"]::-webkit-calendar-picker-indicator, input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1) brightness(0.9); cursor: pointer; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 40; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; max-height: 90vh; overflow-y: auto; }
        .pagination-btn { min-width: 2.5rem; }
        .pagination-btn.active { background-color: var(--accent-color-dark); color: white; font-weight: bold; }
        .theme-btn.active { box-shadow: 0 0 0 3px var(--accent-color); }
        .plan-details { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; padding-top: 0; padding-bottom: 0; }
        .plan-details.open { max-height: 500px; padding-top: 1rem; padding-bottom: 1rem; }

        /* Tanıtım Turu Stilleri */
        #tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        #tour-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        .tour-highlight {
            position: relative;
            z-index: 9999;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            transition: box-shadow 0.3s ease;
        }
        #tour-tooltip {
            position: absolute;
            z-index: 10000;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 300px;
            max-width: 90vw;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            visibility: hidden;
        }
        #tour-tooltip.active {
            opacity: 1;
            pointer-events: all;
            visibility: visible;
        }

    </style>
</head>
<body class="bg-secondary text-primary">
    
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="mb-8">
             <div>
                <h1 class="text-3xl md:text-4xl font-bold text-primary">MAK Taksit Asistanı</h1>
                <p id="welcome-message" class="text-secondary mt-2">Harcamalarınıza hoş geldiniz!</p>
            </div>
        </header>

        <main id="main-content">
            <div id="panel-home" class="panel active space-y-8">
                <div id="summary-panel" class="p-6 rounded-2xl shadow-lg" style="background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark)); color: white;"></div>
                <div class="bg-primary p-6 rounded-2xl shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                        <h2 class="text-xl font-bold text-primary">Aylık Ödeme Planı</h2>
                        <select id="plan-month-selector" class="w-full sm:w-auto px-3 py-2 rounded-md text-sm"></select>
                    </div>
                    <div id="payment-plan"></div>
                </div>
                <div class="bg-primary p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">Kalan Borç Dağılımı</h2>
                    <div class="max-w-sm mx-auto"><canvas id="categoryChart"></canvas></div>
                </div>
            </div>

            <div id="panel-purchases" class="panel space-y-8">
                <div class="bg-primary p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">Yeni Harcama Ekle</h2>
                    <form id="add-purchase-form" class="space-y-4">
                       <input type="text" id="purchase-name" placeholder="Harcama Açıklaması" class="mt-1 block w-full px-3 py-2 rounded-md" required>
                       <select id="purchase-category" class="mt-1 block w-full pl-3 pr-10 py-2 rounded-md" required></select>
                       <input type="date" id="purchase-date" class="mt-1 block w-full px-3 py-2 rounded-md" required>
                       <input type="number" id="total-amount" step="0.01" min="0.01" placeholder="Toplam Tutar (₺)" class="mt-1 block w-full px-3 py-2 rounded-md" required>
                       <input type="number" id="installments-count" min="1" placeholder="Taksit Sayısı" class="mt-1 block w-full px-3 py-2 rounded-md" required>
                       <select id="card-select" class="mt-1 block w-full pl-3 pr-10 py-2 rounded-md" required><option value="">Kart Seçin</option></select>
                       <div class="flex items-center">
                           <input id="purchase-recurring" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                           <label for="purchase-recurring" class="ml-2 block text-sm text-secondary">Aylık Tekrarla (Fatura, Abonelik vb.)</label>
                        </div>
                       <button type="submit" class="w-full text-white py-2 px-4 rounded-md font-semibold transition-colors accent-bg accent-bg-hover">Harcamayı Ekle</button>
                    </form>
                </div>
                <div class="bg-primary p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">Kayıtlı Harcamalarınız</h2>
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <input type="text" id="search-input" placeholder="Harcama ara..." class="flex-grow px-3 py-2 rounded-md">
                        <select id="filter-category" class="px-3 py-2 rounded-md"></select>
                    </div>
                    <div id="purchase-list-details" class="space-y-4"></div>
                    <div id="purchase-list-pagination" class="flex justify-center items-center mt-6 space-x-2"></div>
                </div>
            </div>
            
            <div id="panel-debts" class="panel space-y-8">
                <div class="bg-primary p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">Yeni Borç Ekle</h2>
                    <p class="text-sm text-secondary mb-4">Taksitli harcamalarınız dışında, belirli bir aya ait tek seferlik bir borç (örneğin elden alınan borç) ekleyebilirsiniz. Bu borç, seçtiğiniz ayın ekstre toplamına yansıtılacaktır.</p>
                    <form id="add-debt-form" class="space-y-4">
                       <input type="text" id="debt-name" placeholder="Borç Açıklaması" class="mt-1 block w-full px-3 py-2 rounded-md" required>
                       <input type="number" id="debt-amount" step="0.01" min="0.01" placeholder="Toplam Tutar (₺)" class="mt-1 block w-full px-3 py-2 rounded-md" required>
                       <select id="debt-card-select" class="mt-1 block w-full pl-3 pr-10 py-2 rounded-md" required><option value="">Borcun Yansıyacağı Kartı Seçin</option></select>
                       <div>
                           <label for="debt-payment-month" class="block text-sm font-medium text-secondary">Ödeme Ayı</label>
                           <input type="month" id="debt-payment-month" class="mt-1 block w-full px-3 py-2 rounded-md" required>
                       </div>
                       <button type="submit" class="w-full text-white py-2 px-4 rounded-md font-semibold transition-colors accent-bg accent-bg-hover">Borcu Ekle</button>
                    </form>
                </div>
                <div class="bg-primary p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">Eklediğiniz Manuel Borçlar</h2>
                    <p class="text-sm text-secondary mb-6">Burada sadece ödenmemiş manuel borçlar listelenir. Ödenenler "Geçmiş" sekmesinde görünür.</p>
                    <div id="debt-list" class="space-y-4"></div>
                </div>
            </div>

            <div id="panel-history" class="panel space-y-8">
                <div class="bg-primary p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">Ödeme Geçmişi</h2>
                    <p class="text-sm text-secondary mb-6">"Ödendi" olarak işaretlediğiniz tüm ekstreleriniz burada listelenir.</p>
                    <div id="history-list" class="space-y-4"></div>
                    <div id="history-pagination" class="flex justify-between items-center mt-6"></div>
                </div>
            </div>

            <div id="panel-subscriptions" class="panel space-y-8">
                 <div class="bg-primary p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">Aylık Abonelikleriniz</h2>
                    <p class="text-sm text-secondary mb-6">"Aylık Tekrarla" olarak işaretlediğiniz düzenli harcamalarınız burada listelenir.</p>
                    <div id="subscription-list" class="space-y-4"></div>
                </div>
            </div>

            <div id="panel-settings" class="panel space-y-8">
                <div class="bg-primary p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">Kartlarınızı Yönetin</h2>
                    <form id="add-card-form" class="space-y-4">
                        <input type="text" id="card-name" placeholder="Kart Adı (Örn: Maaş Kartım)" class="w-full px-3 py-2 rounded-md" required>
                        <input type="number" id="card-limit" min="0" placeholder="Kart Limiti (₺)" class="w-full px-3 py-2 rounded-md" required>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input type="number" id="statement-day" min="1" max="31" placeholder="Ekstre Kesim Günü" class="w-full px-3 py-2 rounded-md" required>
                            <input type="number" id="payment-day-offset" min="1" max="30" placeholder="Ödeme için Ek Süre (Gün)" class="w-full px-3 py-2 rounded-md" required>
                        </div>
                        <button type="submit" class="w-full text-white py-2 px-4 rounded-md font-semibold transition-colors accent-bg accent-bg-hover">Kart Ekle</button>
                    </form>
                    <div id="card-list" class="mt-6 space-y-4"></div>
                </div>
                <div class="bg-primary p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">Kategorileri Yönet</h2>
                    <p class="text-sm text-secondary mb-4">Harcama ve borçlarınızı sınıflandırmak için kendi kategorilerinizi oluşturun.</p>
                    <form id="add-category-form" class="flex gap-2 mb-4">
                        <input type="text" id="category-name-input" placeholder="Yeni Kategori Adı" class="flex-grow px-3 py-2 rounded-md" required>
                        <button type="submit" class="text-white px-5 py-2 rounded-md font-semibold transition-colors accent-bg accent-bg-hover">Ekle</button>
                    </form>
                    <div id="category-list" class="mt-6 space-y-2"></div>
                </div>
                <div class="bg-primary p-6 rounded-2xl shadow-sm">
                     <h2 class="text-xl font-bold mb-4 text-primary">Tema Seçenekleri</h2>
                     <div id="theme-selector" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4">
                        <button data-theme="" class="theme-btn p-2 rounded-lg border-2 border-transparent text-center">
                            <div class="h-10 rounded-md mb-2" style="background-image: linear-gradient(45deg, #1e293b, #334155);"></div>
                            <span class="text-xs text-secondary">Varsayılan</span>
                        </button>
                        <button data-theme="theme-sunset" class="theme-btn p-2 rounded-lg border-2 border-transparent text-center">
                            <div class="h-10 rounded-md mb-2" style="background-image: linear-gradient(45deg, #2c1b3e, #ff79c6);"></div>
                            <span class="text-xs text-secondary">Gün Batımı</span>
                        </button>
                        <button data-theme="theme-ocean" class="theme-btn p-2 rounded-lg border-2 border-transparent text-center">
                            <div class="h-10 rounded-md mb-2" style="background-image: linear-gradient(45deg, #f0f9ff, #0ea5e9);"></div>
                            <span class="text-xs text-secondary">Okyanus</span>
                        </button>
                        <button data-theme="theme-graphite" class="theme-btn p-2 rounded-lg border-2 border-transparent text-center">
                            <div class="h-10 rounded-md mb-2" style="background-image: linear-gradient(45deg, #282c34, #d4af37);"></div>
                            <span class="text-xs text-secondary">Grafit</span>
                        </button>
                         <button data-theme="theme-mint" class="theme-btn p-2 rounded-lg border-2 border-transparent text-center">
                            <div class="h-10 rounded-md mb-2" style="background-image: linear-gradient(45deg, #f0fdf4, #4ade80);"></div>
                            <span class="text-xs text-secondary">Nane</span>
                        </button>
                         <button data-theme="theme-aurora" class="theme-btn p-2 rounded-lg border-2 border-transparent text-center">
                            <div class="h-10 rounded-md mb-2" style="background-image: linear-gradient(45deg, #0d1117, #58a6ff);"></div>
                            <span class="text-xs text-secondary">Aurora</span>
                        </button>
                     </div>
                </div>
                <div class="bg-primary p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">Bildirimler</h2>
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-medium text-primary">Ödeme Hatırlatıcıları</p>
                            <p class="text-sm text-secondary mt-1">Son ödeme tarihlerinden 2 gün önce bildirim alın.</p>
                        </div>
                        <button id="notifications-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Bildirimlere İzin Ver
                        </button>
                    </div>
                </div>
                <div class="bg-primary p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">Gizlilik</h2>
                    <div class="flex items-center justify-between">
                        <div>
                            <label for="privacy-mode-toggle" class="font-medium text-primary">Gizlilik Modu</label>
                            <p class="text-sm text-secondary mt-1">Uygulamadaki tüm finansal tutarları gizler.</p>
                        </div>
                        <label for="privacy-mode-toggle" class="relative inline-flex items-center cursor-pointer"><input type="checkbox" value="" id="privacy-mode-toggle" class="sr-only peer"><div class="w-11 h-6 bg-tertiary rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-800 peer-checked:bg-accent-color peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div></label>
                    </div>
                </div>
                <div class="bg-primary p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-primary">Veri Yönetimi</h2>
                    <div class="space-y-4">
                         <button id="backup-data-btn" class="w-full bg-green-700 text-white py-2 px-4 rounded-md hover:bg-green-800 font-semibold transition-colors">Verileri Yedekle</button>
                         <div>
                            <label for="restore-input" class="w-full block text-center bg-blue-700 text-white py-2 px-4 rounded-md hover:bg-blue-800 font-semibold transition-colors cursor-pointer">Yedekten Geri Yükle</label>
                            <input type="file" id="restore-input" class="hidden" accept=".json">
                         </div>
                         <div class="border-t border-dynamic !mt-6 !mb-2"></div>
                         <button id="delete-all-data-btn" class="w-full bg-red-800 text-white py-2 px-4 rounded-md hover:bg-red-900 font-semibold transition-colors">TÜM VERİLERİ SİL</button>
                         <p class="text-xs text-secondary text-center">Bu işlem geri alınamaz. Cihazınızdaki tüm uygulama verileri kalıcı olarak silinir.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-primary border-t border-dynamic shadow-lg z-30">
        <nav class="flex justify-around items-center h-16 max-w-7xl mx-auto px-1">
            <button data-panel="home" class="bottom-nav-btn tab-active flex flex-col items-center justify-center text-secondary w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg><span class="text-xs mt-1">Ana Sayfa</span></button>
            <button data-panel="purchases" class="bottom-nav-btn flex flex-col items-center justify-center text-secondary w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg><span class="text-xs mt-1">Harcamalar</span></button>
            <button data-panel="debts" class="bottom-nav-btn flex flex-col items-center justify-center text-secondary w-full h-full rounded-lg m-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.5 2.5 0 00-1.134 0v-1.43z" />
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.5 4.5 0 00-1.879 3.407A1 1 0 008.12 10.5h3.76a1 1 0 00.999-1.093A4.5 4.5 0 0011 5.092V5zM10 13a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                <span class="text-xs mt-1">Borçlar</span>
            </button>
            <button data-panel="history" class="bottom-nav-btn flex flex-col items-center justify-center text-secondary w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span class="text-xs mt-1">Geçmiş</span></button>
            <button data-panel="subscriptions" class="bottom-nav-btn flex flex-col items-center justify-center text-secondary w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm5 2a1 1 0 00-1 1v8a1 1 0 102 0V6a1 1 0 00-1-1zm5-2a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1z" clip-rule="evenodd" /></svg><span class="text-xs mt-1">Abonelikler</span></button>
            <button data-panel="settings" class="bottom-nav-btn flex flex-col items-center justify-center text-secondary w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span class="text-xs mt-1">Ayarlar</span></button>
        </nav>
    </footer>

    <div id="tour-overlay"></div>
    <div id="tour-tooltip"></div>

    <div id="delete-confirm-modal-backdrop" class="modal-backdrop"></div>
    <div id="delete-confirm-modal" class="modal bg-primary p-6 rounded-lg shadow-xl max-w-sm w-full"></div>
    <div id="edit-purchase-modal-backdrop" class="modal-backdrop"></div>
    <div id="edit-purchase-modal" class="modal bg-primary p-6 rounded-2xl shadow-xl max-w-lg w-full"></div>
    <div id="edit-card-modal-backdrop" class="modal-backdrop"></div>
    <div id="edit-card-modal" class="modal bg-primary p-6 rounded-2xl shadow-xl max-w-lg w-full"></div>
    <div id="info-modal-backdrop" class="modal-backdrop"></div>
    <div id="info-modal" class="modal bg-primary p-6 rounded-lg shadow-xl max-w-sm w-full"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        dayjs.extend(window.dayjs_plugin_customParseFormat);
        dayjs.extend(window.dayjs_plugin_isSameOrBefore);
        dayjs.extend(window.dayjs_plugin_isSameOrAfter);
        dayjs.extend(window.dayjs_plugin_localizedFormat);
        dayjs.locale('tr');
        
        // --- STATE (DURUM) DEĞİŞKENLERİ ---
        let cards = [];
        let purchases = [];
        let debts = []; 
        let categories = []; 
        let userSettings = {};
        
        // Sayfalama state'leri
        let historyCurrentPage = 1;
        const HISTORY_ITEMS_PER_PAGE = 10;
        let purchasesCurrentPage = 1;
        const PURCHASES_ITEMS_PER_PAGE = 10;

        let categoryChartInstance = null;
        let itemToDelete = {};
        let confirmCallback = null;
        let selectedPlanMonth = null;

        // --- DOM ELEMENTLERİ ---
        const el = {
            appContainer: document.getElementById('app-container'),
            bottomNav: document.getElementById('bottom-nav'),
            welcomeMessage: document.getElementById('welcome-message'),
            infoModal: document.getElementById('info-modal'),
            infoModalBackdrop: document.getElementById('info-modal-backdrop'),
            deleteConfirmModal: document.getElementById('delete-confirm-modal'),
            deleteConfirmBackdrop: document.getElementById('delete-confirm-modal-backdrop'),
            editPurchaseModal: document.getElementById('edit-purchase-modal'),
            editPurchaseBackdrop: document.getElementById('edit-purchase-modal-backdrop'),
            editCardModal: document.getElementById('edit-card-modal'),
            editCardBackdrop: document.getElementById('edit-card-modal-backdrop'),
            cardList: document.getElementById('card-list'),
            purchaseList: document.getElementById('purchase-list-details'),
            purchaseListPagination: document.getElementById('purchase-list-pagination'),
            debtList: document.getElementById('debt-list'),
            subscriptionList: document.getElementById('subscription-list'),
            categoryList: document.getElementById('category-list'),
            paymentPlan: document.getElementById('payment-plan'),
            historyList: document.getElementById('history-list'),
            historyPagination: document.getElementById('history-pagination'),
            summaryPanel: document.getElementById('summary-panel'),
            categoryChartCanvas: document.getElementById('categoryChart'),
            purchaseDateInput: document.getElementById('purchase-date'),
            debtPaymentMonthInput: document.getElementById('debt-payment-month'),
            planMonthSelector: document.getElementById('plan-month-selector'),
            privacyModeToggle: document.getElementById('privacy-mode-toggle'),
            themeSelector: document.getElementById('theme-selector'),
            restoreInput: document.getElementById('restore-input'),
            notificationsBtn: document.getElementById('notifications-btn'),
            tourOverlay: document.getElementById('tour-overlay'),
            tourTooltip: document.getElementById('tour-tooltip')
        };

        // --- LOCAL STORAGE İŞLEMLERİ ---
        const STORAGE_KEYS = {
            CARDS: 'mak_taksit_cards',
            PURCHASES: 'mak_taksit_purchases',
            DEBTS: 'mak_taksit_debts',
            CATEGORIES: 'mak_taksit_categories',
            SETTINGS: 'mak_taksit_settings',
            NOTIFICATIONS_SHOWN: 'mak_taksit_notifications_shown',
            TOUR_COMPLETED: 'mak_taksit_tour_completed'
        };

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEYS.CARDS, JSON.stringify(cards));
                localStorage.setItem(STORAGE_KEYS.PURCHASES, JSON.stringify(purchases));
                localStorage.setItem(STORAGE_KEYS.DEBTS, JSON.stringify(debts));
                localStorage.setItem(STORAGE_KEYS.CATEGORIES, JSON.stringify(categories));
                localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(userSettings));
            } catch (error) {
                console.error("Veri kaydedilirken hata oluştu:", error);
                showInfoModal('Verileriniz kaydedilemedi. Cihazınızda yeterli alan olmayabilir.', 'Hata', 'error');
            }
        }

        function loadData() {
            try {
                cards = JSON.parse(localStorage.getItem(STORAGE_KEYS.CARDS)) || [];
                purchases = JSON.parse(localStorage.getItem(STORAGE_KEYS.PURCHASES)) || [];
                debts = JSON.parse(localStorage.getItem(STORAGE_KEYS.DEBTS)) || [];
                categories = JSON.parse(localStorage.getItem(STORAGE_KEYS.CATEGORIES)) || [];
                userSettings = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS)) || { theme: '', privacyMode: false, paidMonths: {} };

                if (categories.length === 0) {
                    createDefaultCategories();
                }
            } catch (error) {
                console.error("Veri yüklenirken hata oluştu:", error);
                cards = []; purchases = []; debts = []; categories = []; userSettings = {};
            }
        }

        function createDefaultCategories() {
            const defaultCategoryNames = ['Gıda', 'Fatura', 'Ulaşım', 'Giyim', 'Eğlence', 'Sağlık', 'Ev Eşyası', 'Dijital Servis', 'Manuel Borç', 'Diğer'];
            categories = defaultCategoryNames.map(name => ({ id: crypto.randomUUID(), name }));
            saveData();
        }

        // --- MODAL YÖNETİMİ ---
        function showInfoModal(message, title = 'Bilgi', type = 'info') { const colors = { info: 'indigo', success: 'green', error: 'red' }; const color = colors[type] || 'indigo'; el.infoModal.innerHTML = `<h3 class="text-lg font-medium text-primary">${title}</h3><p class="text-sm text-secondary mt-4">${message}</p><div class="mt-5 flex justify-end gap-3"><button id="info-modal-ok-btn" class="bg-${color}-600 text-white py-2 px-4 rounded-md">Tamam</button></div>`; el.infoModal.style.display = 'block'; el.infoModalBackdrop.style.display = 'block'; document.getElementById('info-modal-ok-btn').addEventListener('click', hideInfoModal); }
        function showConfirmModal(message, title = 'Onay', callback, confirmText = 'Onayla', cancelText = 'İptal') { el.infoModal.innerHTML = `<h3 class="text-lg font-medium text-primary">${title}</h3><p class="text-sm text-secondary mt-4">${message}</p><div class="mt-5 flex justify-end gap-3"><button id="info-modal-cancel-btn" class="bg-tertiary text-primary py-2 px-4 rounded-md">${cancelText}</button><button id="info-modal-confirm-btn" class="bg-green-600 text-white py-2 px-4 rounded-md">${confirmText}</button></div>`; el.infoModal.style.display = 'block'; el.infoModalBackdrop.style.display = 'block'; confirmCallback = callback; document.getElementById('info-modal-cancel-btn').addEventListener('click', hideInfoModal); document.getElementById('info-modal-confirm-btn').addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideInfoModal(); }); }
        function hideInfoModal() { el.infoModal.style.display = 'none'; el.infoModalBackdrop.style.display = 'none'; confirmCallback = null; }
        function openDeleteModal(id, type, name, element) { itemToDelete = { id, type, element }; let message = `"${name}" öğesini silmek istediğinizden emin misiniz?`; if(type === 'card') { message += ' Bu karta ait tüm harcamalar ve borçlar da silinecektir.'; } else if (type === 'category') { message += ' Bu kategoriye ait harcamalar "Diğer" kategorisine taşınacaktır.'; } const modalBody = el.deleteConfirmModal; modalBody.innerHTML = `<div class="flex items-center"><div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-900/50 sm:mx-0 sm:h-10 sm:w-10"><svg class="h-6 w-6 text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg></div><h3 class="ml-4 text-lg font-medium text-primary">Silme Onayı</h3></div><p class="text-sm text-secondary mt-4 ml-14">${message}</p><div class="mt-5 flex justify-end gap-3"><button id="cancel-delete-btn" class="bg-tertiary text-primary py-2 px-4 rounded-md">İptal</button><button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-4 rounded-md">Evet, Sil</button></div>`; el.deleteConfirmModal.style.display = 'block'; el.deleteConfirmBackdrop.style.display = 'block'; }
        function closeDeleteModal() { el.deleteConfirmModal.style.display = 'none'; el.deleteConfirmBackdrop.style.display = 'none'; }
        function openEditCardModal(id) {
            const card = cards.find(c => c.id === id);
            if (!card) return;
            el.editCardModal.innerHTML = `
            <h2 class="text-xl font-bold mb-4 text-primary">Kartı Düzenle</h2>
            <form id="edit-card-form" class="space-y-4">
                <input type="hidden" id="edit-card-id" value="${card.id}">
                <div><label for="edit-card-name" class="text-sm text-secondary">Kart Adı</label><input type="text" id="edit-card-name" value="${card.cardName}" class="mt-1 block w-full rounded-md p-2" required></div>
                <div><label for="edit-card-limit" class="text-sm text-secondary">Limit</label><input type="number" id="edit-card-limit" value="${card.cardLimit}" class="mt-1 block w-full rounded-md p-2" required></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label for="edit-statement-day" class="text-sm text-secondary">Kesim Günü</label><input type="number" id="edit-statement-day" value="${card.statementDay}" class="mt-1 block w-full rounded-md p-2" required></div>
                    <div><label for="edit-payment-day-offset" class="text-sm text-secondary">Ek Süre (Gün)</label><input type="number" id="edit-payment-day-offset" value="${card.paymentDayOffset || 10}" class="mt-1 block w-full rounded-md p-2" required></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-edit-card-btn" class="bg-tertiary px-4 py-2 rounded-md">İptal</button>
                    <button type="submit" class="text-white px-4 py-2 rounded-md accent-bg accent-bg-hover">Kaydet</button>
                </div>
            </form>`;
            el.editCardModal.style.display = 'block';
            el.editCardBackdrop.style.display = 'block';
        }
        function closeEditCardModal() { el.editCardModal.style.display = 'none'; el.editCardBackdrop.style.display = 'none'; }
        function openEditPurchaseModal(id) { const p = purchases.find(p => p.id === id); if (!p) return; el.editPurchaseModal.innerHTML = `<h2 class="text-xl font-bold mb-4 text-primary">Harcamayı Düzenle</h2><form id="edit-purchase-form" class="space-y-4"><input type="hidden" id="edit-purchase-id" value="${p.id}"><label class="text-sm text-secondary">Açıklama</label><input type="text" id="edit-purchase-name" value="${p.purchaseName}" class="mt-1 block w-full rounded-md p-2" required><label class="text-sm text-secondary">Kategori</label><select id="edit-purchase-category" class="mt-1 block w-full rounded-md p-2" required></select><label class="text-sm text-secondary">Tarih</label><input type="date" id="edit-purchase-date" value="${p.purchaseDate}" class="mt-1 block w-full rounded-md p-2" required><label class="text-sm text-secondary">Tutar</label><input type="number" id="edit-total-amount" step="0.01" value="${p.totalAmount}" class="mt-1 block w-full rounded-md p-2" required><label class="text-sm text-secondary">Taksit</label><input type="number" id="edit-installments-count" min="1" value="${p.installmentsCount}" class="mt-1 block w-full rounded-md p-2" required><label class="text-sm text-secondary">Kart</label><select id="edit-card-select" class="mt-1 block w-full rounded-md p-2" required></select><div class="flex items-center mt-4"><input id="edit-purchase-recurring" type="checkbox" ${p.isRecurring ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="edit-purchase-recurring" class="ml-2 block text-sm text-secondary">Aylık Tekrarla</label></div><div class="mt-6 flex justify-end space-x-3"><button type="button" id="cancel-edit-purchase-btn" class="bg-tertiary px-4 py-2 rounded-md">İptal</button><button type="submit" class="text-white px-4 py-2 rounded-md accent-bg accent-bg-hover">Kaydet</button></div></form>`; updateCardSelects(); populateCategorySelects(); document.querySelector('#edit-purchase-form #edit-card-select').value = p.cardId; document.querySelector('#edit-purchase-form #edit-purchase-category').value = p.category || 'Diğer'; el.editPurchaseModal.style.display = 'block'; el.editPurchaseBackdrop.style.display = 'block'; }
        function closeEditPurchaseModal() { el.editPurchaseModal.style.display = 'none'; el.editPurchaseBackdrop.style.display = 'none'; }
        
        // --- AYAR YÖNETİMİ & TEMA ---
        function updateSettings(settings) { 
            userSettings = { ...userSettings, ...settings };
            saveData();
            applySettings();
            refreshUI();
        }
        function formatCurrency(value) { if (userSettings.privacyMode) return '₺ --,--'; const numberValue = parseFloat(value); return isNaN(numberValue) ? '₺ 0.00' : `₺ ${numberValue.toFixed(2)}`; }
        function applyTheme(themeName) { document.body.className = 'bg-secondary text-primary'; if(themeName) document.body.classList.add(themeName); }
        function applySettings() { 
            applyTheme(userSettings.theme); 
            el.privacyModeToggle.checked = userSettings.privacyMode; 
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === userSettings.theme);
            });
        }
        
        // --- UI GÜNCELLEME FONKSİYONLARI ---
        function refreshUI() { 
            const paymentSchedule = calculatePaymentSchedule(); 
            if (selectedPlanMonth === null) { selectedPlanMonth = findFirstUnpaidMonth(paymentSchedule); } 
            populateMonthSelector(paymentSchedule, selectedPlanMonth); 
            renderSummary(paymentSchedule); 
            renderPaymentPlan(paymentSchedule, selectedPlanMonth); 
            renderHistory(paymentSchedule); 
            renderCategoryChart(); 
            renderCards(paymentSchedule); 
            renderPurchasesList(); 
            renderSubscriptions(); 
            renderDebts(); 
            renderCategoryList(); 
            updateCardSelects(); 
            populateCategorySelects(); 
        }
        function populateMonthSelector(schedule, currentSelection) { if (!el.planMonthSelector) return; el.planMonthSelector.innerHTML = ''; const allUnpaidMonths = Object.keys(schedule).filter(m => schedule[m].unpaidTotal > 0).sort(); allUnpaidMonths.forEach(monthKey => { el.planMonthSelector.add(new Option(dayjs(monthKey).format('MMMM YYYY'), monthKey)); }); el.planMonthSelector.add(new Option('Tüm Aylar', 'all')); if (el.planMonthSelector.querySelector(`[value="${currentSelection}"]`)) { el.planMonthSelector.value = currentSelection; } else { el.planMonthSelector.value = 'all'; } }
        function renderCards(schedule) {
            if (!el.cardList) return;
            el.cardList.innerHTML = cards.length === 0 ? `<div class="text-center py-8"><p class="mt-1 text-sm text-secondary">Başlamak için ilk kartınızı ekleyin!</p></div>` : '';
            const paidMonths = userSettings?.paidMonths || {};
            cards.forEach(card => {
                let currentOutstandingBalance = 0;
                for (const monthKey in schedule) {
                    if (schedule[monthKey].details[card.id]) {
                        const paymentKey = `${monthKey}_${card.id}`;
                        if (!paidMonths[paymentKey]) {
                            currentOutstandingBalance += schedule[monthKey].details[card.id].amount;
                        }
                    }
                }
                const remainingLimit = parseFloat(card.cardLimit) - currentOutstandingBalance;
                const usagePercentage = card.cardLimit > 0 ? (currentOutstandingBalance / card.cardLimit) * 100 : 0;
                const cardEl = document.createElement('div');
                cardEl.className = 'bg-tertiary p-4 rounded-lg border border-dynamic transition-all duration-300';
                cardEl.style.animation = 'fadeIn 0.5s';
                cardEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-lg text-primary">${card.cardName}</p>
                            <p class="text-xs text-secondary">Kesim: Ayın ${card.statementDay}. günü | Son Ödeme: Kesimden ${card.paymentDayOffset || 10} gün sonra</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button data-id="${card.id}" class="edit-card-btn text-sm bg-blue-900/50 text-blue-300 font-semibold px-3 py-1 rounded-md hover:bg-blue-800/50">Düzenle</button>
                            <button data-id="${card.id}" class="delete-card-btn text-sm bg-red-900/50 text-red-300 font-semibold px-3 py-1 rounded-md hover:bg-red-800/50">Sil</button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-secondary">Güncel Borç: <span class="font-medium text-primary">${formatCurrency(currentOutstandingBalance)}</span></span>
                            <span class="text-secondary">Limit: <span class="font-medium text-primary">${formatCurrency(card.cardLimit)}</span></span>
                        </div>
                        <div class="w-full bg-primary rounded-full h-2.5">
                            <div class="bg-accent-color h-2.5 rounded-full transition-all duration-500" style="width: ${Math.min(usagePercentage, 100)}%;"></div>
                        </div>
                        <p class="text-right text-xs mt-1 text-green-400">Kalan Limit: <span class="font-bold">${formatCurrency(remainingLimit)}</span></p>
                    </div>`;
                el.cardList.appendChild(cardEl);
            });
        }
        function renderPurchasesList() { 
            if (!el.purchaseList) return; 
            const searchTerm = document.getElementById('search-input').value.toLowerCase(); 
            const categoryFilter = document.getElementById('filter-category').value; 
            
            let sortedPurchases = [...purchases].sort((a, b) => dayjs(b.purchaseDate).valueOf() - dayjs(a.purchaseDate).valueOf());
            
            let filtered = sortedPurchases.filter(p => p.purchaseName.toLowerCase().includes(searchTerm) && (categoryFilter ? p.category === categoryFilter : true)); 
            
            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / PURCHASES_ITEMS_PER_PAGE);
            purchasesCurrentPage = Math.max(1, Math.min(purchasesCurrentPage, totalPages || 1));
            const startIndex = (purchasesCurrentPage - 1) * PURCHASES_ITEMS_PER_PAGE;
            const pageItems = filtered.slice(startIndex, startIndex + PURCHASES_ITEMS_PER_PAGE);

            el.purchaseList.innerHTML = pageItems.length === 0 ? '<p class="text-sm text-secondary text-center py-4">Filtreye uygun harcama yok.</p>' : ''; 
            pageItems.forEach(p => { 
                const card = cards.find(c => c.id === p.cardId); 
                const purchaseEl = document.createElement('div'); 
                purchaseEl.className = 'flex justify-between items-center bg-tertiary p-4 rounded-lg border border-dynamic'; 
                const recurringIcon = p.isRecurring ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-2 text-cyan-400" title="Tekrarlayan Harcama" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 12A8 8 0 1013 5.372" /></svg>` : ''; 
                purchaseEl.innerHTML = `<div><p class="font-semibold text-primary">${p.purchaseName}${recurringIcon}</p><p class="text-sm text-primary"><span class="font-medium accent-text">${p.category || 'Diğer'}</span> - ${formatCurrency(p.totalAmount / p.installmentsCount)} x ${p.installmentsCount} Taksit</p><p class="text-xs text-secondary">Tarih: ${dayjs(p.purchaseDate).format('DD.MM.YYYY')} | Kart: ${card ? card.cardName : 'Bilinmeyen'}</p></div><div class="flex items-center space-x-2"><button data-id="${p.id}" class="edit-purchase-btn text-sm bg-blue-900/50 text-blue-300 font-semibold px-3 py-1 rounded-md hover:bg-blue-800/50">Düzenle</button><button data-id="${p.id}" class="delete-purchase-btn text-sm bg-red-900/50 text-red-300 font-semibold px-3 py-1 rounded-md hover:bg-red-800/50">Sil</button></div>`; 
                el.purchaseList.appendChild(purchaseEl); 
            }); 
            renderPurchasesPagination(totalItems);
        }
        function renderPurchasesPagination(totalItems) {
            if (!el.purchaseListPagination) return;
            const totalPages = Math.ceil(totalItems / PURCHASES_ITEMS_PER_PAGE);
            if (totalPages <= 1) {
                el.purchaseListPagination.innerHTML = '';
                return;
            }
            let paginationContent = `
                <button id="purchase-prev-btn" class="pagination-btn px-4 py-2 text-sm font-medium bg-tertiary rounded-md disabled:opacity-50 disabled:cursor-not-allowed" ${purchasesCurrentPage === 1 ? 'disabled' : ''}>Geri</button>
                <span class="text-sm text-secondary">Sayfa ${purchasesCurrentPage} / ${totalPages}</span>
                <button id="purchase-next-btn" class="pagination-btn px-4 py-2 text-sm font-medium bg-tertiary rounded-md disabled:opacity-50 disabled:cursor-not-allowed" ${purchasesCurrentPage === totalPages ? 'disabled' : ''}>İleri</button>
            `;
            el.purchaseListPagination.innerHTML = paginationContent;
        }
        function renderSubscriptions() { if (!el.subscriptionList) return; const subscriptions = purchases.filter(p => p.isRecurring); if (subscriptions.length === 0) { el.subscriptionList.innerHTML = '<p class="text-sm text-secondary text-center py-4">Gösterilecek abonelik bulunmuyor.</p>'; return; } el.subscriptionList.innerHTML = ''; let monthlyTotal = 0; subscriptions.forEach(p => { const card = cards.find(c => c.id === p.cardId); const monthlyCost = parseFloat(p.totalAmount) / parseInt(p.installmentsCount); monthlyTotal += monthlyCost; const subEl = document.createElement('div'); subEl.className = 'flex justify-between items-center bg-tertiary p-4 rounded-lg border border-dynamic'; subEl.innerHTML = ` <div> <p class="font-semibold text-primary">${p.purchaseName}</p> <p class="text-sm text-primary">${p.category || 'Diğer'}</p> <p class="text-xs text-secondary">Kart: ${card ? card.cardName : 'Bilinmeyen'}</p> </div> <div class="text-right flex items-center space-x-3"> <div> <p class="font-semibold text-lg text-primary">${formatCurrency(monthlyCost)}</p> <p class="text-xs text-secondary">aylık</p> </div> <div class="flex flex-col space-y-2"> <button data-id="${p.id}" class="edit-subscription-btn text-blue-400 hover:text-blue-300" title="Düzenle"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button> <button data-id="${p.id}" class="cancel-subscription-btn text-red-400 hover:text-red-300" title="Aboneliği İptal Et"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button> </div> </div>`; el.subscriptionList.appendChild(subEl); }); const summaryEl = document.createElement('div'); summaryEl.className = 'mt-6 pt-4 border-t border-dynamic text-right'; summaryEl.innerHTML = `<p class="text-sm text-secondary">Aylık Toplam Abonelik Gideri</p><p class="font-bold text-2xl text-primary">${formatCurrency(monthlyTotal)}</p>`; el.subscriptionList.appendChild(summaryEl); }
        function renderDebts() { if (!el.debtList) return; const paidMonths = userSettings?.paidMonths || {}; const unpaidDebts = debts.filter(debt => { const paymentKey = `${debt.paymentMonth}_${debt.cardId}`; return !paidMonths[paymentKey]; }); if (unpaidDebts.length === 0) { el.debtList.innerHTML = '<p class="text-sm text-secondary text-center py-4">Ödenmemiş manuel borç bulunmuyor.</p>'; return; } el.debtList.innerHTML = ''; unpaidDebts.forEach(d => { const card = cards.find(c => c.id === d.cardId); const debtEl = document.createElement('div'); debtEl.className = 'flex justify-between items-center bg-tertiary p-4 rounded-lg border border-dynamic'; debtEl.innerHTML = ` <div> <p class="font-semibold text-primary">${d.debtName}</p> <p class="text-sm accent-text">${dayjs(d.paymentMonth).format('MMMM YYYY')} ayında ödenecek</p> <p class="text-xs text-secondary">Kart: ${card ? card.cardName : 'Bilinmeyen'}</p> </div> <div class="text-right"> <p class="font-semibold text-lg text-primary">${formatCurrency(d.amount)}</p> <button data-id="${d.id}" class="delete-debt-btn text-xs text-red-400 hover:text-red-300 mt-1">[Sil]</button> </div> `; el.debtList.appendChild(debtEl); }); }
        function renderCategoryList() { if (!el.categoryList) return; el.categoryList.innerHTML = ''; const protectedCategories = ['Manuel Borç', 'Diğer']; categories.forEach(cat => { const catEl = document.createElement('div'); catEl.className = 'flex justify-between items-center bg-tertiary p-3 rounded-md'; catEl.innerHTML = `<span class="text-primary">${cat.name}</span>`; if (!protectedCategories.includes(cat.name)) { catEl.innerHTML += ` <div class="flex items-center space-x-2"> <button data-id="${cat.id}" data-name="${cat.name}" class="delete-category-btn text-sm bg-red-900/50 text-red-300 font-semibold px-3 py-1 rounded-md hover:bg-red-800/50">Sil</button> </div>`; } el.categoryList.appendChild(catEl); }); }
        
        // --- HESAPLAMA FONKSİYONLARI ---
        function calculatePaymentSchedule() {
            const schedule = {};
            const paidMonths = userSettings?.paidMonths || {};
            
            purchases.forEach(p => {
                const card = cards.find(c => c.id === p.cardId);
                if (!card) return;
                const purchaseDate = dayjs(p.purchaseDate);
                const statementDay = parseInt(card.statementDay);
                const paymentOffset = parseInt(card.paymentDayOffset) || 10;
                const installmentAmount = parseFloat(p.totalAmount) / parseInt(p.installmentsCount);

                let firstStatementDate = purchaseDate.date(statementDay);
                if (purchaseDate.date() > statementDay) {
                    firstStatementDate = firstStatementDate.add(1, 'month');
                }

                for (let i = 0; i < p.installmentsCount; i++) {
                    const currentStatementDate = firstStatementDate.add(i, 'month');
                    const dueDate = currentStatementDate.add(paymentOffset, 'days');
                    const paymentMonthKey = dueDate.format('YYYY-MM');

                    if (!schedule[paymentMonthKey]) schedule[paymentMonthKey] = { total: 0, unpaidTotal: 0, details: {} };
                    if (!schedule[paymentMonthKey].details[p.cardId]) {
                        schedule[paymentMonthKey].details[p.cardId] = { 
                            amount: 0, 
                            dueDate: dueDate.format('YYYY-MM-DD'),
                            items: []
                        };
                    }
                    
                    schedule[paymentMonthKey].details[p.cardId].amount += installmentAmount;
                    schedule[paymentMonthKey].details[p.cardId].items.push({
                        purchaseId: p.id,
                        name: p.purchaseName,
                        amount: installmentAmount,
                        currentInstallment: i + 1,
                        totalInstallments: p.installmentsCount,
                        category: p.category || 'Diğer'
                    });

                    schedule[paymentMonthKey].total += installmentAmount;

                    const paymentKey = `${paymentMonthKey}_${p.cardId}`;
                    if (!paidMonths[paymentKey]) {
                        schedule[paymentMonthKey].unpaidTotal += installmentAmount;
                    }
                }
            });

            debts.forEach(debt => {
                const card = cards.find(c => c.id === debt.cardId);
                if (!card) return;

                const paymentMonthKey = debt.paymentMonth;
                const debtAmount = parseFloat(debt.amount);
                const statementDay = parseInt(card.statementDay);
                const paymentOffset = parseInt(card.paymentDayOffset) || 10;
                const dueDate = dayjs(paymentMonthKey).date(statementDay).add(paymentOffset, 'days');

                if (!schedule[paymentMonthKey]) schedule[paymentMonthKey] = { total: 0, unpaidTotal: 0, details: {} };
                if (!schedule[paymentMonthKey].details[debt.cardId]) {
                     schedule[paymentMonthKey].details[debt.cardId] = { 
                        amount: 0, 
                        dueDate: dueDate.format('YYYY-MM-DD'),
                        items: []
                    };
                }

                schedule[paymentMonthKey].details[debt.cardId].amount += debtAmount;
                schedule[paymentMonthKey].details[debt.cardId].items.push({
                    purchaseId: debt.id,
                    name: debt.debtName,
                    amount: debtAmount,
                    currentInstallment: 1,
                    totalInstallments: 1,
                    category: 'Manuel Borç'
                });
                schedule[paymentMonthKey].total += debtAmount;

                const paymentKey = `${paymentMonthKey}_${debt.cardId}`;
                if (!paidMonths[paymentKey]) {
                    schedule[paymentMonthKey].unpaidTotal += debtAmount;
                }
            });

            return schedule;
        }

        function renderPaymentPlan(schedule, selectedMonthKey) { 
            if (!el.paymentPlan) return; 
            const monthsToRender = selectedMonthKey === 'all' ? Object.keys(schedule).filter(m => schedule[m].unpaidTotal > 0).sort() : (schedule[selectedMonthKey] ? [selectedMonthKey] : []); 
            let content = ''; 
            let hasAnyPayment = false; 
            monthsToRender.forEach((monthKey, index) => { 
                const monthData = schedule[monthKey]; 
                if (!monthData) return; 
                let monthCardsContent = ''; 
                let unpaidTotalForMonth = 0; 
                cards.forEach(card => { 
                    const paymentData = monthData.details[card.id]; 
                    if (paymentData && paymentData.amount > 0) { 
                        const paymentKey = `${monthKey}_${card.id}`; 
                        const isPaid = userSettings?.paidMonths?.[paymentKey]; 
                        if (isPaid) return; 
                        hasAnyPayment = true; 
                        unpaidTotalForMonth += paymentData.amount; 
                        const dueDate = dayjs(paymentData.dueDate); 
                        const lateClass = dayjs().isAfter(dueDate, 'day') ? 'border-red-500/50' : 'border-dynamic'; 
                        
                        let detailsHtml = '<ul class="text-sm space-y-2">';
                        paymentData.items.forEach(item => {
                            detailsHtml += `
                                <li class="flex justify-between items-center text-secondary">
                                    <span>${item.name} (${item.currentInstallment}/${item.totalInstallments})</span>
                                    <span class="font-medium text-primary">${formatCurrency(item.amount)}</span>
                                </li>`;
                        });
                        detailsHtml += '</ul>';

                        monthCardsContent += `
                        <div class="bg-tertiary rounded-lg border ${lateClass} overflow-hidden">
                            <div class="p-4 cursor-pointer plan-card-header" data-details-id="details-${paymentKey}">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-bold text-primary">${card.cardName}</p>
                                        <p class="text-xs text-secondary">Son Ödeme: ${dueDate.format('DD MMMM YYYY')}</p>
                                    </div>
                                    <p class="text-xl font-semibold text-primary">${formatCurrency(paymentData.amount)}</p>
                                </div>
                            </div>
                            <div id="details-${paymentKey}" class="plan-details px-4 border-t border-dynamic">${detailsHtml}</div>
                            <div class="p-4 border-t border-dynamic text-right">
                                <button data-key="${paymentKey}" class="pay-btn text-sm bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md w-full sm:w-auto">Ödendi Olarak İşaretle</button>
                            </div>
                        </div>`; 
                    } 
                }); 
                if (monthCardsContent) { 
                    if (selectedMonthKey === 'all') { 
                        content += ` <div class="${index > 0 ? 'mt-8' : ''}"> <h3 class="text-lg font-semibold text-primary border-b border-dynamic pb-2 mb-4">${dayjs(monthKey).format('MMMM YYYY')}</h3> <div class="space-y-4">${monthCardsContent}</div> </div>`; 
                    } else { 
                        content += ` <div class="space-y-4">${monthCardsContent}</div> <div class="mt-6 pt-4 border-t border-dynamic text-right"> <p class="text-sm text-secondary">${dayjs(monthKey).format('MMMM YYYY')} Kalan Toplam Ödeme</p> <p class="font-bold text-2xl text-red-500">${formatCurrency(unpaidTotalForMonth)}</p> </div>`; 
                    } 
                } 
            }); 
            if (!hasAnyPayment) { 
                el.paymentPlan.innerHTML = `<p class="text-center text-secondary py-8">Görüntülenecek ödeme bulunmuyor.</p>`; 
            } else { 
                el.paymentPlan.innerHTML = content; 
            } 
        }
        function renderHistory(schedule) { if (!el.historyList || !el.historyPagination) return; const paidMonths = userSettings?.paidMonths || {}; const allPaidItems = Object.keys(paidMonths).map(paymentKey => { const paidInfo = paidMonths[paymentKey]; if (typeof paidInfo !== 'object' || !paidInfo.paidDate) return null; const [monthKey, cardId] = paymentKey.split('_'); const card = cards.find(c => c.id === cardId); const amount = schedule[monthKey]?.details[cardId]?.amount || 0; if (!card || amount <= 0) return null; return { cardName: card.cardName, amount: amount, key: paymentKey, paidDate: paidInfo.paidDate, month: monthKey }; }).filter(item => item !== null).sort((a, b) => dayjs(b.paidDate).valueOf() - dayjs(a.paidDate).valueOf()); if (allPaidItems.length === 0) { el.historyList.innerHTML = '<p class="text-center text-secondary py-8">Henüz ödenmiş harcama yok.</p>'; el.historyPagination.innerHTML = ''; return; } const totalPages = Math.ceil(allPaidItems.length / HISTORY_ITEMS_PER_PAGE); historyCurrentPage = Math.max(1, Math.min(historyCurrentPage, totalPages)); const startIndex = (historyCurrentPage - 1) * HISTORY_ITEMS_PER_PAGE; const pageItems = allPaidItems.slice(startIndex, startIndex + HISTORY_ITEMS_PER_PAGE); let content = '<div class="space-y-4">'; pageItems.forEach(item => { content += ` <div class="bg-tertiary p-4 rounded-lg"> <div class="flex justify-between items-start"> <div> <p class="font-semibold text-primary">${item.cardName}</p> <p class="text-sm accent-text">${dayjs(item.month).format('MMMM YYYY')} Ekstresi</p> </div> <span class="font-semibold text-xl text-green-400">${formatCurrency(item.amount)}</span> </div> <div class="flex justify-between items-center mt-3 pt-3 border-t border-dynamic"> <p class="text-xs text-secondary">Ödendi: ${dayjs(item.paidDate).format('DD MMMM YYYY, dddd')}</p> <button data-key="${item.key}" class="undo-pay-btn text-xs text-secondary hover:text-primary">[Geri Al]</button> </div> </div>`; }); content += '</div>'; el.historyList.innerHTML = content; let paginationContent = ''; if (totalPages > 1) paginationContent = ` <button id="history-prev-btn" class="px-4 py-2 text-sm font-medium bg-tertiary rounded-md disabled:opacity-50 disabled:cursor-not-allowed" ${historyCurrentPage === 1 ? 'disabled' : ''}>Geri</button> <span class="text-sm text-secondary">Sayfa ${historyCurrentPage} / ${totalPages}</span> <button id="history-next-btn" class="px-4 py-2 text-sm font-medium bg-tertiary rounded-md disabled:opacity-50 disabled:cursor-not-allowed" ${historyCurrentPage === totalPages ? 'disabled' : ''}>İleri</button> `; el.historyPagination.innerHTML = paginationContent; }
        
        function renderCategoryChart() {
            if (!el.categoryChartCanvas) return;
            const ctx = el.categoryChartCanvas.getContext('2d');
            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }

            const chartTextColor = getComputedStyle(document.body).getPropertyValue('--text-primary');
            const chartBorderColor = getComputedStyle(document.body).getPropertyValue('--bg-primary');

            if (userSettings.privacyMode) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = "16px Inter";
                ctx.fillStyle = chartTextColor;
                ctx.textAlign = "center";
                ctx.fillText("Veriler Gizlilik Modu'nda gizlenmiştir.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const schedule = calculatePaymentSchedule();
            const paidMonths = userSettings?.paidMonths || {};
            const categoryTotals = {};

            Object.keys(schedule).forEach(monthKey => {
                const monthDetails = schedule[monthKey].details;
                Object.keys(monthDetails).forEach(cardId => {
                    const paymentKey = `${monthKey}_${cardId}`;
                    if (!paidMonths[paymentKey]) { // Sadece ödenmemiş ekstreleri dahil et
                        const cardData = monthDetails[cardId];
                        cardData.items.forEach(item => {
                            const categoryName = item.category || 'Diğer';
                            categoryTotals[categoryName] = (categoryTotals[categoryName] || 0) + item.amount;
                        });
                    }
                });
            });

            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);

            if (labels.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = "16px Inter";
                ctx.fillStyle = chartTextColor;
                ctx.textAlign = "center";
                ctx.fillText("Kalan borç bulunmuyor.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            categoryChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels,
                    datasets: [{
                        label: 'Kalan Borç Dağılımı',
                        data,
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#ec4899', '#64748b'],
                        borderColor: chartBorderColor,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: chartTextColor
                            }
                        }
                    }
                }
            });
        }

        function renderSummary(schedule) { if (!el.summaryPanel) return; let thisMonthPayment = 0; let totalDebt = 0; let nextDueDateInfo = null; let nextStatementDateInfo = null; const today = dayjs(); const paidMonths = userSettings?.paidMonths || {}; Object.entries(schedule).forEach(([monthKey, monthData]) => { Object.entries(monthData.details).forEach(([cardId, cardData]) => { const paymentKey = `${monthKey}_${cardId}`; if (!paidMonths[paymentKey]) { const amount = cardData.amount; const dueDate = dayjs(cardData.dueDate); totalDebt += amount; if (dueDate.format('YYYY-MM') === today.format('YYYY-MM')) thisMonthPayment += amount; if (dueDate.isAfter(today) && (!nextDueDateInfo || dueDate.isBefore(nextDueDateInfo.date))) { const card = cards.find(c => c.id === cardId); nextDueDateInfo = { date: dueDate, cardName: card?.cardName || 'Bilinmeyen Kart' }; } } }); }); cards.forEach(card => { const statementDay = parseInt(card.statementDay); if (isNaN(statementDay)) return; let nextStatementDate = today.date(statementDay); if (today.isSameOrAfter(nextStatementDate, 'day')) nextStatementDate = nextStatementDate.add(1, 'month'); if (!nextStatementDateInfo || nextStatementDate.isBefore(nextStatementDateInfo.date)) nextStatementDateInfo = { date: nextStatementDate, cardName: card.cardName }; }); el.summaryPanel.innerHTML = `<h2 class="text-xl font-bold mb-4">Durum Özeti</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"><div><p class="text-sm opacity-80">Bu Ay Kalan Ödeme</p><p class="text-2xl font-bold">${formatCurrency(thisMonthPayment)}</p></div><div><p class="text-sm opacity-80">En Yakın Son Ödeme</p><p class="text-2xl font-bold">${nextDueDateInfo ? nextDueDateInfo.date.format('DD.MM.YYYY') : '-'}</p><p class="text-xs opacity-80">${nextDueDateInfo ? nextDueDateInfo.cardName : ''}</p></div><div><p class="text-sm opacity-80">En Yakın Kesim Tarihi</p><p class="text-2xl font-bold">${nextStatementDateInfo ? nextStatementDateInfo.date.format('DD.MM.YYYY') : '-'}</p><p class="text-xs opacity-80">${nextStatementDateInfo ? nextStatementDateInfo.cardName : ''}</p></div><div><p class="text-sm opacity-80">Toplam Kalan Borç</p><p class="text-2xl font-bold">${formatCurrency(totalDebt)}</p></div></div>`; }
        function findFirstUnpaidMonth(schedule) { const today = dayjs(); const currentMonthKey = today.format('YYYY-MM'); const sortedMonths = Object.keys(schedule).sort(); for (const monthKey of sortedMonths) if (monthKey >= currentMonthKey && schedule[monthKey].unpaidTotal > 0) return monthKey; const unpaidMonths = sortedMonths.filter(m => schedule[m].unpaidTotal > 0); if(unpaidMonths.length > 0) return unpaidMonths[0]; return 'all'; }
        function getFirstPaymentMonthKey(purchase) { const card = cards.find(c => c.id === purchase.cardId); if (!card) return dayjs().format('YYYY-MM'); const purchaseDate = dayjs(purchase.purchaseDate); const statementDay = parseInt(card.statementDay); const paymentOffset = parseInt(card.paymentDayOffset) || 10; let firstStatementDate = purchaseDate.date(statementDay); if (purchaseDate.date() > statementDay) firstStatementDate = firstStatementDate.add(1, 'month'); return firstStatementDate.add(paymentOffset, 'days').format('YYYY-MM'); }
        function updateCardSelects() { document.querySelectorAll('#card-select, #edit-card-select, #debt-card-select').forEach(select => { if (!select) return; const currentVal = select.value; select.innerHTML = `<option value="">Kart Seçin</option>`; cards.forEach(card => select.add(new Option(card.cardName, card.id))); if (cards.find(c => c.id === currentVal)) select.value = currentVal; }); }
        function populateCategorySelects() { document.querySelectorAll('#purchase-category, #edit-purchase-category, #filter-category').forEach(select => { if (!select) return; const currentVal = select.value; const isFilter = select.id === 'filter-category'; let tempCats = [...categories.map(c => c.name)]; if(isFilter) tempCats = tempCats.filter(c => c !== 'Manuel Borç'); select.innerHTML = `<option value="">${isFilter ? 'Tüm Kategoriler' : 'Kategori Seçin'}</option>`; tempCats.sort().forEach(cat => select.add(new Option(cat, cat))); if(tempCats.includes(currentVal)) select.value = currentVal; }); }

        // --- BİLDİRİM FONKSİYONLARI ---
        function updateNotificationButton() {
            if (!('Notification' in window)) {
                el.notificationsBtn.textContent = 'Desteklenmiyor';
                el.notificationsBtn.disabled = true;
                return;
            }
            switch (Notification.permission) {
                case 'granted':
                    el.notificationsBtn.textContent = 'İzin Verildi';
                    el.notificationsBtn.disabled = true;
                    break;
                case 'denied':
                    el.notificationsBtn.textContent = 'İzin Reddedildi';
                    el.notificationsBtn.disabled = true;
                    break;
                default:
                    el.notificationsBtn.textContent = 'Bildirimlere İzin Ver';
                    el.notificationsBtn.disabled = false;
                    break;
            }
        }

        async function requestNotificationPermission() {
            if (!('Notification' in window)) return;
            const permission = await Notification.requestPermission();
            updateNotificationButton();
            if (permission === 'granted') {
                showInfoModal('Bildirimlere başarıyla izin verildi!', 'Başarılı', 'success');
                checkAndShowNotifications();
            }
        }

        function checkAndShowNotifications() {
            if (Notification.permission !== 'granted') return;

            const schedule = calculatePaymentSchedule();
            const today = dayjs();
            const twoDaysFromNow = today.add(2, 'day');
            let notificationsShown = JSON.parse(localStorage.getItem(STORAGE_KEYS.NOTIFICATIONS_SHOWN)) || {};

            Object.entries(schedule).forEach(([monthKey, monthData]) => {
                Object.entries(monthData.details).forEach(([cardId, cardData]) => {
                    const paymentKey = `${monthKey}_${cardId}`;
                    const dueDate = dayjs(cardData.dueDate);

                    if (dueDate.isSame(twoDaysFromNow, 'day') && !notificationsShown[paymentKey]) {
                        const card = cards.find(c => c.id === cardId);
                        const title = 'Ödeme Hatırlatıcısı';
                        const options = {
                            body: `${card.cardName} kartınızın ${formatCurrency(cardData.amount)} tutarındaki ekstresi için son ödeme tarihi yaklaşıyor! Son Tarih: ${dueDate.format('DD MMMM')}`,
                            icon: 'https://placehold.co/192x192/a78bfa/ffffff?text=MAK'
                        };

                        new Notification(title, options);
                        notificationsShown[paymentKey] = true;
                    }
                });
            });
            
            Object.keys(notificationsShown).forEach(key => {
                const [monthKey] = key.split('_');
                if (dayjs().isAfter(dayjs(monthKey).add(1, 'month'))) {
                    delete notificationsShown[key];
                }
            });

            localStorage.setItem(STORAGE_KEYS.NOTIFICATIONS_SHOWN, JSON.stringify(notificationsShown));
        }

        // --- TANITIM TURU FONKSİYONLARI ---
        let currentTourStep = 0;
        const tourSteps = [
            {
                title: 'Hoş Geldiniz!',
                intro: 'MAK Taksit Asistanı\'na hoş geldiniz. Bu kısa tur ile uygulamanın temel özelliklerini hızlıca öğrenelim.'
            },
            {
                element: '#summary-panel',
                title: 'Özet Paneli',
                intro: 'Bu alanda aylık ödemeleriniz, toplam borcunuz ve yaklaşan ödeme tarihleriniz gibi önemli bilgileri bir bakışta görebilirsiniz.'
            },
            {
                element: '[data-panel="settings"]',
                title: 'Ayarlar Menüsü',
                intro: 'Uygulamayı kullanmaya başlamadan önce, Ayarlar menüsünden en az bir kredi kartı eklemeniz gerekmektedir. Hadi oraya gidelim.'
            },
            {
                element: '#add-card-form',
                title: 'Kart Ekleme',
                intro: 'Bu formdan kartınızın adını, limitini ve ekstre kesim günü gibi bilgilerini girerek kaydedebilirsiniz.'
            },
            {
                element: '[data-panel="purchases"]',
                title: 'Harcama Ekleme',
                intro: 'Kartınızı ekledikten sonra, bu sekmeden yaptığınız taksitli veya tek çekim harcamaları kolayca ekleyebilirsiniz.'
            },
            {
                element: '#bottom-nav',
                title: 'Navigasyon',
                intro: 'Uygulamanın tüm bölümlerine bu alt menüden hızlıca ulaşabilirsiniz. Artık hazırsınız!'
            }
        ];

        function startTour() {
            el.tourOverlay.classList.add('active');
            currentTourStep = 0;
            showTourStep(currentTourStep);
        }

        function endTour() {
            el.tourOverlay.classList.remove('active');
            el.tourTooltip.classList.remove('active');
            const highlighted = document.querySelector('.tour-highlight');
            if (highlighted) {
                highlighted.classList.remove('tour-highlight');
            }
            localStorage.setItem(STORAGE_KEYS.TOUR_COMPLETED, 'true');
        }

        function showTourStep(stepIndex) {
            const step = tourSteps[stepIndex];
            
            const highlighted = document.querySelector('.tour-highlight');
            if (highlighted) {
                highlighted.classList.remove('tour-highlight');
            }

            if (step.element && (step.element === '#add-card-form' || step.element === '[data-panel="settings"]')) {
                 document.querySelector('[data-panel="home"]').classList.remove('tab-active');
                 document.querySelector('[data-panel="settings"]').classList.add('tab-active');
                 document.querySelector('#panel-home').classList.remove('active');
                 document.querySelector('#panel-settings').classList.add('active');
            } else if (step.element && step.element === '[data-panel="purchases"]') {
                 document.querySelector('[data-panel="settings"]').classList.remove('tab-active');
                 document.querySelector('[data-panel="purchases"]').classList.add('tab-active');
                 document.querySelector('#panel-settings').classList.remove('active');
                 document.querySelector('#panel-purchases').classList.add('active');
            }


            let targetElement = step.element ? document.querySelector(step.element) : null;
            
            el.tourTooltip.innerHTML = `
                <h3 class="font-bold text-lg mb-2 accent-text">${step.title}</h3>
                <p class="text-sm text-secondary">${step.intro}</p>
                <div class="flex justify-between items-center mt-6">
                    <button id="tour-skip" class="text-xs text-secondary hover:text-primary">Turu Atla</button>
                    <div>
                        <button id="tour-prev" class="px-3 py-1 text-sm bg-tertiary rounded-md ${stepIndex === 0 ? 'hidden' : ''}">Geri</button>
                        <button id="tour-next" class="px-4 py-2 text-sm text-white rounded-md accent-bg accent-bg-hover">${stepIndex === tourSteps.length - 1 ? 'Bitir' : 'İleri'}</button>
                    </div>
                </div>
            `;
            
            el.tourTooltip.style.visibility = 'hidden';
            el.tourTooltip.classList.add('active');
            
            // Timeout to allow the browser to calculate the new dimensions after content change
            setTimeout(() => {
                if (targetElement) {
                    targetElement.classList.add('tour-highlight');
                    const rect = targetElement.getBoundingClientRect();
                    const tooltipRect = el.tourTooltip.getBoundingClientRect();

                    let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                    left = Math.max(10, Math.min(left, window.innerWidth - tooltipRect.width - 10));

                    let top;
                    if (rect.bottom + tooltipRect.height + 15 < window.innerHeight) {
                        top = rect.bottom + 15;
                    } else {
                        top = rect.top - tooltipRect.height - 15;
                    }

                    el.tourTooltip.style.top = `${top}px`;
                    el.tourTooltip.style.left = `${left}px`;
                    el.tourTooltip.style.transform = 'translate(0, 0)';

                } else {
                     el.tourTooltip.style.top = '50%';
                     el.tourTooltip.style.left = '50%';
                     el.tourTooltip.style.transform = 'translate(-50%, -50%)';
                }
                
                el.tourTooltip.style.visibility = 'visible';

                document.getElementById('tour-skip').addEventListener('click', endTour);
                document.getElementById('tour-next').addEventListener('click', () => {
                    if (currentTourStep < tourSteps.length - 1) {
                        currentTourStep++;
                        showTourStep(currentTourStep);
                    } else {
                        endTour();
                    }
                });
                if (document.getElementById('tour-prev')) {
                    document.getElementById('tour-prev').addEventListener('click', () => {
                        if (currentTourStep > 0) {
                            currentTourStep--;
                            showTourStep(currentTourStep);
                        }
                    });
                }
            }, 50);
        }


        // --- OLAY İŞLEYİCİLER (EVENT HANDLERS) ---
        function handleFormSubmits(e) { 
            e.preventDefault(); 
            const form = e.target; 
            if (form.id === 'add-purchase-form') { 
                const newPurchase = { 
                    id: crypto.randomUUID(),
                    purchaseName: form.elements['purchase-name'].value, 
                    purchaseDate: form.elements['purchase-date'].value, 
                    totalAmount: parseFloat(form.elements['total-amount'].value), 
                    installmentsCount: parseInt(form.elements['installments-count'].value), 
                    cardId: form.elements['card-select'].value, 
                    category: form.elements['purchase-category'].value, 
                    isRecurring: form.elements['purchase-recurring'].checked, 
                    createdAt: new Date().toISOString() 
                }; 
                purchases.push(newPurchase);
                selectedPlanMonth = getFirstPaymentMonthKey(newPurchase); 
                form.reset(); 
                el.purchaseDateInput.valueAsDate = new Date(); 
                showInfoModal('Harcama başarıyla eklendi.', 'Başarılı', 'success'); 
            } else if (form.id === 'add-debt-form') { 
                const newDebt = { 
                    id: crypto.randomUUID(),
                    debtName: form.elements['debt-name'].value, 
                    amount: parseFloat(form.elements['debt-amount'].value), 
                    cardId: form.elements['debt-card-select'].value, 
                    paymentMonth: form.elements['debt-payment-month'].value, 
                    createdAt: new Date().toISOString()
                }; 
                debts.push(newDebt);
                form.reset(); 
                el.debtPaymentMonthInput.value = dayjs().format('YYYY-MM'); 
                showInfoModal('Borç başarıyla eklendi.', 'Başarılı', 'success'); 
            } else if (form.id === 'add-card-form') { 
                const newCard = { 
                    id: crypto.randomUUID(),
                    cardName: form.elements['card-name'].value, 
                    statementDay: parseInt(form.elements['statement-day'].value), 
                    cardLimit: parseFloat(form.elements['card-limit'].value), 
                    paymentDayOffset: parseInt(form.elements['payment-day-offset'].value), 
                    createdAt: new Date().toISOString()
                }; 
                cards.push(newCard);
                form.reset(); 
            } else if (form.id === 'add-category-form') { 
                const categoryNameInput = form.elements['category-name-input']; 
                const newCategoryName = categoryNameInput.value.trim(); 
                if(newCategoryName && !categories.some(c => c.name.toLowerCase() === newCategoryName.toLowerCase())) { 
                    categories.push({ id: crypto.randomUUID(), name: newCategoryName });
                    categoryNameInput.value = ''; 
                } else { 
                    showInfoModal('Bu kategori zaten mevcut veya isim geçersiz.', 'Uyarı', 'error'); 
                } 
            } else if (form.id === 'edit-card-form') { 
                const cardId = form.elements['edit-card-id'].value; 
                const cardIndex = cards.findIndex(c => c.id === cardId);
                if (cardIndex > -1) {
                    cards[cardIndex] = {
                        ...cards[cardIndex],
                        cardName: form.elements['edit-card-name'].value, 
                        statementDay: parseInt(form.elements['edit-statement-day'].value), 
                        cardLimit: parseFloat(form.elements['edit-card-limit'].value), 
                        paymentDayOffset: parseInt(form.elements['edit-payment-day-offset'].value) 
                    };
                }
                closeEditCardModal(); 
            } else if (form.id === 'edit-purchase-form') { 
                const purchaseId = form.elements['edit-purchase-id'].value; 
                const purchaseIndex = purchases.findIndex(p => p.id === purchaseId);
                if (purchaseIndex > -1) {
                    purchases[purchaseIndex] = {
                        ...purchases[purchaseIndex],
                        purchaseName: form.elements['edit-purchase-name'].value, 
                        purchaseDate: form.elements['edit-purchase-date'].value, 
                        totalAmount: parseFloat(form.elements['edit-total-amount'].value), 
                        installmentsCount: parseInt(form.elements['edit-installments-count'].value), 
                        cardId: form.elements['edit-card-select'].value, 
                        category: form.elements['edit-purchase-category'].value, 
                        isRecurring: form.elements['edit-purchase-recurring'].checked 
                    };
                }
                closeEditPurchaseModal(); 
            } 
            saveData();
            refreshUI();
        }
        function bindEventListeners() { 
            document.body.addEventListener('submit', handleFormSubmits); 
            document.body.addEventListener('input', e => { if (e.target.id === 'search-input') { purchasesCurrentPage = 1; renderPurchasesList(); } }); 
            document.body.addEventListener('change', e => { 
                if (e.target.id === 'filter-category') { purchasesCurrentPage = 1; renderPurchasesList(); } 
                if (e.target.id === 'privacy-mode-toggle') { updateSettings({ privacyMode: e.target.checked }); } 
                if (e.target.id === 'plan-month-selector') { selectedPlanMonth = e.target.value; renderPaymentPlan(calculatePaymentSchedule(), selectedPlanMonth); }
                if (e.target.id === 'restore-input') { handleRestoreData(e.target.files[0]); }
            }); 
            document.body.addEventListener('click', handleBodyClicks); 
        }
        function handleBodyClicks(e) {
            const btn = e.target.closest('button');
            if (btn) {
                const id = btn.dataset.id, key = btn.dataset.key;
                
                if (btn.matches('.pay-btn')) { const newPaidStatus = { ...userSettings.paidMonths, [key]: { paidDate: dayjs().toISOString() } }; updateSettings({ paidMonths: newPaidStatus }); selectedPlanMonth = findFirstUnpaidMonth(calculatePaymentSchedule()); return; }
                if (btn.matches('.undo-pay-btn')) { const newPaidStatus = { ...userSettings.paidMonths }; delete newPaidStatus[key]; updateSettings({ paidMonths: newPaidStatus }); selectedPlanMonth = key.split('_')[0]; return; }
                if (btn.id === 'history-prev-btn') { if(historyCurrentPage > 1) { historyCurrentPage--; renderHistory(calculatePaymentSchedule()); } return; }
                if (btn.id === 'history-next-btn') { historyCurrentPage++; renderHistory(calculatePaymentSchedule()); return; }
                if (btn.id === 'purchase-prev-btn') { if(purchasesCurrentPage > 1) { purchasesCurrentPage--; renderPurchasesList(); } return; }
                if (btn.id === 'purchase-next-btn') { purchasesCurrentPage++; renderPurchasesList(); return; }
                if (btn.closest('#bottom-nav')) { document.querySelectorAll('.bottom-nav-btn').forEach(b => b.classList.remove('tab-active')); btn.classList.add('tab-active'); document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); document.getElementById(`panel-${btn.dataset.panel}`).classList.add('active'); return; } 
                if (btn.closest('#theme-selector') && btn.dataset.theme !== undefined) { updateSettings({ theme: btn.dataset.theme }); return; } 
                if (btn.id === 'delete-all-data-btn') { handleDeleteAllData(); return; } 
                if (btn.id === 'backup-data-btn') { handleBackupData(); return; }
                if (btn.id === 'notifications-btn') { requestNotificationPermission(); return; }
                if (btn.id === 'cancel-delete-btn') closeDeleteModal(); 
                if (btn.id === 'confirm-delete-btn') { handleConfirmDelete(); return; } 
                if (btn.matches('.delete-card-btn')) { const card = cards.find(c => c.id === id); openDeleteModal(id, 'card', card.cardName, btn.closest('.bg-tertiary')); return; } 
                if (btn.matches('.delete-purchase-btn')) { const purchase = purchases.find(p => p.id === id); openDeleteModal(id, 'purchase', purchase.purchaseName, btn.closest('.flex')); return; } 
                if (btn.matches('.delete-debt-btn')) { const debt = debts.find(d => d.id === id); openDeleteModal(id, 'debt', debt.debtName, btn.closest('.flex')); return; }
                if (btn.matches('.delete-category-btn')) { openDeleteModal(id, 'category', btn.dataset.name, btn.closest('.flex')); return; }
                if (btn.matches('.edit-card-btn')) { openEditCardModal(id); return; } 
                if (btn.matches('.edit-purchase-btn') || btn.matches('.edit-subscription-btn')) { openEditPurchaseModal(id); return; } 
                if (btn.matches('.cancel-subscription-btn')) { handleCancelSubscription(id); return; }
                if (btn.id === 'cancel-edit-card-btn') closeEditCardModal();
                if (btn.id === 'cancel-edit-purchase-btn') closeEditPurchaseModal();
            }

            const header = e.target.closest('.plan-card-header');
            if (header) {
                const detailsId = header.dataset.detailsId;
                const detailsEl = document.getElementById(detailsId);
                if (detailsEl) {
                    detailsEl.classList.toggle('open');
                }
            }
        }

        function handleBackupData() {
            const dataToBackup = {
                cards,
                purchases,
                debts,
                categories,
                userSettings
            };
            const dataStr = JSON.stringify(dataToBackup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mak-taksit-asistani-yedek-${dayjs().format('YYYY-MM-DD')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showInfoModal('Verileriniz başarıyla yedeklendi.', 'Başarılı', 'success');
        }

        function handleRestoreData(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.cards && data.purchases && data.userSettings) {
                        showConfirmModal('Yedek dosyasını geri yüklemek istediğinizden emin misiniz? Mevcut tüm verileriniz bu yedekle değiştirilecektir.', 'Geri Yükle Onayı', () => {
                            cards = data.cards || [];
                            purchases = data.purchases || [];
                            debts = data.debts || [];
                            categories = data.categories || [];
                            userSettings = data.userSettings || { theme: '', privacyMode: false, paidMonths: {} };
                            saveData();
                            refreshUI();
                            showInfoModal('Veriler başarıyla geri yüklendi.', 'Başarılı', 'success');
                        }, 'Evet, Geri Yükle');
                    } else {
                        showInfoModal('Geçersiz yedek dosyası.', 'Hata', 'error');
                    }
                } catch (error) {
                    showInfoModal('Yedek dosyası okunurken bir hata oluştu.', 'Hata', 'error');
                    console.error("Yedek geri yükleme hatası:", error);
                } finally {
                    el.restoreInput.value = '';
                }
            };
            reader.readAsText(file);
        }

        function handleDeleteAllData() { showConfirmModal('<b>Bu işlem KESİNLİKLE GERİ ALINAMAZ.</b><br><br>Tüm kart, harcama, borç ve kategori verileriniz kalıcı olarak silinecektir. Devam etmek istediğinizden emin misiniz?', 'Tüm Verileri Sil', () => { 
            Object.values(STORAGE_KEYS).forEach(key => localStorage.removeItem(key));
            cards = []; purchases = []; debts = []; categories = []; userSettings = {};
            loadData();
            refreshUI();
            showInfoModal('Tüm verileriniz başarıyla silindi.', 'Başarılı', 'success'); 
        }, 'EVET, TÜMÜNÜ SİL'); }
        function handleConfirmDelete() { 
            if(itemToDelete.element) itemToDelete.element.classList.add('item-fade-out'); 
            setTimeout(() => { 
                if (itemToDelete.type === 'card') { 
                    purchases = purchases.filter(p => p.cardId !== itemToDelete.id);
                    debts = debts.filter(d => d.cardId !== itemToDelete.id);
                    cards = cards.filter(c => c.id !== itemToDelete.id);
                } else if(itemToDelete.type === 'purchase') { 
                    purchases = purchases.filter(p => p.id !== itemToDelete.id);
                } else if(itemToDelete.type === 'debt') {
                    debts = debts.filter(d => d.id !== itemToDelete.id);
                } else if(itemToDelete.type === 'category') {
                    const categoryToDelete = categories.find(c => c.id === itemToDelete.id);
                    if(categoryToDelete) {
                       purchases.forEach(p => {
                           if (p.category === categoryToDelete.name) {
                               p.category = 'Diğer';
                           }
                       });
                    }
                    categories = categories.filter(c => c.id !== itemToDelete.id);
                }
                saveData();
                refreshUI();
                closeDeleteModal(); 
            }, 300); 
        }
        function handleCancelSubscription(id) { 
            const purchase = purchases.find(p => p.id === id); 
            if(!purchase) return; 
            showConfirmModal(`"${purchase.purchaseName}" aboneliğini iptal etmek istediğinize emin misiniz? Bu işlem harcamayı silmez, sadece tekrarlama özelliğini kapatır.`, 'Abonelik İptali', () => { 
                const purchaseIndex = purchases.findIndex(p => p.id === id);
                if (purchaseIndex > -1) {
                    purchases[purchaseIndex].isRecurring = false;
                    saveData();
                    refreshUI();
                }
            }); 
        }
        
        // --- BAŞLANGIÇ ---
        function init() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(reg => console.log('Service Worker registered.')).catch(err => console.log('Service Worker registration failed:', err)); });
            }
            loadData();
            applySettings();
            updateNotificationButton();
            if (Notification.permission === 'granted') {
                checkAndShowNotifications();
            }
            refreshUI();
            bindEventListeners();
            el.purchaseDateInput.valueAsDate = new Date();
            el.debtPaymentMonthInput.value = dayjs().format('YYYY-MM');

            // Turu başlatma kontrolü
            const tourCompleted = localStorage.getItem(STORAGE_KEYS.TOUR_COMPLETED);
            if (!tourCompleted && cards.length === 0 && purchases.length === 0) {
                setTimeout(startTour, 500); // Uygulamanın yüklenmesi için kısa bir bekleme
            }
        }

        init();
    });
    </script>
</body>
</html>
