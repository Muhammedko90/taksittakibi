<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>MAK Taksit Asistanı</title>
    
    <!-- MANIFEST VE İKON GÜNCELLEMELERİ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6d28d9">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <!-- STYLES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- LIBRARIES -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrBefore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrAfter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/localizedFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/tr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <!-- FIREBASE SDK -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>

    <style>
        :root { --primary-color: #6d28d9; --primary-color-light: #8b5cf6; --primary-text-color: #a78bfa; --summary-grad-from: #6d28d9; --summary-grad-to: #8b5cf6; }
        html.theme-blue { --primary-color: #2563eb; --primary-color-light: #3b82f6; --primary-text-color: #60a5fa; --summary-grad-from: #2563eb; --summary-grad-to: #3b82f6; }
        html.theme-green { --primary-color: #16a34a; --primary-color-light: #22c55e; --primary-text-color: #4ade80; --summary-grad-from: #16a34a; --summary-grad-to: #22c55e; }
        body { font-family: 'Inter', sans-serif; padding-bottom: 80px; }
        html.dark { color-scheme: dark; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 40; animation: fadeIn 0.3s ease; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; max-height: 90vh; overflow-y: auto; animation: fadeIn 0.3s ease; }
        .main-panel { display: none; }
        .main-panel.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        .bottom-nav-btn { transition: all 0.2s ease-in-out; }
        .bottom-nav-btn.active { color: var(--primary-text-color); background-color: #374151; }
        .summary-card { background: linear-gradient(135deg, var(--summary-grad-from), var(--summary-grad-to)); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }
        .item-fade-out { animation: fadeOut 0.3s ease-out forwards; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-slate-200 transition-colors duration-300">

    <!-- GİRİŞ EKRANI -->
    <div id="auth-container" class="flex items-center justify-center h-screen">
        <div class="text-center p-8 bg-slate-800 rounded-2xl shadow-2xl max-w-sm mx-auto">
            <h1 class="text-3xl font-bold text-white">MAK Taksit Asistanı</h1>
            <p class="text-slate-400 mt-2 mb-8">Harcamalarınızı yönetmek için giriş yapın.</p>
            <button id="login-btn" class="w-full bg-white text-gray-800 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-3 hover:bg-gray-200 transition-colors">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Google ile Giriş Yap
            </button>
        </div>
    </div>
    
    <!-- ANA UYGULAMA İÇERİĞİ -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl hidden">
        <header class="mb-8">
             <div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">MAK Taksit Asistanı</h1>
                <p id="welcome-message" class="text-gray-600 dark:text-slate-400 mt-2">Yükleniyor...</p>
            </div>
        </header>

        <main id="main-content">
            <!-- Paneller -->
            <div id="panel-home" class="main-panel active space-y-8">
                <div id="summary-panel" class="summary-card text-white p-6 rounded-2xl shadow-lg"></div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                        <h2 class="text-xl font-bold dark:text-white">Aylık Ödeme Planı</h2>
                        <select id="plan-month-selector" class="w-full sm:w-auto px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-sm"></select>
                    </div>
                    <div id="payment-plan"></div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Harcama Dağılımı</h2>
                    <div class="max-w-sm mx-auto"><canvas id="categoryChart"></canvas></div>
                </div>
            </div>

            <div id="panel-purchases" class="main-panel space-y-8">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Yeni Harcama Ekle</h2>
                    <form id="add-purchase-form" class="space-y-4">
                       <input type="text" name="purchase-name" placeholder="Harcama Açıklaması" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required>
                       <select name="purchase-category" id="purchase-category" class="mt-1 block w-full pl-3 pr-10 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required></select>
                       <input type="date" name="purchase-date" id="purchase-date" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required>
                       <input type="number" name="total-amount" step="0.01" min="0.01" placeholder="Toplam Tutar (₺)" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required>
                       <input type="number" name="installments-count" min="1" placeholder="Taksit Sayısı" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required>
                       <select name="card-select" id="card-select" class="mt-1 block w-full pl-3 pr-10 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required><option value="">Kart Seçin</option></select>
                       <div class="flex items-center">
                           <input name="purchase-recurring" id="purchase-recurring" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                           <label for="purchase-recurring" class="ml-2 block text-sm text-gray-900 dark:text-slate-300">Aylık Tekrarla (Fatura, Abonelik vb.)</label>
                        </div>
                       <button type="submit" class="w-full text-white py-2 px-4 rounded-md font-semibold transition-colors" style="background-color: var(--primary-color);">Harcamayı Ekle</button>
                    </form>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Kayıtlı Harcamalarınız</h2>
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <input type="text" id="search-input" placeholder="Harcama ara..." class="flex-grow px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700">
                        <select id="filter-category" class="px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700"></select>
                    </div>
                    <div id="purchase-list-details" class="space-y-4"></div>
                </div>
            </div>
            
            <div id="panel-history" class="main-panel space-y-8">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Ödeme Geçmişi</h2>
                    <p class="text-sm text-slate-400 mb-6">"Ödendi" olarak işaretlediğiniz tüm ekstreleriniz burada listelenir.</p>
                    <div id="history-list" class="space-y-4"></div>
                    <div id="history-pagination" class="flex justify-between items-center mt-6"></div>
                </div>
            </div>

            <div id="panel-subscriptions" class="main-panel space-y-8">
                 <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Aylık Abonelikleriniz</h2>
                    <p class="text-sm text-slate-400 mb-6">"Aylık Tekrarla" olarak işaretlediğiniz düzenli harcamalarınız burada listelenir.</p>
                    <div id="subscription-list" class="space-y-4"></div>
                </div>
            </div>

            <div id="panel-reports" class="main-panel space-y-8">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Tarihe Göre Raporla</h2>
                    <div class="flex gap-2 mb-4">
                        <button data-range="week" class="quick-range-btn flex-1 bg-slate-700 text-white py-2 px-4 rounded-md hover:bg-slate-600 font-semibold transition-colors text-sm">Son 1 Hafta</button>
                        <button data-range="month" class="quick-range-btn flex-1 bg-slate-700 text-white py-2 px-4 rounded-md hover:bg-slate-600 font-semibold transition-colors text-sm">Son 1 Ay</button>
                        <button data-range="year" class="quick-range-btn flex-1 bg-slate-700 text-white py-2 px-4 rounded-md hover:bg-slate-600 font-semibold transition-colors text-sm">Son 1 Yıl</button>
                    </div>
                    <div class="flex flex-col md:flex-row gap-4 items-end">
                        <div>
                            <label for="start-date" class="text-sm font-medium">Başlangıç Tarihi</label>
                            <input type="date" id="start-date" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700">
                        </div>
                        <div>
                            <label for="end-date" class="text-sm font-medium">Bitiş Tarihi</label>
                            <input type="date" id="end-date" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700">
                        </div>
                        <button id="generate-report-btn" class="w-full md:w-auto bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 font-semibold transition-colors">Rapor Oluştur</button>
                    </div>
                    <div id="report-output" class="mt-6"></div>
                </div>
            </div>

            <div id="panel-settings" class="main-panel space-y-8">
                 <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                     <h2 class="text-xl font-bold mb-4 dark:text-white">Tema Seçenekleri</h2>
                     <div class="flex items-center gap-4">
                         <div id="theme-selector" class="flex gap-4">
                            <button data-theme="" class="w-14 h-10 rounded-lg border-2 border-slate-400 flex overflow-hidden" title="Mor Tema"><span class="w-1/3 h-full" style="background-color: #6d28d9;"></span><span class="w-1/3 h-full" style="background-color: #8b5cf6;"></span><span class="w-1/3 h-full" style="background-color: #a78bfa;"></span></button>
                            <button data-theme="theme-blue" class="w-14 h-10 rounded-lg border-2 border-slate-400 flex overflow-hidden" title="Mavi Tema"><span class="w-1/3 h-full" style="background-color: #2563eb;"></span><span class="w-1/3 h-full" style="background-color: #3b82f6;"></span><span class="w-1/3 h-full" style="background-color: #60a5fa;"></span></button>
                            <button data-theme="theme-green" class="w-14 h-10 rounded-lg border-2 border-slate-400 flex overflow-hidden" title="Yeşil Tema"><span class="w-1/3 h-full" style="background-color: #16a34a;"></span><span class="w-1/3 h-full" style="background-color: #22c55e;"></span><span class="w-1/3 h-full" style="background-color: #4ade80;"></span></button>
                         </div>
                         <div class="border-l border-slate-600 pl-4">
                            <label for="custom-theme-picker" class="block text-sm font-medium text-slate-400 mb-2">Özel Renk</label>
                            <input type="color" id="custom-theme-picker" class="w-14 h-10 p-1 bg-slate-700 rounded-lg cursor-pointer">
                        </div>
                     </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Kartlarınızı Yönetin</h2>
                    <form id="add-card-form" class="space-y-4">
                        <input type="text" name="card-name" placeholder="Kart Adı (Örn: Maaş Kartım)" class="w-full px-3 py-2 border border-slate-600 rounded-md bg-slate-700" required>
                        <input type="number" name="statement-day" min="1" max="31" placeholder="Ekstre Kesim Günü (1-31)" class="w-full px-3 py-2 border border-slate-600 rounded-md bg-slate-700" required>
                        <input type="number" name="card-limit" min="0" placeholder="Kart Limiti (₺)" class="w-full px-3 py-2 border border-slate-600 rounded-md bg-slate-700" required>
                        <button type="submit" class="w-full text-white py-2 px-4 rounded-md font-semibold transition-colors" style="background-color: var(--primary-color);">Kart Ekle</button>
                    </form>
                    <div id="card-list" class="mt-6 space-y-4"></div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Gizlilik</h2>
                    <div class="flex items-center justify-between">
                        <div>
                            <label for="privacy-mode-toggle" class="font-medium text-white">Gizlilik Modu</label>
                            <p class="text-sm text-slate-400 mt-1">Uygulamadaki tüm finansal tutarları gizler.</p>
                        </div>
                        <label for="privacy-mode-toggle" class="relative inline-flex items-center cursor-pointer"><input type="checkbox" value="" id="privacy-mode-toggle" class="sr-only peer"><div class="w-11 h-6 bg-slate-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-800 peer-checked:bg-violet-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div></label>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Hesap Yönetimi</h2>
                    <div class="space-y-4">
                        <button id="logout-btn" class="w-full bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700 font-semibold transition-colors">Çıkış Yap</button>
                        <div class="border-t border-slate-600 !mt-6 !mb-2"></div>
                         <button id="delete-all-data-btn" class="w-full bg-red-800 text-white py-2 px-4 rounded-md hover:bg-red-900 font-semibold transition-colors">TÜM VERİLERİ SİL</button>
                         <p class="text-xs text-slate-500 text-center">Bu işlem geri alınamaz. Tüm kartlarınız ve harcamalarınız kalıcı olarak silinir.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Alt Navigasyon Menüsü -->
    <footer id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 shadow-lg z-30 hidden">
        <nav class="flex justify-around items-center h-16 max-w-7xl mx-auto px-1">
            <button data-panel="home" class="bottom-nav-btn active flex flex-col items-center justify-center text-slate-400 w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg><span class="text-xs mt-1">Ana Sayfa</span></button>
            <button data-panel="purchases" class="bottom-nav-btn flex flex-col items-center justify-center text-slate-400 w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg><span class="text-xs mt-1">Harcamalar</span></button>
            <button data-panel="history" class="bottom-nav-btn flex flex-col items-center justify-center text-slate-400 w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span class="text-xs mt-1">Geçmiş</span></button>
            <button data-panel="subscriptions" class="bottom-nav-btn flex flex-col items-center justify-center text-slate-400 w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm5 2a1 1 0 00-1 1v8a1 1 0 102 0V6a1 1 0 00-1-1zm5-2a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1z" clip-rule="evenodd" /></svg><span class="text-xs mt-1">Abonelikler</span></button>
            <button data-panel="reports" class="bottom-nav-btn flex flex-col items-center justify-center text-slate-400 w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg><span class="text-xs mt-1">Raporlar</span></button>
            <button data-panel="settings" class="bottom-nav-btn flex flex-col items-center justify-center text-slate-400 w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span class="text-xs mt-1">Ayarlar</span></button>
        </nav>
    </footer>

    <div id="modal-container"></div>

    <!-- ================================================================= -->
    <!--                      UYGULAMA SCRIPT'LERİ                         -->
    <!-- ================================================================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, writeBatch, serverTimestamp, query, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA0ZOlfP0egAypBwBI2UR0QhoobDRVF_Ew",
            authDomain: "mak-taksit-asistani-394e8.firebaseapp.com",
            projectId: "mak-taksit-asistani-394e8",
            storageBucket: "mak-taksit-asistani-394e8.appspot.com",
            messagingSenderId: "27410630069",
            appId: "1:27410630069:web:29c69ce5395944708805fc"
        };
        
        const CATEGORIES = ['Gıda', 'Fatura', 'Ulaşım', 'Giyim', 'Eğlence', 'Sağlık', 'Ev Eşyası', 'Dijital Servis', 'Diğer'];
        const HISTORY_ITEMS_PER_PAGE = 5;

        const formatCurrency = (value, privacyMode) => {
            if (privacyMode) return '₺ --,--';
            const numberValue = parseFloat(value);
            return isNaN(numberValue) ? '₺ 0.00' : `₺ ${numberValue.toFixed(2)}`;
        };

        const lightenColor = (hex, percent) => {
            let r = parseInt(hex.substring(1, 3), 16), g = parseInt(hex.substring(3, 5), 16), b = parseInt(hex.substring(5, 7), 16);
            r = parseInt(r * (100 + percent) / 100); g = parseInt(g * (100 + percent) / 100); b = parseInt(b * (100 + percent) / 100);
            r = (r < 255) ? r : 255; g = (g < 255) ? g : 255; b = (b < 255) ? b : 255;
            const toHex = (c) => ('0' + (c.toString(16))).slice(-2);
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        };

        const createDOMElement = (tag, { classList = [], id = '', textContent = '', dataset = {}, children = [], attributes = {}, events = {}, innerHTML = '' } = {}) => {
            const el = document.createElement(tag);
            if (classList.length) el.className = classList.join(' ');
            if (id) el.id = id;
            if (textContent) el.textContent = textContent;
            if (innerHTML) el.innerHTML = innerHTML;
            Object.entries(dataset).forEach(([key, value]) => el.dataset[key] = value);
            Object.entries(attributes).forEach(([key, value]) => el.setAttribute(key, value));
            Object.entries(events).forEach(([event, handler]) => el.addEventListener(event, handler));
            children.forEach(child => el.appendChild(child));
            return el;
        };

        class TaksitApp {
            constructor() {
                this.cards = []; this.purchases = []; this.userSettings = {}; this.currentUser = null;
                this.unsubscribeListeners = []; this.historyCurrentPage = 1; this.categoryChartInstance = null;
                this.selectedPlanMonth = localStorage.getItem('selectedPlanMonth');
                this.currentReportData = [];

                this.app = initializeApp(firebaseConfig); this.auth = getAuth(this.app); this.db = getFirestore(this.app);
                
                this.el = {
                    authContainer: document.getElementById('auth-container'), appContainer: document.getElementById('app-container'),
                    bottomNav: document.getElementById('bottom-nav'), loginBtn: document.getElementById('login-btn'),
                    logoutBtn: document.getElementById('logout-btn'), welcomeMessage: document.getElementById('welcome-message'),
                    modalContainer: document.getElementById('modal-container'), cardList: document.getElementById('card-list'),
                    purchaseList: document.getElementById('purchase-list-details'), subscriptionList: document.getElementById('subscription-list'),
                    paymentPlan: document.getElementById('payment-plan'), historyList: document.getElementById('history-list'),
                    historyPagination: document.getElementById('history-pagination'), summaryPanel: document.getElementById('summary-panel'),
                    categoryChartCanvas: document.getElementById('categoryChart'), purchaseDateInput: document.getElementById('purchase-date'),
                    planMonthSelector: document.getElementById('plan-month-selector'), privacyModeToggle: document.getElementById('privacy-mode-toggle'),
                    customThemePicker: document.getElementById('custom-theme-picker'), mainContent: document.getElementById('main-content'),
                };
            }

            init() {
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => { 
                        navigator.serviceWorker.register('sw.js')
                            .then(reg => console.log('Service Worker registered.'))
                            .catch(err => console.log('Service Worker registration failed:', err)); 
                    });
                }
                dayjs.extend(window.dayjs_plugin_customParseFormat); dayjs.extend(window.dayjs_plugin_isSameOrBefore);
                dayjs.extend(window.dayjs_plugin_isSameOrAfter); dayjs.extend(window.dayjs_plugin_localizedFormat);
                dayjs.extend(window.dayjs_plugin_isBetween);
                dayjs.locale('tr');
                this.el.purchaseDateInput.valueAsDate = new Date();
                this.listenToAuthChanges();
                this.bindEventListeners();
            }

            listenToAuthChanges() {
                onAuthStateChanged(this.auth, user => {
                    if (user) {
                        this.currentUser = user;
                        this.el.authContainer.classList.add('hidden'); this.el.appContainer.classList.remove('hidden');
                        this.el.bottomNav.classList.remove('hidden');
                        this.el.welcomeMessage.textContent = `Hoşgeldin, ${user.displayName || 'Kullanıcı'}!`;
                        this.listenToData(user.uid);
                    } else {
                        this.currentUser = null;
                        this.el.authContainer.classList.remove('hidden'); this.el.appContainer.classList.add('hidden');
                        this.el.bottomNav.classList.add('hidden');
                        this.clearDataListeners();
                        this.cards = []; this.purchases = []; this.userSettings = {};
                    }
                });
            }
            
            clearDataListeners() {
                this.unsubscribeListeners.forEach(unsub => unsub());
                this.unsubscribeListeners = [];
            }

            listenToData(userId) {
                this.clearDataListeners();
                const unsubCards = onSnapshot(collection(this.db, 'users', userId, 'cards'), (snapshot) => {
                    this.cards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.refreshUI(false); // Do not reset month on every card change
                });
                const unsubPurchases = onSnapshot(collection(this.db, 'users', userId, 'purchases'), (snapshot) => {
                    this.purchases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.refreshUI(true); // Reset month if purchases change
                });
                const unsubSettings = onSnapshot(doc(this.db, 'users', userId, 'settings', 'userProfile'), (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        this.userSettings = docSnapshot.data();
                    } else {
                        const defaultSettings = { theme: '', customThemeColor: null, privacyMode: false, paidMonths: {} };
                        setDoc(doc(this.db, 'users', userId, 'settings', 'userProfile'), defaultSettings);
                        this.userSettings = defaultSettings;
                    }
                    this.applySettings();
                    this.refreshUI(false);
                });
                this.unsubscribeListeners.push(unsubCards, unsubPurchases, unsubSettings);
            }

            // DÜZELTME: resetMonthSelection parametresi eklendi.
            refreshUI(resetMonthSelection = false) {
                if (!this.currentUser) return;
                const paymentSchedule = this.calculatePaymentSchedule();
                
                // DÜZELTME: Sadece gerektiğinde (örn. yeni harcama eklendiğinde) ay seçimini sıfırla.
                if (resetMonthSelection) {
                    this.selectedPlanMonth = this.findFirstUnpaidMonth(paymentSchedule);
                } else {
                    const availableMonths = ['all', ...Object.keys(paymentSchedule).filter(m => schedule[m].unpaidTotal > 0)];
                    if (!this.selectedPlanMonth || !availableMonths.includes(this.selectedPlanMonth)) {
                        this.selectedPlanMonth = this.findFirstUnpaidMonth(paymentSchedule);
                    }
                }
                localStorage.setItem('selectedPlanMonth', this.selectedPlanMonth);

                this.renderSummary(paymentSchedule);
                this.populateMonthSelector(paymentSchedule, this.selectedPlanMonth);
                this.renderPaymentPlan(paymentSchedule, this.selectedPlanMonth);
                this.renderHistory(paymentSchedule);
                this.renderCategoryChart();
                this.renderCards();
                this.renderPurchasesList();
                this.renderSubscriptions();
                this.updateCardSelects();
                this.populateCategorySelects();
            }
            
            applySettings() {
                const { theme, customThemeColor, privacyMode } = this.userSettings;
                const root = document.documentElement;
                root.style.cssText = ''; 
                if (theme === 'custom' && customThemeColor) {
                    const colorLight = lightenColor(customThemeColor, 20); const colorText = lightenColor(customThemeColor, 40);
                    root.style.setProperty('--primary-color', customThemeColor); root.style.setProperty('--primary-color-light', colorLight);
                    root.style.setProperty('--primary-text-color', colorText); root.style.setProperty('--summary-grad-from', customThemeColor);
                    root.style.setProperty('--summary-grad-to', colorLight);
                    this.el.customThemePicker.value = customThemeColor;
                }
                root.className = `dark ${theme !== 'custom' ? (theme || '') : ''}`;
                this.el.privacyModeToggle.checked = !!privacyMode;
            }

            bindEventListeners() {
                this.el.loginBtn.addEventListener('click', () => this.login());
                this.el.logoutBtn.addEventListener('click', () => this.logout());
                document.body.addEventListener('submit', this.handleFormSubmits.bind(this));
                document.body.addEventListener('input', this.handleInputs.bind(this));
                document.body.addEventListener('change', this.handleChanges.bind(this));
                document.body.addEventListener('click', this.handleBodyClicks.bind(this));
            }

            async login() {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(this.auth, provider);
                } catch (error) {
                    console.error("Giriş hatası:", error);
                    if (error.code === 'auth/unauthorized-domain') {
                        this.showInfoModal(
                            `Bu uygulamanın çalıştığı alan adı (domain) Firebase projenizde yetkilendirilmemiş.<br><br><b>Çözüm:</b><br>1. Firebase projenize gidin.<br>2. Authentication > Settings > Authorized domains menüsünü açın.<br>3. 'Add domain' butonuna tıklayarak <b>${window.location.hostname}</b> adresini ekleyin.`,
                            'Yetkilendirme Hatası',
                            'error'
                        );
                    } else {
                        this.showInfoModal('Google ile giriş sırasında bir hata oluştu. Lütfen konsolu kontrol edin.', 'Hata', 'error');
                    }
                }
            }
            
            async logout() {
                try {
                    await signOut(this.auth);
                } catch (error) {
                    console.error("Çıkış hatası:", error);
                }
            }

            handleInputs(e) {
                if (e.target.id === 'search-input') this.renderPurchasesList();
                if (e.target.id === 'custom-theme-picker') this.updateSettings({ theme: 'custom', customThemeColor: e.target.value });
            }

            handleChanges(e) {
                if (e.target.id === 'filter-category') this.renderPurchasesList();
                if (e.target.id === 'privacy-mode-toggle') this.updateSettings({ privacyMode: e.target.checked });
                if (e.target.id === 'plan-month-selector') {
                    this.selectedPlanMonth = e.target.value;
                    localStorage.setItem('selectedPlanMonth', this.selectedPlanMonth);
                    this.renderPaymentPlan(this.calculatePaymentSchedule(), this.selectedPlanMonth);
                }
            }
            
            async handleBodyClicks(e) {
                const btn = e.target.closest('button');
                if (!btn || !this.currentUser) return;
                const { id, key, panel, range } = btn.dataset;

                if (btn.matches('.pay-btn')) {
                    const newPaidStatus = { ...(this.userSettings.paidMonths || {}), [key]: { paidDate: dayjs().toISOString() } };
                    await this.updateSettings({ paidMonths: newPaidStatus });
                } else if (btn.matches('.undo-pay-btn')) {
                    const newPaidStatus = { ...(this.userSettings.paidMonths || {}) };
                    delete newPaidStatus[key];
                    await this.updateSettings({ paidMonths: newPaidStatus });
                } else if (btn.id === 'history-prev-btn') {
                    if (this.historyCurrentPage > 1) { this.historyCurrentPage--; this.renderHistory(this.calculatePaymentSchedule()); }
                } else if (btn.id === 'history-next-btn') {
                    this.historyCurrentPage++; this.renderHistory(this.calculatePaymentSchedule());
                } else if (btn.closest('#bottom-nav')) {
                    document.querySelectorAll('.bottom-nav-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.querySelectorAll('.main-panel').forEach(p => p.classList.remove('active'));
                    document.getElementById(`panel-${panel}`).classList.add('active');
                } else if (btn.closest('#theme-selector') && btn.dataset.theme !== undefined) {
                    this.updateSettings({ theme: btn.dataset.theme, customThemeColor: null });
                } else if (btn.matches('.quick-range-btn')) {
                    this.handleQuickReportRange(range);
                } else if (btn.id === 'generate-report-btn') {
                    this.handleGenerateReport();
                } else if (btn.id === 'export-pdf-btn') {
                    this.exportReportAsPDF();
                } else if (btn.id === 'delete-all-data-btn') {
                    this.handleDeleteAllData();
                } else if (btn.matches('.edit-card-btn')) {
                    this.openEditCardModal(id);
                } else if (btn.matches('.edit-purchase-btn') || btn.matches('.edit-subscription-btn')) {
                    this.openEditPurchaseModal(id);
                } else if (btn.matches('.delete-card-btn')) {
                    const card = this.cards.find(c => c.id === id);
                    if (card) this.showConfirmModal(`"${card.cardName}" öğesini silmek istediğinizden emin misiniz? Bu karta ait tüm harcamalar da silinecektir.`, 'Silme Onayı', () => this.handleConfirmDelete(id, 'card'));
                } else if (btn.matches('.delete-purchase-btn')) {
                    const purchase = this.purchases.find(p => p.id === id);
                    if (purchase) this.showConfirmModal(`"${purchase.purchaseName}" öğesini silmek istediğinizden emin misiniz?`, 'Silme Onayı', () => this.handleConfirmDelete(id, 'purchase'));
                } else if (btn.matches('.cancel-subscription-btn')) {
                    this.handleCancelSubscription(id);
                }
            }

            async handleFormSubmits(e) {
                e.preventDefault();
                if (!this.currentUser) return;
                const form = e.target;
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                try {
                    if (form.id === 'add-purchase-form') {
                        const newPurchase = { purchaseName: data['purchase-name'], purchaseDate: data['purchase-date'], totalAmount: parseFloat(data['total-amount']), installmentsCount: parseInt(data['installments-count']), cardId: data['card-select'], category: data['purchase-category'], isRecurring: !!data['purchase-recurring'], createdAt: serverTimestamp() };
                        await addDoc(collection(this.db, 'users', this.currentUser.uid, 'purchases'), newPurchase);
                        form.reset(); this.el.purchaseDateInput.valueAsDate = new Date();
                        this.showInfoModal('Harcama başarıyla eklendi.', 'Başarılı', 'success');
                    } else if (form.id === 'add-card-form') {
                        await addDoc(collection(this.db, 'users', this.currentUser.uid, 'cards'), { cardName: data['card-name'], statementDay: parseInt(data['statement-day']), cardLimit: parseFloat(data['card-limit']), createdAt: serverTimestamp() });
                        form.reset();
                    } else if (form.id === 'edit-card-form') {
                        await updateDoc(doc(this.db, 'users', this.currentUser.uid, 'cards', data['edit-card-id']), { cardName: data['edit-card-name'], statementDay: parseInt(data['edit-statement-day']), cardLimit: parseFloat(data['edit-card-limit']) });
                        this.closeModal();
                    } else if (form.id === 'edit-purchase-form') {
                        await updateDoc(doc(this.db, 'users', this.currentUser.uid, 'purchases', data['edit-purchase-id']), { purchaseName: data['edit-purchase-name'], purchaseDate: data['edit-purchase-date'], totalAmount: parseFloat(data['edit-total-amount']), installmentsCount: parseInt(data['edit-installments-count']), cardId: data['edit-card-select'], category: data['edit-purchase-category'], isRecurring: !!data['edit-purchase-recurring'] });
                        this.closeModal();
                    }
                } catch(error) {
                    console.error("Form gönderme hatası:", error);
                    this.showInfoModal('İşlem sırasında bir hata oluştu.', 'Hata', 'error');
                }
            }

            async updateSettings(settings) {
                if (!this.currentUser) return;
                const settingsRef = doc(this.db, 'users', this.currentUser.uid, 'settings', 'userProfile');
                await setDoc(settingsRef, settings, { merge: true });
            }

            closeModal() { this.el.modalContainer.innerHTML = ''; }

            showModal(content) {
                this.closeModal();
                this.el.modalContainer.appendChild(content);
                const backdrop = content.querySelector('.modal-backdrop');
                const modal = content.querySelector('.modal');
                if(backdrop) backdrop.style.display = 'block';
                if(modal) modal.style.display = 'block';
                backdrop?.addEventListener('click', () => this.closeModal());
            }

            showInfoModal(message, title = 'Bilgi', type = 'info') {
                const colors = { info: 'indigo', success: 'green', error: 'red' }; const color = colors[type] || 'indigo';
                const okButton = createDOMElement('button', { textContent: 'Tamam', classList: [`bg-${color}-600`, 'text-white', 'py-2', 'px-4', 'rounded-md'], events: { click: () => this.closeModal() } });
                this.showModal(createDOMElement('div', { children: [ createDOMElement('div', { classList: ['modal-backdrop'] }), createDOMElement('div', { classList: ['modal', 'bg-slate-800', 'p-6', 'rounded-lg', 'shadow-xl', 'max-w-sm', 'w-full'], children: [ createDOMElement('h3', { textContent: title, classList: ['text-lg', 'font-medium', 'text-white'] }), createDOMElement('p', { innerHTML: message, classList: ['text-sm', 'text-slate-400', 'mt-4'] }), createDOMElement('div', { classList: ['mt-5', 'flex', 'justify-end', 'gap-3'], children: [okButton] }) ] }) ] }));
            }
            
            showConfirmModal(message, title, callback, confirmText = 'Onayla', cancelText = 'İptal') {
                const confirmButton = createDOMElement('button', { textContent: confirmText, classList: ['bg-red-600', 'text-white', 'py-2', 'px-4', 'rounded-md'], events: { click: () => { callback(); this.closeModal(); } } });
                const cancelButton = createDOMElement('button', { textContent: cancelText, classList: ['bg-slate-600', 'text-slate-200', 'py-2', 'px-4', 'rounded-md'], events: { click: () => this.closeModal() } });
                this.showModal(createDOMElement('div', { children: [ createDOMElement('div', { classList: ['modal-backdrop'] }), createDOMElement('div', { classList: ['modal', 'bg-slate-800', 'p-6', 'rounded-lg', 'shadow-xl', 'max-w-sm', 'w-full'], children: [ createDOMElement('h3', { innerHTML: title, classList: ['text-lg', 'font-medium', 'text-white'] }), createDOMElement('p', { innerHTML: message, classList: ['text-sm', 'text-slate-400', 'mt-4'] }), createDOMElement('div', { classList: ['mt-5', 'flex', 'justify-end', 'gap-3'], children: [cancelButton, confirmButton] }) ] }) ] }));
            }
            
            // DÜZELTME: Düzenleme modalları eklendi.
            openEditCardModal(id) {
                const card = this.cards.find(c => c.id === id);
                if (!card) return;
                const modalContent = createDOMElement('div', {
                    children: [
                        createDOMElement('div', { classList: ['modal-backdrop']}),
                        createDOMElement('div', { classList: ['modal', 'bg-slate-800', 'p-6', 'rounded-2xl', 'shadow-xl', 'max-w-lg', 'w-full'],
                            innerHTML: `
                                <h2 class="text-xl font-bold mb-4 text-white">Kartı Düzenle</h2>
                                <form id="edit-card-form" class="space-y-4">
                                    <input type="hidden" name="edit-card-id" value="${card.id}">
                                    <div><label class="text-sm text-slate-300">Kart Adı</label><input type="text" name="edit-card-name" value="${card.cardName}" class="mt-1 block w-full border border-slate-600 rounded-md p-2 bg-slate-700" required></div>
                                    <div><label class="text-sm text-slate-300">Kesim Günü</label><input type="number" name="edit-statement-day" value="${card.statementDay}" class="mt-1 block w-full border border-slate-600 rounded-md p-2 bg-slate-700" required></div>
                                    <div><label class="text-sm text-slate-300">Limit</label><input type="number" name="edit-card-limit" value="${card.cardLimit}" class="mt-1 block w-full border border-slate-600 rounded-md p-2 bg-slate-700" required></div>
                                    <div class="mt-6 flex justify-end space-x-3">
                                        <button type="button" id="cancel-edit-btn" class="bg-slate-600 px-4 py-2 rounded-md">İptal</button>
                                        <button type="submit" class="text-white px-4 py-2 rounded-md" style="background-color: var(--primary-color);">Kaydet</button>
                                    </div>
                                </form>`
                        })
                    ]
                });
                modalContent.querySelector('#cancel-edit-btn').addEventListener('click', () => this.closeModal());
                this.showModal(modalContent);
            }

            openEditPurchaseModal(id) {
                const p = this.purchases.find(p => p.id === id);
                if (!p) return;

                const categoryOptions = CATEGORIES.map(cat => `<option value="${cat}" ${p.category === cat ? 'selected' : ''}>${cat}</option>`).join('');
                const cardOptions = this.cards.map(card => `<option value="${card.id}" ${p.cardId === card.id ? 'selected' : ''}>${card.cardName}</option>`).join('');

                const modalContent = createDOMElement('div', {
                    children: [
                        createDOMElement('div', { classList: ['modal-backdrop']}),
                        createDOMElement('div', { classList: ['modal', 'bg-slate-800', 'p-6', 'rounded-2xl', 'shadow-xl', 'max-w-lg', 'w-full'],
                            innerHTML: `
                                <h2 class="text-xl font-bold mb-4 text-white">Harcamayı Düzenle</h2>
                                <form id="edit-purchase-form" class="space-y-4">
                                    <input type="hidden" name="edit-purchase-id" value="${p.id}">
                                    <div><label class="text-sm text-slate-300">Açıklama</label><input type="text" name="edit-purchase-name" value="${p.purchaseName}" class="mt-1 block w-full border border-slate-600 rounded-md p-2 bg-slate-700" required></div>
                                    <div><label class="text-sm text-slate-300">Kategori</label><select name="edit-purchase-category" class="mt-1 block w-full border border-slate-600 rounded-md p-2 bg-slate-700" required>${categoryOptions}</select></div>
                                    <div><label class="text-sm text-slate-300">Tarih</label><input type="date" name="edit-purchase-date" value="${p.purchaseDate}" class="mt-1 block w-full border border-slate-600 rounded-md p-2 bg-slate-700" required></div>
                                    <div><label class="text-sm text-slate-300">Tutar</label><input type="number" name="edit-total-amount" step="0.01" value="${p.totalAmount}" class="mt-1 block w-full border border-slate-600 rounded-md p-2 bg-slate-700" required></div>
                                    <div><label class="text-sm text-slate-300">Taksit</label><input type="number" name="edit-installments-count" min="1" value="${p.installmentsCount}" class="mt-1 block w-full border border-slate-600 rounded-md p-2 bg-slate-700" required></div>
                                    <div><label class="text-sm text-slate-300">Kart</label><select name="edit-card-select" class="mt-1 block w-full border border-slate-600 rounded-md p-2 bg-slate-700" required>${cardOptions}</select></div>
                                    <div class="flex items-center mt-4"><input name="edit-purchase-recurring" type="checkbox" ${p.isRecurring ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="edit-purchase-recurring" class="ml-2 block text-sm">Aylık Tekrarla</label></div>
                                    <div class="mt-6 flex justify-end space-x-3">
                                        <button type="button" id="cancel-edit-btn" class="bg-slate-600 px-4 py-2 rounded-md">İptal</button>
                                        <button type="submit" class="text-white px-4 py-2 rounded-md" style="background-color: var(--primary-color);">Kaydet</button>
                                    </div>
                                </form>`
                        })
                    ]
                });
                modalContent.querySelector('#cancel-edit-btn').addEventListener('click', () => this.closeModal());
                this.showModal(modalContent);
            }
            
            // Renderleme fonksiyonları burada...
            renderCards() { this.el.cardList.innerHTML = ''; if (this.cards.length === 0) { this.el.cardList.innerHTML = `<div class="text-center py-8"><p class="mt-1 text-sm text-slate-400">Başlamak için ilk kartınızı ekleyin!</p></div>`; return; } this.cards.forEach(card => { const totalSpending = this.purchases.filter(p => p.cardId === card.id).reduce((sum, p) => sum + parseFloat(p.totalAmount || 0), 0); const remainingLimit = parseFloat(card.cardLimit) - totalSpending; const usagePercentage = card.cardLimit > 0 ? (totalSpending / card.cardLimit) * 100 : 0; const cardEl = createDOMElement('div', { classList: ['bg-slate-700', 'p-4', 'rounded-lg', 'border', 'border-slate-600', 'transition-all', 'duration-300'], attributes: { style: 'animation: fadeIn 0.5s' }, innerHTML: `<div class="flex justify-between items-start"> <div> <p class="font-semibold text-lg text-white">${card.cardName}</p> <p class="text-xs text-slate-400">Kesim: Ayın ${card.statementDay}. günü</p> </div> <div class="flex items-center space-x-2"> <button data-id="${card.id}" class="edit-card-btn text-sm bg-blue-900/50 text-blue-300 font-semibold px-3 py-1 rounded-md hover:bg-blue-800/50">Düzenle</button> <button data-id="${card.id}" class="delete-card-btn text-sm bg-red-900/50 text-red-300 font-semibold px-3 py-1 rounded-md hover:bg-red-800/50">Sil</button> </div> </div> <div class="mt-3"> <div class="flex justify-between text-xs mb-1"> <span class="text-slate-400">Kullanılan: <span class="font-medium text-white">${formatCurrency(totalSpending, this.userSettings.privacyMode)}</span></span> <span class="text-slate-400">Limit: <span class="font-medium text-white">${formatCurrency(card.cardLimit, this.userSettings.privacyMode)}</span></span> </div> <div class="w-full bg-slate-600 rounded-full h-2.5"> <div class="h-2.5 rounded-full transition-all duration-500" style="width: ${Math.min(usagePercentage, 100)}%; background-color: ${usagePercentage > 90 ? '#ef4444' : usagePercentage > 70 ? '#f97316' : 'var(--primary-color)'};"></div> </div> <p class="text-right text-xs mt-1 text-green-400">Kalan Limit: <span class="font-bold">${formatCurrency(remainingLimit, this.userSettings.privacyMode)}</span></p> </div>` }); this.el.cardList.appendChild(cardEl); }); }
            renderPurchasesList() { this.el.purchaseList.innerHTML = ''; const searchTerm = document.getElementById('search-input').value.toLowerCase(); const category = document.getElementById('filter-category').value; let filtered = this.purchases.filter(p => p.purchaseName.toLowerCase().includes(searchTerm) && (category ? p.category === category : true)); if (filtered.length === 0) { this.el.purchaseList.innerHTML = '<p class="text-sm text-slate-400 text-center py-4">Filtreye uygun harcama yok.</p>'; return; } [...filtered].sort((a, b) => new Date(b.purchaseDate) - new Date(a.purchaseDate)).forEach(p => { const card = this.cards.find(c => c.id === p.cardId); const recurringIcon = p.isRecurring ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-2 text-cyan-400" title="Tekrarlayan Harcama" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 12A8 8 0 1013 5.372" /></svg>` : ''; const purchaseEl = createDOMElement('div', { classList: ['flex', 'justify-between', 'items-center', 'bg-slate-700', 'p-4', 'rounded-lg', 'border', 'border-slate-600'], innerHTML: `<div><p class="font-semibold text-white">${p.purchaseName}${recurringIcon}</p><p class="text-sm text-slate-300"><span class="font-medium" style="color:var(--primary-text-color);">${p.category || 'Diğer'}</span> - ${formatCurrency(p.totalAmount / p.installmentsCount, this.userSettings.privacyMode)} x ${p.installmentsCount} Taksit</p><p class="text-xs text-slate-400">Tarih: ${dayjs(p.purchaseDate).format('DD.MM.YYYY')} | Kart: ${card ? card.cardName : 'Bilinmeyen'}</p></div><div class="flex items-center space-x-2"><button data-id="${p.id}" class="edit-purchase-btn text-sm bg-blue-900/50 text-blue-300 font-semibold px-3 py-1 rounded-md hover:bg-blue-800/50">Düzenle</button><button data-id="${p.id}" class="delete-purchase-btn text-sm bg-red-900/50 text-red-300 font-semibold px-3 py-1 rounded-md hover:bg-red-800/50">Sil</button></div>` }); this.el.purchaseList.appendChild(purchaseEl); }); }
            renderSubscriptions() { this.el.subscriptionList.innerHTML = ''; const subscriptions = this.purchases.filter(p => p.isRecurring); if (subscriptions.length === 0) { this.el.subscriptionList.innerHTML = '<p class="text-sm text-slate-400 text-center py-4">Gösterilecek abonelik bulunmuyor.</p>'; return; } let monthlyTotal = 0; subscriptions.forEach(p => { const card = this.cards.find(c => c.id === p.cardId); const monthlyCost = parseFloat(p.totalAmount) / parseInt(p.installmentsCount); monthlyTotal += monthlyCost; const subEl = createDOMElement('div', { classList: ['flex', 'justify-between', 'items-center', 'bg-slate-700', 'p-4', 'rounded-lg', 'border', 'border-slate-600'], innerHTML: `<div><p class="font-semibold text-white">${p.purchaseName}</p><p class="text-sm text-slate-300">${p.category || 'Diğer'}</p><p class="text-xs text-slate-400">Kart: ${card ? card.cardName : 'Bilinmeyen'}</p></div><div class="text-right flex items-center space-x-3"><div><p class="font-semibold text-lg text-white">${formatCurrency(monthlyCost, this.userSettings.privacyMode)}</p><p class="text-xs text-slate-400">aylık</p></div><div class="flex flex-col space-y-2"><button data-id="${p.id}" class="edit-subscription-btn text-blue-400 hover:text-blue-300" title="Düzenle"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button><button data-id="${p.id}" class="cancel-subscription-btn text-red-400 hover:text-red-300" title="Aboneliği İptal Et"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button></div></div>` }); this.el.subscriptionList.appendChild(subEl); }); const summaryEl = createDOMElement('div', { classList: ['mt-6', 'pt-4', 'border-t', 'border-slate-700', 'text-right'], innerHTML: `<p class="text-sm text-slate-300">Aylık Toplam Abonelik Gideri</p><p class="font-bold text-2xl text-white">${formatCurrency(monthlyTotal, this.userSettings.privacyMode)}</p>` }); this.el.subscriptionList.appendChild(summaryEl); }
            calculatePaymentSchedule() { const schedule = {}; this.purchases.forEach(p => { const card = this.cards.find(c => c.id === p.cardId); if (!card) return; const purchaseDate = dayjs(p.purchaseDate); const statementDay = parseInt(card.statementDay); const installmentAmount = parseFloat(p.totalAmount) / parseInt(p.installmentsCount); let firstStatementDate = purchaseDate.date(statementDay); if (purchaseDate.date() > statementDay) firstStatementDate = firstStatementDate.add(1, 'month'); for (let i = 0; i < p.installmentsCount; i++) { const currentStatementDate = firstStatementDate.add(i, 'month'); const dueDate = currentStatementDate.add(10, 'days'); const paymentMonthKey = dueDate.format('YYYY-MM'); if (!schedule[paymentMonthKey]) schedule[paymentMonthKey] = { total: 0, unpaidTotal: 0, details: {} }; if (!schedule[paymentMonthKey].details[p.cardId]) schedule[paymentMonthKey].details[p.cardId] = { amount: 0, dueDate: dueDate.format('YYYY-MM-DD') }; schedule[paymentMonthKey].details[p.cardId].amount += installmentAmount; schedule[paymentMonthKey].total += installmentAmount; const paymentKey = `${paymentMonthKey}_${p.cardId}`; if (!(this.userSettings?.paidMonths || {})[paymentKey]) schedule[paymentMonthKey].unpaidTotal += installmentAmount; } }); return schedule; }
            renderPaymentPlan(schedule, selectedMonthKey) { this.el.paymentPlan.innerHTML = ''; let content = ''; let hasAnyPayment = false; const processMonth = (monthKey, isAllMode) => { let monthContent = ''; const monthData = schedule[monthKey]; Object.keys(monthData.details).forEach(cardId => { const paymentData = monthData.details[cardId]; const card = this.cards.find(c => c.id === cardId); const paymentKey = `${monthKey}_${cardId}`; const isPaid = (this.userSettings?.paidMonths || {})[paymentKey]; if (card && !isPaid && paymentData?.amount > 0) { hasAnyPayment = true; const dueDate = dayjs(paymentData.dueDate); const lateClass = dayjs().isAfter(dueDate, 'day') ? 'border-red-500/50' : 'border-slate-600'; monthContent += `<div class="bg-slate-900/50 p-4 rounded-lg border ${lateClass}"><div class="flex justify-between items-center"><div><p class="font-bold text-white">${card.cardName}</p><p class="text-xs text-slate-400">Son Ödeme: ${dueDate.format('DD MMMM YYYY')}</p></div><p class="text-xl font-semibold text-white">${formatCurrency(paymentData.amount, this.userSettings.privacyMode)}</p></div><div class="mt-3 text-right"><button data-key="${paymentKey}" class="pay-btn text-sm bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md w-full sm:w-auto">Ödendi Olarak İşaretle</button></div></div>`; } }); return monthContent ? (isAllMode ? `<div class="mt-8 first:mt-0"><h3 class="text-lg font-semibold text-white border-b border-slate-600 pb-2 mb-4">${dayjs(monthKey).format('MMMM YYYY')}</h3><div class="space-y-4">${monthContent}</div></div>` : `<div class="space-y-4">${monthContent}</div>`) : ''; }; if (selectedMonthKey === 'all') { const monthsToRender = Object.keys(schedule).filter(m => schedule[m].unpaidTotal > 0).sort(); monthsToRender.forEach(monthKey => content += processMonth(monthKey, true)); } else if (schedule[selectedMonthKey]) { content += processMonth(selectedMonthKey, false); if (hasAnyPayment) { const unpaidTotalForMonth = schedule[selectedMonthKey].unpaidTotal; content += `<div class="mt-6 pt-4 border-t border-slate-700 text-right"><p class="text-sm text-slate-300">${dayjs(selectedMonthKey).format('MMMM YYYY')} Kalan Toplam Ödeme</p><p class="font-bold text-2xl text-red-500">${formatCurrency(unpaidTotalForMonth, this.userSettings.privacyMode)}</p></div>`; } } this.el.paymentPlan.innerHTML = hasAnyPayment ? content : `<p class="text-center text-slate-400 py-8">Görüntülenecek ödeme bulunmuyor.</p>`; }
            renderHistory(schedule) { this.el.historyList.innerHTML = ''; this.el.historyPagination.innerHTML = ''; const paidMonths = this.userSettings?.paidMonths || {}; const allPaidItems = Object.keys(paidMonths).map(paymentKey => { const paidInfo = paidMonths[paymentKey]; if (typeof paidInfo !== 'object' || !paidInfo.paidDate) return null; const [monthKey, cardId] = paymentKey.split('_'); const card = this.cards.find(c => c.id === cardId); const amount = schedule[monthKey]?.details[cardId]?.amount || 0; if (!card || amount <= 0) return null; return { cardName: card.cardName, amount: amount, key: paymentKey, paidDate: paidInfo.paidDate, month: monthKey }; }).filter(Boolean).sort((a, b) => dayjs(b.paidDate).valueOf() - dayjs(a.paidDate).valueOf()); if (allPaidItems.length === 0) { this.el.historyList.innerHTML = '<p class="text-center text-slate-400 py-8">Henüz ödenmiş harcama yok.</p>'; return; } const totalPages = Math.ceil(allPaidItems.length / HISTORY_ITEMS_PER_PAGE); this.historyCurrentPage = Math.max(1, Math.min(this.historyCurrentPage, totalPages)); const startIndex = (this.historyCurrentPage - 1) * HISTORY_ITEMS_PER_PAGE; const pageItems = allPaidItems.slice(startIndex, startIndex + HISTORY_ITEMS_PER_PAGE); this.el.historyList.innerHTML = `<div class="space-y-4">${pageItems.map(item => `<div class="bg-slate-700/50 p-4 rounded-lg"><div class="flex justify-between items-start"><div><p class="font-semibold text-white">${item.cardName}</p><p class="text-sm" style="color:var(--primary-text-color);">${dayjs(item.month).format('MMMM YYYY')} Ekstresi</p></div><span class="font-semibold text-xl text-green-400">${formatCurrency(item.amount, this.userSettings.privacyMode)}</span></div><div class="flex justify-between items-center mt-3 pt-3 border-t border-slate-600/50"><p class="text-xs text-slate-400">Ödendi: ${dayjs(item.paidDate).format('DD MMMM YYYY, dddd')}</p><button data-key="${item.key}" class="undo-pay-btn text-xs text-slate-500 hover:text-white">[Geri Al]</button></div></div>`).join('')}</div>`; if (totalPages > 1) { this.el.historyPagination.innerHTML = `<button id="history-prev-btn" class="px-4 py-2 text-sm font-medium text-white bg-slate-600 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" ${this.historyCurrentPage === 1 ? 'disabled' : ''}>Geri</button><span class="text-sm text-slate-400">Sayfa ${this.historyCurrentPage} / ${totalPages}</span><button id="history-next-btn" class="px-4 py-2 text-sm font-medium text-white bg-slate-600 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" ${this.historyCurrentPage === totalPages ? 'disabled' : ''}>İleri</button>`; } }
            renderCategoryChart() { const ctx = this.el.categoryChartCanvas.getContext('2d'); if (this.categoryChartInstance) this.categoryChartInstance.destroy(); if (this.userSettings.privacyMode) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.font = "16px Inter"; ctx.fillStyle = '#94a3b8'; ctx.textAlign = "center"; ctx.fillText("Veriler Gizlilik Modu'nda gizlenmiştir.", ctx.canvas.width / 2, ctx.canvas.height / 2); return; } const categoryTotals = this.purchases.reduce((acc, p) => { acc[p.category || 'Diğer'] = (acc[p.category || 'Diğer'] || 0) + parseFloat(p.totalAmount); return acc; }, {}); const labels = Object.keys(categoryTotals); const data = Object.values(categoryTotals); if (labels.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.font = "16px Inter"; ctx.fillStyle = '#94a3b8'; ctx.textAlign = "center"; ctx.fillText("Gösterilecek harcama verisi yok.", ctx.canvas.width / 2, ctx.canvas.height / 2); return; } this.categoryChartInstance = new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ label: 'Harcama Dağılımı', data, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef'], borderColor: '#1f2937', borderWidth: 2 }] }, options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#e2e8f0' } } } } }); }
            renderSummary(schedule) { let thisMonthPayment = 0; let totalDebt = 0; let nextDueDateInfo = null; let nextStatementDateInfo = null; const today = dayjs(); const paidMonths = this.userSettings?.paidMonths || {}; Object.entries(schedule).forEach(([monthKey, monthData]) => { Object.entries(monthData.details).forEach(([cardId, cardData]) => { if (!paidMonths[`${monthKey}_${cardId}`]) { const amount = cardData.amount; const dueDate = dayjs(cardData.dueDate); totalDebt += amount; if (dueDate.format('YYYY-MM') === today.format('YYYY-MM')) thisMonthPayment += amount; if (dueDate.isAfter(today) && (!nextDueDateInfo || dueDate.isBefore(nextDueDateInfo.date))) { nextDueDateInfo = { date: dueDate, cardName: this.cards.find(c => c.id === cardId)?.cardName || 'Bilinmeyen Kart' }; } } }); }); this.cards.forEach(card => { const statementDay = parseInt(card.statementDay); if (isNaN(statementDay)) return; let nextStatementDate = today.date(statementDay); if (today.isSameOrAfter(nextStatementDate, 'day')) nextStatementDate = nextStatementDate.add(1, 'month'); if (!nextStatementDateInfo || nextStatementDate.isBefore(nextStatementDateInfo.date)) nextStatementDateInfo = { date: nextStatementDate, cardName: card.cardName }; }); this.el.summaryPanel.innerHTML = `<h2 class="text-xl font-bold mb-4">Durum Özeti</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"><div><p class="text-sm opacity-80">Bu Ay Kalan Ödeme</p><p class="text-2xl font-bold">${formatCurrency(thisMonthPayment, this.userSettings.privacyMode)}</p></div><div><p class="text-sm opacity-80">En Yakın Son Ödeme</p><p class="text-2xl font-bold">${nextDueDateInfo ? nextDueDateInfo.date.format('DD.MM.YYYY') : '-'}</p><p class="text-xs opacity-80">${nextDueDateInfo ? nextDueDateInfo.cardName : ''}</p></div><div><p class="text-sm opacity-80">En Yakın Kesim Tarihi</p><p class="text-2xl font-bold">${nextStatementDateInfo ? nextStatementDateInfo.date.format('DD.MM.YYYY') : '-'}</p><p class="text-xs opacity-80">${nextStatementDateInfo ? nextStatementDateInfo.cardName : ''}</p></div><div><p class="text-sm opacity-80">Toplam Kalan Borç</p><p class="text-2xl font-bold">${formatCurrency(totalDebt, this.userSettings.privacyMode)}</p></div></div>`; }
            findFirstUnpaidMonth(schedule) { const today = dayjs(); const currentMonthKey = today.format('YYYY-MM'); const sortedMonths = Object.keys(schedule).sort(); for (const monthKey of sortedMonths) if (monthKey >= currentMonthKey && schedule[monthKey].unpaidTotal > 0) return monthKey; const unpaidMonths = sortedMonths.filter(m => schedule[m].unpaidTotal > 0); return unpaidMonths.length > 0 ? unpaidMonths[0] : 'all'; }
            getFirstPaymentMonthKey(purchase) { const card = this.cards.find(c => c.id === purchase.cardId); if (!card) return dayjs().format('YYYY-MM'); const purchaseDate = dayjs(purchase.purchaseDate); const statementDay = parseInt(card.statementDay); let firstStatementDate = purchaseDate.date(statementDay); if (purchaseDate.date() > statementDay) firstStatementDate = firstStatementDate.add(1, 'month'); return firstStatementDate.add(10, 'days').format('YYYY-MM'); }
            updateCardSelects() { document.querySelectorAll('#card-select, #edit-card-select').forEach(select => { if (!select) return; const currentVal = select.value; select.innerHTML = '<option value="">Kart Seçin</option>'; this.cards.forEach(card => select.add(new Option(card.cardName, card.id))); if (this.cards.some(c => c.id === currentVal)) select.value = currentVal; }); }
            populateCategorySelects() { document.querySelectorAll('#purchase-category, #edit-purchase-category, #filter-category').forEach(select => { if (!select) return; const isFilter = select.id === 'filter-category'; select.innerHTML = `<option value="">${isFilter ? 'Tüm Kategoriler' : 'Kategori Seçin'}</option>`; CATEGORIES.forEach(cat => select.add(new Option(cat, cat))); }); }
            populateMonthSelector(schedule, currentSelection) { this.el.planMonthSelector.innerHTML = ''; const allUnpaidMonths = Object.keys(schedule).filter(m => schedule[m].unpaidTotal > 0).sort(); this.el.planMonthSelector.add(new Option('Tüm Aylar', 'all')); allUnpaidMonths.forEach(monthKey => this.el.planMonthSelector.add(new Option(dayjs(monthKey).format('MMMM YYYY'), monthKey))); this.el.planMonthSelector.value = this.el.planMonthSelector.querySelector(`[value="${currentSelection}"]`) ? currentSelection : 'all'; }
            handleQuickReportRange(range) { const endDateInput = document.getElementById('end-date'); const startDateInput = document.getElementById('start-date'); const today = dayjs(); endDateInput.value = today.format('YYYY-MM-DD'); let startDate; if (range === 'week') startDate = today.subtract(7, 'day'); else if (range === 'month') startDate = today.subtract(1, 'month'); else if (range === 'year') startDate = today.subtract(1, 'year'); if (startDate) { startDateInput.value = startDate.format('YYYY-MM-DD'); this.handleGenerateReport(); } }
            handleGenerateReport() { const startDateStr = document.getElementById('start-date').value; const endDateStr = document.getElementById('end-date').value; const outputEl = document.getElementById('report-output'); if (!startDateStr || !endDateStr) { this.showInfoModal('Lütfen bir başlangıç ve bitiş tarihi seçin.', 'Uyarı', 'error'); return; } const startDate = dayjs(startDateStr); const endDate = dayjs(endDateStr); this.currentReportData = this.purchases.filter(p => dayjs(p.purchaseDate).isBetween(startDate, endDate, 'day', '[]')); if (this.currentReportData.length === 0) { outputEl.innerHTML = '<p class="text-center text-slate-400">Seçili tarih aralığında raporlanacak veri bulunamadı.</p>'; return; } let total = 0; let reportHTML = '<div class="space-y-4">'; this.currentReportData.sort((a,b) => dayjs(b.purchaseDate).valueOf() - dayjs(a.purchaseDate).valueOf()).forEach(p => { const card = this.cards.find(c => c.id === p.cardId); total += parseFloat(p.totalAmount); reportHTML += `<div class="bg-slate-700 p-4 rounded-lg"><p class="font-semibold">${p.purchaseName}</p><p class="text-sm text-slate-300">${p.category || 'Diğer'} - ${formatCurrency(p.totalAmount, this.userSettings.privacyMode)}</p><p class="text-xs text-slate-400">${dayjs(p.purchaseDate).format('DD.MM.YYYY')} - ${card?.cardName || 'Bilinmeyen'}</p></div>`; }); reportHTML += `</div><div class="mt-6 text-right font-bold text-xl">Toplam Harcama: ${formatCurrency(total, this.userSettings.privacyMode)}</div><div class="mt-4 flex justify-end"><button id="export-pdf-btn" class="bg-red-600 text-white py-2 px-4 rounded-md font-semibold">PDF İndir</button></div>`; outputEl.innerHTML = reportHTML; }
            exportReportAsPDF() { if (this.currentReportData.length === 0) { this.showInfoModal('PDF oluşturmak için raporlanacak veri yok.', 'Uyarı'); return; } const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.addFont('//cdnjs.cloudflare.com/ajax/libs/js-pdf/1.3.2/jspdf.plugin.standard_fonts_metrics.js', 'Arial', 'normal'); doc.setFont('Arial'); doc.setFontSize(18); doc.text("Harcama Raporu", 14, 22); doc.setFontSize(11); const startDate = document.getElementById('start-date').value; const endDate = document.getElementById('end-date').value; doc.text(`Tarih Aralığı: ${dayjs(startDate).format('DD.MM.YYYY')} - ${dayjs(endDate).format('DD.MM.YYYY')}`, 14, 30); const tableColumn = ["Tarih", "Aciklama", "Kategori", "Kart", "Tutar (TL)"]; const tableRows = []; let totalAmount = 0; this.currentReportData.forEach(p => { const card = this.cards.find(c => c.id === p.cardId); const purchaseAmount = parseFloat(p.totalAmount); tableRows.push([dayjs(p.purchaseDate).format('DD.MM.YYYY'), p.purchaseName, p.category || 'Diger', card ? card.cardName : 'Bilinmiyor', purchaseAmount.toFixed(2)]); totalAmount += purchaseAmount; }); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 35, theme: 'grid', headStyles: { fillColor: [109, 40, 217] }, }); doc.setFontSize(12); doc.text(`Toplam Harcama: ${totalAmount.toFixed(2)} TL`, 14, doc.lastAutoTable.finalY + 15); doc.save(`harcama-raporu-${dayjs().format('YYYY-MM-DD')}.pdf`); }
            handleDeleteAllData() { this.showConfirmModal('<b>Bu işlem KESİNLİKLE GERİ ALINAMAZ.</b><br><br>Tüm kart ve harcama verileriniz kalıcı olarak silinecektir. Devam etmek istediğinizden emin misiniz?', 'Tüm Verileri Sil', async () => { if(!this.currentUser) return; const batch = writeBatch(this.db); this.cards.forEach(c => batch.delete(doc(this.db, 'users', this.currentUser.uid, 'cards', c.id))); this.purchases.forEach(p => batch.delete(doc(this.db, 'users', this.currentUser.uid, 'purchases', p.id))); await batch.commit(); this.showInfoModal('Tüm verileriniz başarıyla silindi.', 'Başarılı', 'success'); }, 'EVET, TÜMÜNÜ SİL', 'İptal'); }
            async handleConfirmDelete(id, type) { if(!this.currentUser) return; if (type === 'card') { const batch = writeBatch(this.db); batch.delete(doc(this.db, 'users', this.currentUser.uid, 'cards', id)); const associatedPurchases = this.purchases.filter(p => p.cardId === id); associatedPurchases.forEach(p => batch.delete(doc(this.db, 'users', this.currentUser.uid, 'purchases', p.id))); await batch.commit(); } else if(type === 'purchase') { await deleteDoc(doc(this.db, 'users', this.currentUser.uid, 'purchases', id)); } this.closeModal(); }
            async handleCancelSubscription(id) { const purchase = this.purchases.find(p => p.id === id); if(!purchase || !this.currentUser) return; this.showConfirmModal(`"${purchase.purchaseName}" aboneliğini iptal etmek istediğinize emin misiniz? Bu işlem harcamayı silmez, sadece tekrarlama özelliğini kapatır.`, 'Abonelik İptali', async () => { await updateDoc(doc(this.db, 'users', this.currentUser.uid, 'purchases', id), { isRecurring: false }); }); }

        }

        document.addEventListener('DOMContentLoaded', () => {
            const app = new TaksitApp();
            app.init();
        });

    </script>
</body>
</html>
