<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>MAK Taksit Asistanı</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6d28d9">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/6d28d9/ffffff?text=MAK">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrBefore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrAfter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/localizedFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/tr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary-color: #6d28d9; --primary-color-light: #8b5cf6; --primary-text-color: #a78bfa; --summary-grad-from: #6d28d9; --summary-grad-to: #8b5cf6; }
        html.theme-blue { --primary-color: #2563eb; --primary-color-light: #3b82f6; --primary-text-color: #60a5fa; --summary-grad-from: #2563eb; --summary-grad-to: #3b82f6; }
        html.theme-green { --primary-color: #16a34a; --primary-color-light: #22c55e; --primary-text-color: #4ade80; --summary-grad-from: #16a34a; --summary-grad-to: #22c55e; }
        body { font-family: 'Inter', sans-serif; padding-bottom: 80px; }
        html.dark { color-scheme: dark; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 40; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; max-height: 90vh; overflow-y: auto; }
        .main-panel { display: none; }
        .main-panel.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        .bottom-nav-btn { transition: all 0.2s ease-in-out; }
        .bottom-nav-btn.active { color: var(--primary-text-color); background-color: #374151; }
        .summary-card { background: linear-gradient(135deg, var(--summary-grad-from), var(--summary-grad-to)); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }
        .item-fade-out { animation: fadeOut 0.3s ease-out forwards; }
        .hidden { display: none; }
        
        /* Onboarding Stilleri */
        #onboarding-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9998; display: none; }
        #onboarding-tooltip { position: fixed; z-index: 9999; background-color: #374151; color: white; padding: 1rem; border-radius: 0.5rem; max-width: 300px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); display: none; border: 1px solid var(--primary-color); }
        .onboarding-highlight { z-index: 9999; position: relative; box-shadow: 0 0 0 4px var(--primary-color); border-radius: 0.5rem; transition: box-shadow 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-slate-200 transition-colors duration-300">

    <div id="auth-container" class="flex items-center justify-center h-screen">
        <div class="text-center p-8 bg-slate-800 rounded-2xl shadow-2xl max-w-sm mx-auto">
            <h1 class="text-3xl font-bold text-white">MAK Taksit Asistanı</h1>
            <p class="text-slate-400 mt-2 mb-8">Harcamalarınızı yönetmek için giriş yapın.</p>
            <button id="login-btn" class="w-full bg-white text-gray-800 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-3 hover:bg-gray-200 transition-colors">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Google ile Giriş Yap
            </button>
        </div>
    </div>
    
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl hidden">
        <header class="mb-8">
             <div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">MAK Taksit Asistanı</h1>
                <p id="welcome-message" class="text-gray-600 dark:text-slate-400 mt-2">Yükleniyor...</p>
            </div>
        </header>

        <main id="main-content">
            <div id="panel-home" class="main-panel active space-y-8">
                <div id="summary-panel" class="summary-card text-white p-6 rounded-2xl shadow-lg"></div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                        <h2 class="text-xl font-bold dark:text-white">Aylık Ödeme Planı</h2>
                        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                           <select id="plan-month-selector" class="w-full sm:w-auto px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-sm"></select>
                           <button id="export-calendar-btn" class="text-sm bg-teal-600 hover:bg-teal-700 text-white font-semibold px-3 py-2 rounded-md flex items-center justify-center gap-2">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                               Takvime Aktar
                           </button>
                        </div>
                    </div>
                    <div id="payment-plan"></div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold dark:text-white">Harcama Dağılımı</h2>
                        <div id="chart-type-selector" class="flex rounded-lg bg-slate-700 p-1 text-sm">
                            <button data-type="pie" class="chart-type-btn active bg-slate-900 text-white px-3 py-1 rounded-md">Pasta</button>
                            <button data-type="bar" class="chart-type-btn text-slate-300 px-3 py-1 rounded-md">Çubuk</button>
                        </div>
                    </div>
                    <div class="max-w-sm mx-auto"><canvas id="categoryChart"></canvas></div>
                </div>
            </div>

            <div id="panel-purchases" class="main-panel space-y-8">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Yeni Harcama Ekle</h2>
                    <form id="add-purchase-form" class="space-y-4">
                       <input type="text" id="purchase-name" placeholder="Harcama Açıklaması" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required>
                       <select id="purchase-category" class="mt-1 block w-full pl-3 pr-10 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required></select>
                       <input type="date" id="purchase-date" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required>
                       <input type="number" id="total-amount" step="0.01" min="0.01" placeholder="Toplam Tutar (₺)" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required>
                       <input type="number" id="installments-count" min="1" placeholder="Taksit Sayısı" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required>
                        <div>
                            <label for="first-installment-month" class="block text-sm font-medium text-slate-300">İlk Taksit Ayı (İsteğe Bağlı)</label>
                            <input type="month" id="first-installment-month" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700">
                            <p class="text-xs text-slate-500 mt-1">Boş bırakırsanız, harcama tarihine göre otomatik hesaplanır.</p>
                        </div>
                       <select id="card-select" class="mt-1 block w-full pl-3 pr-10 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required><option value="">Kart Seçin</option></select>
                       <div class="flex items-center">
                           <input id="purchase-recurring" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                           <label for="purchase-recurring" class="ml-2 block text-sm text-gray-900 dark:text-slate-300">Aylık Tekrarla (Fatura, Abonelik vb.)</label>
                        </div>
                       <button type="submit" class="w-full text-white py-2 px-4 rounded-md font-semibold transition-colors" style="background-color: var(--primary-color);">Harcamayı Ekle</button>
                    </form>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Kayıtlı Harcamalarınız</h2>
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <input type="text" id="search-input" placeholder="Harcama ara..." class="flex-grow px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700">
                        <select id="filter-category" class="px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700"></select>
                        <select id="filter-card" class="px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700"></select>
                    </div>
                    <div id="purchase-list-details" class="space-y-4"></div>
                </div>
            </div>

            <div id="panel-debts" class="main-panel space-y-8">
                 <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Yeni Borç Ekle</h2>
                    <form id="add-debt-form" class="space-y-4">
                       <input type="text" id="debt-name" placeholder="Borç Açıklaması (Örn: Ev Kredisi)" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required>
                       <input type="number" id="debt-total-amount" step="0.01" min="0" placeholder="Toplam Borç Tutarı (₺)" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required>
                       <input type="number" id="debt-monthly-payment" step="0.01" min="0" placeholder="Aylık Ödeme (₺)" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required>
                        <label for="debt-due-day" class="block text-sm font-medium text-slate-300">Her Ayın Kaçında Ödenecek?</label>
                       <input type="number" id="debt-due-day" min="1" max="31" placeholder="Örn: 15" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700" required>
                       <button type="submit" class="w-full text-white py-2 px-4 rounded-md font-semibold transition-colors" style="background-color: var(--primary-color);">Borcu Ekle</button>
                    </form>
                </div>
                 <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Borçlarınız</h2>
                    <div id="debt-list" class="space-y-4"></div>
                </div>
            </div>

            <div id="panel-history" class="main-panel space-y-8">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Ödeme Geçmişi</h2>
                    <p class="text-sm text-slate-400 mb-6">"Ödendi" olarak işaretlediğiniz tüm ekstreleriniz burada listelenir.</p>
                    <div id="history-list" class="space-y-4"></div>
                    <div id="history-pagination" class="flex justify-between items-center mt-6"></div>
                </div>
            </div>

            <div id="panel-reports" class="main-panel space-y-8">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Tarihe Göre Raporla</h2>
                    <div class="flex gap-2 mb-4">
                        <button data-range="week" class="quick-range-btn flex-1 bg-slate-700 text-white py-2 px-4 rounded-md hover:bg-slate-600 font-semibold transition-colors text-sm">Son 1 Hafta</button>
                        <button data-range="month" class="quick-range-btn flex-1 bg-slate-700 text-white py-2 px-4 rounded-md hover:bg-slate-600 font-semibold transition-colors text-sm">Son 1 Ay</button>
                        <button data-range="year" class="quick-range-btn flex-1 bg-slate-700 text-white py-2 px-4 rounded-md hover:bg-slate-600 font-semibold transition-colors text-sm">Son 1 Yıl</button>
                    </div>
                    <div class="flex flex-col md:flex-row gap-4 items-end">
                        <div>
                            <label for="start-date" class="text-sm font-medium">Başlangıç Tarihi</label>
                            <input type="date" id="start-date" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700">
                        </div>
                        <div>
                            <label for="end-date" class="text-sm font-medium">Bitiş Tarihi</label>
                            <input type="date" id="end-date" class="mt-1 block w-full px-3 py-2 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-700">
                        </div>
                        <button id="generate-report-btn" class="w-full md:w-auto bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 font-semibold transition-colors">Rapor Oluştur</button>
                    </div>
                    <div id="report-output" class="mt-6">
                        <div id="report-list" class="space-y-4"></div>
                        <div id="report-summary" class="mt-6 text-right font-bold text-xl"></div>
                        <div id="report-pagination" class="flex justify-between items-center mt-6"></div>
                        <div id="report-export" class="mt-4 flex justify-end"></div>
                    </div>
                </div>
            </div>

            <div id="panel-settings" class="main-panel space-y-8">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                     <h2 class="text-xl font-bold mb-4 dark:text-white">Tema Seçenekleri</h2>
                     <div class="flex items-center gap-4">
                         <div id="theme-selector" class="flex gap-4">
                            <button data-theme="" class="w-14 h-10 rounded-lg border-2 border-slate-400 flex overflow-hidden" title="Mor Tema"><span class="w-1/3 h-full" style="background-color: #6d28d9;"></span><span class="w-1/3 h-full" style="background-color: #8b5cf6;"></span><span class="w-1/3 h-full" style="background-color: #a78bfa;"></span></button>
                            <button data-theme="theme-blue" class="w-14 h-10 rounded-lg border-2 border-slate-400 flex overflow-hidden" title="Mavi Tema"><span class="w-1/3 h-full" style="background-color: #2563eb;"></span><span class="w-1/3 h-full" style="background-color: #3b82f6;"></span><span class="w-1/3 h-full" style="background-color: #60a5fa;"></span></button>
                            <button data-theme="theme-green" class="w-14 h-10 rounded-lg border-2 border-slate-400 flex overflow-hidden" title="Yeşil Tema"><span class="w-1/3 h-full" style="background-color: #16a34a;"></span><span class="w-1/3 h-full" style="background-color: #22c55e;"></span><span class="w-1/3 h-full" style="background-color: #4ade80;"></span></button>
                         </div>
                         <div class="border-l border-slate-600 pl-4">
                            <label for="custom-theme-picker" class="block text-sm font-medium text-slate-400 mb-2">Özel Renk</label>
                            <input type="color" id="custom-theme-picker" class="w-14 h-10 p-1 bg-slate-700 rounded-lg cursor-pointer">
                        </div>
                     </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Kartlarınızı Yönetin</h2>
                    <form id="add-card-form" class="space-y-4">
                        <input type="text" id="card-name" placeholder="Kart Adı (Örn: Maaş Kartım)" class="w-full px-3 py-2 border border-slate-600 rounded-md bg-slate-700" required>
                        <input type="number" id="statement-day" min="1" max="31" placeholder="Ekstre Kesim Günü (1-31)" class="w-full px-3 py-2 border border-slate-600 rounded-md bg-slate-700" required>
                        <input type="number" id="card-limit" min="0" placeholder="Kart Limiti (₺)" class="w-full px-3 py-2 border border-slate-600 rounded-md bg-slate-700" required>
                        <button type="submit" class="w-full text-white py-2 px-4 rounded-md font-semibold transition-colors" style="background-color: var(--primary-color);">Kart Ekle</button>
                    </form>
                    <div id="card-list" class="mt-6 space-y-4"></div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Veri Yedekleme ve Geri Yükleme</h2>
                    <p class="text-sm text-slate-400 mb-4">Verilerinizi JSON dosyası olarak yedekleyin veya daha önceki bir yedeği geri yükleyin.</p>
                    <div class="space-y-2">
                        <button id="backup-data-btn" class="w-full bg-sky-600 text-white py-2 px-4 rounded-md hover:bg-sky-700 font-semibold transition-colors">Verileri Yedekle</button>
                        <button id="restore-data-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 font-semibold transition-colors">Yedekten Geri Yükle</button>
                    </div>
                    <input type="file" id="restore-file-input" class="hidden" accept="application/json">
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Gizlilik</h2>
                    <div class="flex items-center justify-between">
                        <div>
                            <label for="privacy-mode-toggle" class="font-medium text-white">Gizlilik Modu</label>
                            <p class="text-sm text-slate-400 mt-1">Uygulamadaki tüm finansal tutarları gizler.</p>
                        </div>
                        <label for="privacy-mode-toggle" class="relative inline-flex items-center cursor-pointer"><input type="checkbox" value="" id="privacy-mode-toggle" class="sr-only peer"><div class="w-11 h-6 bg-slate-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-800 peer-checked:bg-violet-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div></label>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">Hesap Yönetimi</h2>
                    <div class="space-y-4">
                        <button id="logout-btn" class="w-full bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700 font-semibold transition-colors">Çıkış Yap</button>
                        <div class="border-t border-slate-600 !mt-6 !mb-2"></div>
                         <button id="delete-all-data-btn" class="w-full bg-red-800 text-white py-2 px-4 rounded-md hover:bg-red-900 font-semibold transition-colors">TÜM VERİLERİ SİL</button>
                         <p class="text-xs text-slate-500 text-center">Bu işlem geri alınamaz. Tüm verileriniz kalıcı olarak silinir.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 shadow-lg z-30 hidden">
        <nav class="flex justify-around items-center h-16 max-w-7xl mx-auto px-1">
            <button data-panel="home" class="bottom-nav-btn active flex flex-col items-center justify-center text-slate-400 w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg><span class="text-xs mt-1">Ana Sayfa</span></button>
            <button data-panel="purchases" class="bottom-nav-btn flex flex-col items-center justify-center text-slate-400 w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg><span class="text-xs mt-1">Harcamalar</span></button>
            <button data-panel="debts" class="bottom-nav-btn flex flex-col items-center justify-center text-slate-400 w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 8h6m-5 4h.01M4.882 16.118A2.25 2.25 0 006.75 18H17.25a2.25 2.25 0 001.868-1.882l-2.024-7.084A2.25 2.25 0 0015.226 7H8.774a2.25 2.25 0 00-1.868 2.034L4.882 16.118z" /></svg><span class="text-xs mt-1">Borçlar</span></button>
            <button data-panel="history" class="bottom-nav-btn flex flex-col items-center justify-center text-slate-400 w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span class="text-xs mt-1">Geçmiş</span></button>
            <button data-panel="reports" class="bottom-nav-btn flex flex-col items-center justify-center text-slate-400 w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg><span class="text-xs mt-1">Raporlar</span></button>
            <button data-panel="settings" class="bottom-nav-btn flex flex-col items-center justify-center text-slate-400 w-full h-full rounded-lg m-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span class="text-xs mt-1">Ayarlar</span></button>
        </nav>
    </footer>

    <!-- Modals -->
    <div id="delete-confirm-modal-backdrop" class="modal-backdrop"></div>
    <div id="delete-confirm-modal" class="modal bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full"></div>
    <div id="edit-purchase-modal-backdrop" class="modal-backdrop"></div>
    <div id="edit-purchase-modal" class="modal bg-slate-800 p-6 rounded-2xl shadow-xl max-w-lg w-full"></div>
    <div id="edit-card-modal-backdrop" class="modal-backdrop"></div>
    <div id="edit-card-modal" class="modal bg-slate-800 p-6 rounded-2xl shadow-xl max-w-lg w-full"></div>
    <div id="info-modal-backdrop" class="modal-backdrop"></div>
    <div id="info-modal" class="modal bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full"></div>

    <!-- Onboarding / Yeni Kullanıcı Turu -->
    <div id="onboarding-overlay"></div>
    <div id="onboarding-tooltip">
        <p id="onboarding-text" class="mb-4"></p>
        <div class="flex justify-between items-center">
            <span id="onboarding-step" class="text-xs text-slate-400"></span>
            <div>
                <button id="onboarding-skip" class="text-sm text-slate-400 hover:text-white mr-4">Atla</button>
                <button id="onboarding-next" class="bg-violet-600 text-white py-1 px-3 rounded-md text-sm">İleri</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase SDK'larını içe aktar
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, writeBatch, serverTimestamp, query, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE KURULUMU ---
        const firebaseConfig = {
            apiKey: "AIzaSyA0ZOlfP0egAypBwBI2UR0QhoobDRVF_Ew",
            authDomain: "mak-taksit-asistani-394e8.firebaseapp.com",
            projectId: "mak-taksit-asistani-394e8",
            storageBucket: "mak-taksit-asistani-394e8.appspot.com",
            messagingSenderId: "27410630069",
            appId: "1:27410630069:web:29c69ce5395944708805fc"
        };
        
        // --- UYGULAMA BAŞLANGICI ---
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            document.addEventListener('DOMContentLoaded', () => {
                dayjs.extend(window.dayjs_plugin_customParseFormat);
                dayjs.extend(window.dayjs_plugin_isSameOrBefore);
                dayjs.extend(window.dayjs_plugin_isSameOrAfter);
                dayjs.extend(window.dayjs_plugin_localizedFormat);
                dayjs.locale('tr');
                
                // --- STATE (DURUM) DEĞİŞKENLERİ ---
                let cards = [];
                let purchases = [];
                let debts = [];
                let userSettings = {};
                let currentUser = null;
                let unsubscribeCards, unsubscribePurchases, unsubscribeSettings, unsubscribeDebts;
                let historyCurrentPage = 1;
                const HISTORY_ITEMS_PER_PAGE = 5;
                let reportCurrentPage = 1;
                const REPORT_ITEMS_PER_PAGE = 10;
                let currentReportData = [];
                const CATEGORIES = ['Gıda', 'Fatura', 'Ulaşım', 'Giyim', 'Eğlence', 'Sağlık', 'Ev Eşyası', 'Dijital Servis', 'Kira', 'Eğitim', 'Diğer'];
                const CATEGORY_KEYWORDS = { 'Gıda': ['market', 'yemek', 'migros', 'carrefour', 'bim', 'a101', 'şok', 'restaurant', 'restoran', 'kafe'], 'Ulaşım': ['benzin', 'mazot', 'opet', 'shell', 'petrol ofisi', 'otobüs', 'bilet', 'taksi'], 'Fatura': ['turkcell', 'vodafone', 'telekom', 'internet', 'elektrik', 'su', 'doğalgaz'], 'Dijital Servis': ['netflix', 'spotify', 'youtube', 'disney', 'google play', 'apple store'], 'Giyim': ['zara', 'mango', 'lc waikiki', 'koton', 'ayakkabı'] };
                let categoryChartInstance = null;
                let itemToDelete = {};
                let confirmCallback = null;
                let selectedPlanMonth = null;

                // --- DOM ELEMENTLERİ (İlgili referanslar kaldırıldı) ---
                const el = {
                    authContainer: document.getElementById('auth-container'),
                    appContainer: document.getElementById('app-container'),
                    bottomNav: document.getElementById('bottom-nav'),
                    loginBtn: document.getElementById('login-btn'),
                    logoutBtn: document.getElementById('logout-btn'),
                    welcomeMessage: document.getElementById('welcome-message'),
                    infoModal: document.getElementById('info-modal'),
                    infoModalBackdrop: document.getElementById('info-modal-backdrop'),
                    deleteConfirmModal: document.getElementById('delete-confirm-modal'),
                    deleteConfirmBackdrop: document.getElementById('delete-confirm-modal-backdrop'),
                    editPurchaseModal: document.getElementById('edit-purchase-modal'),
                    editPurchaseBackdrop: document.getElementById('edit-purchase-modal-backdrop'),
                    editCardModal: document.getElementById('edit-card-modal'),
                    editCardBackdrop: document.getElementById('edit-card-modal-backdrop'),
                    cardList: document.getElementById('card-list'),
                    debtList: document.getElementById('debt-list'),
                    purchaseList: document.getElementById('purchase-list-details'),
                    paymentPlan: document.getElementById('payment-plan'),
                    historyList: document.getElementById('history-list'),
                    historyPagination: document.getElementById('history-pagination'),
                    summaryPanel: document.getElementById('summary-panel'),
                    categoryChartCanvas: document.getElementById('categoryChart'),
                    purchaseDateInput: document.getElementById('purchase-date'),
                    purchaseNameInput: document.getElementById('purchase-name'),
                    purchaseCategorySelect: document.getElementById('purchase-category'),
                    planMonthSelector: document.getElementById('plan-month-selector'),
                    privacyModeToggle: document.getElementById('privacy-mode-toggle'),
                    customThemePicker: document.getElementById('custom-theme-picker'),
                    restoreFileInput: document.getElementById('restore-file-input'),
                    reportList: document.getElementById('report-list'),
                    reportPagination: document.getElementById('report-pagination'),
                    reportSummary: document.getElementById('report-summary'),
                    reportExport: document.getElementById('report-export'),
                    onboardingOverlay: document.getElementById('onboarding-overlay'),
                    onboardingTooltip: document.getElementById('onboarding-tooltip'),
                    onboardingText: document.getElementById('onboarding-text'),
                    onboardingStep: document.getElementById('onboarding-step'),
                    onboardingSkip: document.getElementById('onboarding-skip'),
                    onboardingNext: document.getElementById('onboarding-next'),
                };

                // Kalan kodun tamamı, yatırım modülü ile ilgili tüm referanslar, fonksiyonlar ve HTML elementleri çıkarılarak güncellendi.
                // Bu kodun devamı, bir önceki versiyondaki gibidir, sadece yatırım ile ilgili kısımlar silinmiştir.
                // Örnek olarak, `listenToData` fonksiyonu artık `investments` koleksiyonunu dinlemiyor.
                // `handleFormSubmits` ve `handleBodyClicks` fonksiyonlarından yatırım ile ilgili tüm koşullar ve eylemler kaldırıldı.
                // `handleConfirmDelete` fonksiyonundan yatırım silme mantığı çıkarıldı.
                // Tüm bu değişiklikler, kodun bütünlüğünü koruyarak istenen geri alma işlemini gerçekleştirir.
                
                 // --- KİMLİK DOĞRULAMA (AUTHENTICATION) ---
                onAuthStateChanged(auth, user => {
                    if (user) {
                        currentUser = user;
                        el.authContainer.classList.add('hidden');
                        el.appContainer.classList.remove('hidden');
                        el.bottomNav.classList.remove('hidden');
                        el.welcomeMessage.textContent = `Hoşgeldin, ${user.displayName || 'Kullanıcı'}!`;
                        listenToData(user.uid);
                    } else {
                        currentUser = null;
                        el.authContainer.classList.remove('hidden');
                        el.appContainer.classList.add('hidden');
                        el.bottomNav.classList.add('hidden');
                        if (unsubscribeCards) unsubscribeCards();
                        if (unsubscribePurchases) unsubscribePurchases();
                        if (unsubscribeSettings) unsubscribeSettings();
                        if (unsubscribeDebts) unsubscribeDebts();
                        cards = []; purchases = []; userSettings = {}; debts = [];
                    }
                });

                el.loginBtn.addEventListener('click', async () => {
                    const provider = new GoogleAuthProvider();
                    try { await signInWithPopup(auth, provider); } catch (error) { console.error("Giriş hatası:", error); showInfoModal(`Google ile giriş sırasında bir hata oluştu: ${error.message}`, 'Giriş Hatası', 'error');}
                });

                el.logoutBtn.addEventListener('click', async () => {
                    try { await signOut(auth); } catch (error) { console.error("Çıkış hatası:", error); }
                });

                // --- VERİ DİNLEME (FIRESTORE REAL-TIME) ---
                function listenToData(userId) {
                    const settingsRef = doc(db, 'users', userId, 'settings', 'userProfile');
                    if(unsubscribeSettings) unsubscribeSettings();
                    unsubscribeSettings = onSnapshot(settingsRef, (docSnapshot) => {
                        const hadOnboardingCompleted = userSettings.onboardingCompleted;
                        if (docSnapshot.exists()) {
                            userSettings = docSnapshot.data();
                            if (!hadOnboardingCompleted && !userSettings.onboardingCompleted) { startOnboarding(); }
                        } else {
                            const defaultSettings = { theme: '', customThemeColor: null, privacyMode: false, paidMonths: {}, onboardingCompleted: false };
                            setDoc(settingsRef, defaultSettings);
                            userSettings = defaultSettings;
                            startOnboarding();
                        }
                        applySettings();
                        refreshUI();
                    });

                    const collections = { cards: 'cards', purchases: 'purchases', debts: 'debts' };
                    const unsubscribers = { cards: unsubscribeCards, purchases: unsubscribePurchases, debts: unsubscribeDebts };
                    
                    Object.entries(collections).forEach(([stateKey, collectionName]) => {
                        if (unsubscribers[stateKey]) unsubscribers[stateKey]();
                        const ref = collection(db, 'users', userId, collectionName);
                        unsubscribers[stateKey] = onSnapshot(ref, (snapshot) => {
                            window[stateKey] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            refreshUI();
                        });
                    });
                }
                
                // --- MODAL YÖNETİMİ ---
                function showInfoModal(message, title = 'Bilgi', type = 'info') { const colors = { info: 'indigo', success: 'green', error: 'red' }; const color = colors[type] || 'indigo'; el.infoModal.innerHTML = `<h3 class="text-lg font-medium text-white">${title}</h3><div class="text-sm text-slate-400 mt-4">${message}</div><div class="mt-5 flex justify-end gap-3"><button id="info-modal-ok-btn" class="bg-${color}-600 text-white py-2 px-4 rounded-md">Tamam</button></div>`; el.infoModal.style.display = 'block'; el.infoModalBackdrop.style.display = 'block'; document.getElementById('info-modal-ok-btn').addEventListener('click', hideInfoModal); }
                function showConfirmModal(message, title = 'Onay', callback, confirmText = 'Onayla', cancelText = 'İptal') { el.infoModal.innerHTML = `<h3 class="text-lg font-medium text-white">${title}</h3><div class="text-sm text-slate-400 mt-4">${message}</div><div class="mt-5 flex justify-end gap-3"><button id="info-modal-cancel-btn" class="bg-slate-600 text-slate-200 py-2 px-4 rounded-md">${cancelText}</button><button id="info-modal-confirm-btn" class="bg-green-600 text-white py-2 px-4 rounded-md">${confirmText}</button></div>`; el.infoModal.style.display = 'block'; el.infoModalBackdrop.style.display = 'block'; confirmCallback = callback; document.getElementById('info-modal-cancel-btn').addEventListener('click', hideInfoModal); document.getElementById('info-modal-confirm-btn').addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideInfoModal(); }); }
                function hideInfoModal() { el.infoModal.style.display = 'none'; el.infoModalBackdrop.style.display = 'none'; confirmCallback = null; }
                function openDeleteModal(id, type, name, element) { itemToDelete = { id, type, element }; const modalBody = el.deleteConfirmModal; modalBody.innerHTML = `<div class="flex items-center"><div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-900/50 sm:mx-0 sm:h-10 sm:w-10"><svg class="h-6 w-6 text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg></div><h3 class="ml-4 text-lg font-medium text-white">Silme Onayı</h3></div><p class="text-sm text-slate-400 mt-4 ml-14">"${name}" öğesini silmek istediğinizden emin misiniz? ${type === 'card' ? 'Bu karta ait tüm harcamalar da silinecektir.' : ''}</p><div class="mt-5 flex justify-end gap-3"><button id="cancel-delete-btn" class="bg-slate-600 text-slate-200 py-2 px-4 rounded-md">İptal</button><button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-4 rounded-md">Evet, Sil</button></div>`; el.deleteConfirmModal.style.display = 'block'; el.deleteConfirmBackdrop.style.display = 'block'; }
                function closeDeleteModal() { el.deleteConfirmModal.style.display = 'none'; el.deleteConfirmBackdrop.style.display = 'none'; }
                function openEditCardModal(id) { const card = cards.find(c => c.id === id); if (!card) return; el.editCardModal.innerHTML = `<h2 class="text-xl font-bold mb-4 text-white">Kartı Düzenle</h2><form id="edit-card-form" class="space-y-4"><input type="hidden" id="edit-card-id" value="${card.id}"><label>Kart Adı</label><input type="text" id="edit-card-name" value="${card.cardName}" class="mt-1 block w-full border border-slate-600 rounded-md p-2 bg-slate-700" required><label>Kesim Günü</label><input type="number" id="edit-statement-day" value="${card.statementDay}" class="mt-1 block w-full border border-slate-600 rounded-md p-2 bg-slate-700" required><label>Limit</label><input type="number" id="edit-card-limit" value="${card.cardLimit}" class="mt-1 block w-full border border-slate-600 rounded-md p-2 bg-slate-700" required><div class="mt-6 flex justify-end space-x-3"><button type="button" id="cancel-edit-card-btn" class="bg-slate-600 px-4 py-2 rounded-md">İptal</button><button type="submit" class="text-white px-4 py-2 rounded-md" style="background-color: var(--primary-color);">Kaydet</button></div></form>`; el.editCardModal.style.display = 'block'; el.editCardBackdrop.style.display = 'block'; }
                function closeEditCardModal() { el.editCardModal.style.display = 'none'; el.editCardBackdrop.style.display = 'none'; }
                function openEditPurchaseModal(id) {
                    const p = purchases.find(p => p.id === id); if (!p) return;
                    const firstInstallmentMonthValue = p.firstInstallmentMonth ? `value="${p.firstInstallmentMonth}"` : '';
                    el.editPurchaseModal.innerHTML = `<h2 class="text-xl font-bold mb-4 text-white">Harcamayı Düzenle</h2><form id="edit-purchase-form" class="space-y-4"><input type="hidden" id="edit-purchase-id" value="${p.id}"><label>Açıklama</label><input type="text" id="edit-purchase-name" value="${p.purchaseName}" class="mt-1 block w-full border-slate-600 rounded-md p-2 bg-slate-700" required><label>Kategori</label><select id="edit-purchase-category" class="mt-1 block w-full border-slate-600 rounded-md p-2 bg-slate-700" required></select><label>Tarih</label><input type="date" id="edit-purchase-date" value="${p.purchaseDate}" class="mt-1 block w-full border-slate-600 rounded-md p-2 bg-slate-700" required><label>Tutar</label><input type="number" id="edit-total-amount" step="0.01" value="${p.totalAmount}" class="mt-1 block w-full border-slate-600 rounded-md p-2 bg-slate-700" required><label>Taksit</label><input type="number" id="edit-installments-count" min="1" value="${p.installmentsCount}" class="mt-1 block w-full border-slate-600 rounded-md p-2 bg-slate-700" required><div><label for="edit-first-installment-month" class="block text-sm font-medium">İlk Taksit Ayı</label><input type="month" id="edit-first-installment-month" ${firstInstallmentMonthValue} class="mt-1 block w-full border-slate-600 rounded-md p-2 bg-slate-700"></div><label>Kart</label><select id="edit-card-select" class="mt-1 block w-full border-slate-600 rounded-md p-2 bg-slate-700" required></select><div class="flex items-center mt-4"><input id="edit-purchase-recurring" type="checkbox" ${p.isRecurring ? 'checked' : ''} class="h-4 w-4 rounded"><label for="edit-purchase-recurring" class="ml-2">Aylık Tekrarla</label></div><div class="mt-6 flex justify-end space-x-3"><button type="button" id="cancel-edit-purchase-btn" class="bg-slate-600 px-4 py-2 rounded-md">İptal</button><button type="submit" class="text-white px-4 py-2 rounded-md" style="background-color: var(--primary-color);">Kaydet</button></div></form>`;
                    updateCardSelects(); populateCategorySelects(); document.querySelector('#edit-purchase-form #edit-card-select').value = p.cardId; document.querySelector('#edit-purchase-form #edit-purchase-category').value = p.category || 'Diğer';
                    el.editPurchaseModal.style.display = 'block'; el.editPurchaseBackdrop.style.display = 'block';
                }
                function closeEditPurchaseModal() { el.editPurchaseModal.style.display = 'none'; el.editPurchaseBackdrop.style.display = 'none'; }
                

                // --- YENİ KULLANICI TURU (ONBOARDING) ---
                const onboardingSteps = [
                    { selector: '[data-panel="settings"]', text: 'Hoş geldiniz! Ayarlar menüsünden başlayarak kartlarınızı ekleyebilirsiniz. Buraya tıklayarak ilk kartınızı ekleyelim.' },
                    { selector: '#add-card-form', text: 'Bu formdan kartınızın adını, ekstre kesim gününü ve limitini girerek ekleyebilirsiniz.' },
                    { selector: '[data-panel="purchases"]', text: 'Harika! Şimdi harcamalarınızı eklemek için bu sekmeye geçelim.' },
                    { selector: '#add-purchase-form', text: 'Bu bölümden taksitli veya tek çekim harcamalarınızı girebilirsiniz.' },
                    { selector: '[data-panel="home"]', text: 'Ana sayfa, tüm finansal durumunuzun bir özetini sunar. Ödeme planınızı ve harcama dağılımınızı buradan takip edebilirsiniz.' }
                ];
                let currentStep = 0;

                function showStep(stepIndex) {
                    if (stepIndex >= onboardingSteps.length) { endOnboarding(); return; }
                    const step = onboardingSteps[stepIndex];
                    const targetElement = document.querySelector(step.selector);
                    document.querySelectorAll('.onboarding-highlight').forEach(el => el.classList.remove('onboarding-highlight'));
                    if (targetElement) {
                        const panelId = targetElement.closest('.main-panel')?.id;
                        if(panelId) {
                            const panelName = panelId.replace('panel-', '');
                            document.querySelectorAll('.bottom-nav-btn').forEach(b => b.classList.toggle('active', b.dataset.panel === panelName));
                            document.querySelectorAll('.main-panel').forEach(p => p.classList.toggle('active', p.id === panelId));
                        }
                        targetElement.classList.add('onboarding-highlight');
                        const rect = targetElement.getBoundingClientRect();
                        el.onboardingText.textContent = step.text;
                        el.onboardingStep.textContent = `${stepIndex + 1} / ${onboardingSteps.length}`;
                        el.onboardingTooltip.style.display = 'block';
                        const tooltipHeight = el.onboardingTooltip.offsetHeight;
                        let top = rect.bottom + 10;
                        if(top + tooltipHeight > window.innerHeight) { top = rect.top - tooltipHeight - 10; }
                        const left = rect.left + rect.width / 2 - el.onboardingTooltip.offsetWidth / 2;
                        el.onboardingTooltip.style.top = `${Math.min(top, window.innerHeight - tooltipHeight - 10)}px`;
                        el.onboardingTooltip.style.left = `${Math.max(10, Math.min(left, window.innerWidth - el.onboardingTooltip.offsetWidth - 10))}px`;
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                function startOnboarding() { el.onboardingOverlay.style.display = 'block'; currentStep = 0; showStep(currentStep); }
                function endOnboarding() { el.onboardingOverlay.style.display = 'none'; el.onboardingTooltip.style.display = 'none'; document.querySelectorAll('.onboarding-highlight').forEach(el => el.classList.remove('onboarding-highlight')); updateSettings({ onboardingCompleted: true }); }
                el.onboardingNext.addEventListener('click', () => { currentStep++; showStep(currentStep); });
                el.onboardingSkip.addEventListener('click', endOnboarding);

                // --- AYAR YÖNETİMİ & TEMA ---
                async function updateSettings(settings) { if (!currentUser) return; const settingsRef = doc(db, 'users', currentUser.uid, 'settings', 'userProfile'); try { await setDoc(settingsRef, settings, { merge: true }); } catch(error) { console.error("Ayarlar güncellenirken hata:", error); }}
                function formatCurrency(value) { if (userSettings.privacyMode) return '₺ --,--'; const numberValue = parseFloat(value); return isNaN(numberValue) ? '₺ 0.00' : `₺ ${numberValue.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`; }
                function lightenColor(hex, percent) { let r = parseInt(hex.substring(1, 3), 16); let g = parseInt(hex.substring(3, 5), 16); let b = parseInt(hex.substring(5, 7), 16); r = parseInt(r * (100 + percent) / 100); g = parseInt(g * (100 + percent) / 100); b = parseInt(b * (100 + percent) / 100); r = (r<255)?r:255; g = (g<255)?g:255; b = (b<255)?b:255; const toHex = (c) => ('0'+(c.toString(16))).slice(-2); return `#${toHex(r)}${toHex(g)}${toHex(b)}`; }
                function applyCustomTheme(hexColor) { const root = document.documentElement; root.className = 'dark'; const colorLight = lightenColor(hexColor, 20); const colorText = lightenColor(hexColor, 40); root.style.setProperty('--primary-color', hexColor); root.style.setProperty('--primary-color-light', colorLight); root.style.setProperty('--primary-text-color', colorText); root.style.setProperty('--summary-grad-from', hexColor); root.style.setProperty('--summary-grad-to', colorLight); }
                function applyTheme(themeName) { const root = document.documentElement; root.style.removeProperty('--primary-color'); root.style.removeProperty('--primary-color-light'); root.style.removeProperty('--primary-text-color'); root.style.removeProperty('--summary-grad-from'); root.style.removeProperty('--summary-grad-to'); root.className = `dark ${themeName || ''}`; }
                function applySettings() { if (userSettings.theme === 'custom' && userSettings.customThemeColor) { applyCustomTheme(userSettings.customThemeColor); el.customThemePicker.value = userSettings.customThemeColor; } else { applyTheme(userSettings.theme); } el.privacyModeToggle.checked = userSettings.privacyMode; }
                
                // --- UI GÜNCELLEME FONKSİYONLARI ---
                function refreshUI() {
                    if (!currentUser) return;
                    const paymentSchedule = calculatePaymentSchedule();
                    if (selectedPlanMonth === null) { selectedPlanMonth = findDefaultPaymentMonth(paymentSchedule); }
                    populateMonthSelector(paymentSchedule, selectedPlanMonth);
                    renderSummary(paymentSchedule);
                    renderPaymentPlan(paymentSchedule, selectedPlanMonth);
                    renderHistory(paymentSchedule);
                    renderCategoryChart();
                    renderCards(paymentSchedule); 
                    renderPurchasesList();
                    renderDebts();
                    updateCardSelects();
                    populateCategorySelects();
                    populateCardFilterSelect();
                }
                
                function populateMonthSelector(schedule, currentSelection) {
                    if (!el.planMonthSelector) return;
                    const oldValue = el.planMonthSelector.value;
                    el.planMonthSelector.innerHTML = ''; 
                    const allUnpaidMonths = Object.keys(schedule).filter(m => schedule[m].unpaidTotal > 0).sort();
                    allUnpaidMonths.forEach(monthKey => { el.planMonthSelector.add(new Option(dayjs(monthKey).format('MMMMYYYY'), monthKey)); });
                    el.planMonthSelector.add(new Option('Tüm Aylar', 'all'));
                    el.planMonthSelector.value = el.planMonthSelector.querySelector(`[value="${oldValue}"]`) ? oldValue : currentSelection;
                }
                
                function renderCards(paymentSchedule) {
                    if (!el.cardList) return;
                    el.cardList.innerHTML = cards.length === 0 ? `<div class="text-center py-8"><p class="mt-1 text-sm text-slate-400">Başlamak için ilk kartınızı ekleyin!</p></div>` : '';
                    cards.forEach(card => {
                        let totalUnpaidDebt = 0;
                        const paidMonths = userSettings?.paidMonths || {};
                        Object.entries(paymentSchedule).forEach(([monthKey, monthData]) => { if (monthData.details[card.id]) { const paymentKey = `${monthKey}_${card.id}`; if (!paidMonths[paymentKey]) { totalUnpaidDebt += monthData.details[card.id].amount; } } });
                        const remainingLimit = parseFloat(card.cardLimit) - totalUnpaidDebt;
                        const usagePercentage = card.cardLimit > 0 ? (totalUnpaidDebt / card.cardLimit) * 100 : 0;
                        const cardEl = document.createElement('div');
                        cardEl.className = 'bg-slate-700 p-4 rounded-lg border border-slate-600';
                        cardEl.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-semibold text-lg text-white">${card.cardName}</p><p class="text-xs text-slate-400">Kesim: Ayın ${card.statementDay}. günü</p></div><div class="flex items-center space-x-2"><button data-id="${card.id}" class="edit-card-btn text-sm bg-blue-900/50 text-blue-300 font-semibold px-3 py-1 rounded-md hover:bg-blue-800/50">Düzenle</button><button data-id="${card.id}" class="delete-card-btn text-sm bg-red-900/50 text-red-300 font-semibold px-3 py-1 rounded-md hover:bg-red-800/50">Sil</button></div></div><div class="mt-3"><div class="flex justify-between text-xs mb-1"><span class="text-slate-400">Kullanılan: <span class="font-medium text-white">${formatCurrency(totalUnpaidDebt)}</span></span><span class="text-slate-400">Limit: <span class="font-medium text-white">${formatCurrency(card.cardLimit)}</span></span></div><div class="w-full bg-slate-600 rounded-full h-2.5"><div class="h-2.5 rounded-full" style="width: ${Math.min(usagePercentage, 100)}%; background-color: ${usagePercentage > 90 ? '#ef4444' : usagePercentage > 70 ? '#f97316' : 'var(--primary-color)'};"></div></div><p class="text-right text-xs mt-1 text-green-400">Kalan Limit: <span class="font-bold">${formatCurrency(remainingLimit)}</span></p></div>`;
                        el.cardList.appendChild(cardEl);
                    });
                }

                function renderPurchasesList() {
                    if (!el.purchaseList) return;
                    const searchTerm = document.getElementById('search-input').value.toLowerCase();
                    const category = document.getElementById('filter-category').value;
                    const cardId = document.getElementById('filter-card').value;
                    let filtered = purchases.filter(p => p.purchaseName.toLowerCase().includes(searchTerm) && (category ? p.category === category : true) && (cardId ? p.cardId === cardId : true) );
                    el.purchaseList.innerHTML = filtered.length === 0 ? '<p class="text-sm text-slate-400 text-center py-4">Filtreye uygun harcama yok.</p>' : '';
                    [...filtered].sort((a, b) => new Date(b.purchaseDate) - new Date(a.purchaseDate)).forEach(p => {
                        const card = cards.find(c => c.id === p.cardId);
                        const purchaseEl = document.createElement('div');
                        purchaseEl.className = 'flex justify-between items-center bg-slate-700 p-4 rounded-lg border border-slate-600';
                        const recurringIcon = p.isRecurring ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-2 text-cyan-400" title="Tekrarlayan Harcama" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 12A8 8 0 1013 5.372" /></svg>` : '';
                        purchaseEl.innerHTML = `<div><p class="font-semibold text-white">${p.purchaseName}${recurringIcon}</p><p class="text-sm text-slate-300"><span class="font-medium" style="color:var(--primary-text-color);">${p.category || 'Diğer'}</span> - ${formatCurrency(p.totalAmount / p.installmentsCount)} x ${p.installmentsCount} Taksit</p><p class="text-xs text-slate-400">Tarih: ${dayjs(p.purchaseDate).format('DD.MM.YYYY')} | Kart: ${card ? card.cardName : 'Bilinmeyen'}</p></div><div class="flex items-center space-x-2"><button data-id="${p.id}" class="edit-purchase-btn text-sm bg-blue-900/50 text-blue-300 font-semibold px-3 py-1 rounded-md hover:bg-blue-800/50">Düzenle</button><button data-id="${p.id}" class="delete-purchase-btn text-sm bg-red-900/50 text-red-300 font-semibold px-3 py-1 rounded-md hover:bg-red-800/50">Sil</button></div>`;
                        el.purchaseList.appendChild(purchaseEl);
                    });
                }
               
                function renderDebts() {
                    if (!el.debtList) return;
                    el.debtList.innerHTML = debts.length === 0 ? `<p class="text-center py-8 text-sm text-slate-400">Takip ettiğiniz bir borç bulunmuyor.</p>` : '';
                    debts.sort((a,b) => (a.totalAmount - (a.paidAmount || 0)) - (b.totalAmount - (b.paidAmount || 0))).forEach(debt => {
                        const remainingAmount = parseFloat(debt.totalAmount) - (parseFloat(debt.paidAmount) || 0);
                        const progress = debt.totalAmount > 0 ? ((debt.paidAmount || 0) / debt.totalAmount) * 100 : 0;
                        const debtEl = document.createElement('div');
                        debtEl.className = 'bg-slate-700 p-4 rounded-lg border border-slate-600';
                        debtEl.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-semibold text-lg text-white">${debt.debtName}</p><p class="text-xs text-slate-400">Aylık Ödeme: ${formatCurrency(debt.monthlyPayment)} | Sonraki Ödeme: Ayın ${debt.dueDay}. günü</p></div><div class="flex items-center space-x-2"><button data-id="${debt.id}" class="pay-debt-btn text-sm bg-green-900/50 text-green-300 font-semibold px-3 py-1 rounded-md hover:bg-green-800/50">Ödeme Yap</button><button data-id="${debt.id}" class="delete-debt-btn text-sm bg-red-900/50 text-red-300 font-semibold px-3 py-1 rounded-md hover:bg-red-800/50">Sil</button></div></div><div class="mt-3"><div class="w-full bg-slate-600 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width: ${progress}%"></div></div><div class="flex justify-between text-xs mt-1"><span class="text-slate-400">Ödenen: <span class="font-medium text-white">${formatCurrency(debt.paidAmount || 0)}</span></span><span class="text-slate-400">Kalan: <span class="font-medium text-red-400">${formatCurrency(remainingAmount)}</span></span></div></div>`;
                        el.debtList.appendChild(debtEl);
                    });
                }
                
                function calculatePaymentSchedule() {
                    const schedule = {};
                    purchases.forEach(p => {
                        const card = cards.find(c => c.id === p.cardId); if (!card) return;
                        const installmentAmount = parseFloat(p.totalAmount) / parseInt(p.installmentsCount);
                        const statementDay = parseInt(card.statementDay); let firstStatementDate;
                        if (p.firstInstallmentMonth) { firstStatementDate = dayjs(p.firstInstallmentMonth).date(statementDay); } 
                        else { const purchaseDate = dayjs(p.purchaseDate); firstStatementDate = purchaseDate.date(statementDay); if (purchaseDate.date() > statementDay) { firstStatementDate = firstStatementDate.add(1, 'month'); } }
                        for (let i = 0; i < p.installmentsCount; i++) {
                            const currentStatementDate = firstStatementDate.add(i, 'month'); const dueDate = currentStatementDate.add(10, 'days');
                            const paymentMonthKey = dueDate.format('YYYY-MM'); 
                            if (!schedule[paymentMonthKey]) { schedule[paymentMonthKey] = { total: 0, unpaidTotal: 0, details: {} }; }
                            if (!schedule[paymentMonthKey].details[p.cardId]) { schedule[paymentMonthKey].details[p.cardId] = { amount: 0, dueDate: dueDate.format('YYYY-MM-DD'), cardName: card.cardName }; }
                            schedule[paymentMonthKey].details[p.cardId].amount += installmentAmount;
                            schedule[paymentMonthKey].total += installmentAmount;
                            const paymentKey = `${paymentMonthKey}_${p.cardId}`;
                            if (!userSettings?.paidMonths?.[paymentKey]) { schedule[paymentMonthKey].unpaidTotal += installmentAmount; }
                        }
                    });
                    return schedule;
                }
                
                function renderPaymentPlan(schedule, selectedMonthKey) {
                    if (!el.paymentPlan) return;
                    const monthsToRender = selectedMonthKey === 'all' ? Object.keys(schedule).filter(m => schedule[m].unpaidTotal > 0).sort() : (schedule[selectedMonthKey] ? [selectedMonthKey] : []);
                    let content = ''; let hasAnyPayment = false;
                    monthsToRender.forEach((monthKey, index) => {
                        const monthData = schedule[monthKey]; if (!monthData) return; 
                        let monthCardsContent = ''; let unpaidTotalForMonth = 0;
                        Object.keys(monthData.details).forEach(cardId => {
                            const paymentData = monthData.details[cardId];
                            if (paymentData && paymentData.amount > 0) {
                                const paymentKey = `${monthKey}_${cardId}`; const isPaid = userSettings?.paidMonths?.[paymentKey]; if (isPaid) return; 
                                hasAnyPayment = true; unpaidTotalForMonth += paymentData.amount;
                                const dueDate = dayjs(paymentData.dueDate); const lateClass = dayjs().isAfter(dueDate, 'day') ? 'border-red-500/50' : 'border-slate-600';
                                monthCardsContent += `<div class="bg-slate-900/50 p-4 rounded-lg border ${lateClass}"><div class="flex justify-between items-center"><div><p class="font-bold text-white">${paymentData.cardName}</p><p class="text-xs text-slate-400">Son Ödeme: ${dueDate.format('DD MMMM YYYY')}</p></div><p class="text-xl font-semibold text-white">${formatCurrency(paymentData.amount)}</p></div><div class="mt-3 text-right"><button data-key="${paymentKey}" class="pay-btn text-sm bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md w-full sm:w-auto">Ödendi Olarak İşaretle</button></div></div>`;
                            }
                        });
                        if (monthCardsContent) {
                            if (selectedMonthKey === 'all') { content += `<div class="${index > 0 ? 'mt-8' : ''}"><h3 class="text-lg font-semibold text-white border-b border-slate-600 pb-2 mb-4">${dayjs(monthKey).format('MMMM YYYY')}</h3><div class="space-y-4">${monthCardsContent}</div></div>`; } 
                            else { content += `<div class="space-y-4">${monthCardsContent}</div><div class="mt-6 pt-4 border-t border-slate-700 text-right"><p class="text-sm text-slate-300">${dayjs(monthKey).format('MMMM YYYY')} Kalan Toplam Ödeme</p><p class="font-bold text-2xl text-red-500">${formatCurrency(unpaidTotalForMonth)}</p></div>`; }
                        }
                    });
                    el.paymentPlan.innerHTML = !hasAnyPayment ? `<p class="text-center text-slate-400 py-8">Görüntülenecek ödeme bulunmuyor.</p>` : content;
                }
                
                function renderHistory(schedule) { if (!el.historyList || !el.historyPagination) return; const paidMonths = userSettings?.paidMonths || {}; const allPaidItems = Object.keys(paidMonths).map(paymentKey => { const paidInfo = paidMonths[paymentKey]; if (typeof paidInfo !== 'object' || !paidInfo.paidDate) return null; const [monthKey, cardId] = paymentKey.split('_'); const card = cards.find(c => c.id === cardId); const amount = schedule[monthKey]?.details[cardId]?.amount || 0; if (!card || amount <= 0) return null; return { cardName: card.cardName, amount: amount, key: paymentKey, paidDate: paidInfo.paidDate, month: monthKey }; }).filter(item => item !== null).sort((a, b) => dayjs(b.paidDate).valueOf() - dayjs(a.paidDate).valueOf()); if (allPaidItems.length === 0) { el.historyList.innerHTML = '<p class="text-center text-slate-400 py-8">Henüz ödenmiş harcama yok.</p>'; el.historyPagination.innerHTML = ''; return; } const totalPages = Math.ceil(allPaidItems.length / HISTORY_ITEMS_PER_PAGE); historyCurrentPage = Math.max(1, Math.min(historyCurrentPage, totalPages)); const startIndex = (historyCurrentPage - 1) * HISTORY_ITEMS_PER_PAGE; const pageItems = allPaidItems.slice(startIndex, startIndex + HISTORY_ITEMS_PER_PAGE); let content = '<div class="space-y-4">'; pageItems.forEach(item => { content += ` <div class="bg-slate-700/50 p-4 rounded-lg"> <div class="flex justify-between items-start"> <div> <p class="font-semibold text-white">${item.cardName}</p> <p class="text-sm" style="color:var(--primary-text-color);">${dayjs(item.month).format('MMMM YYYY')} Ekstresi</p> </div> <span class="font-semibold text-xl text-green-400">${formatCurrency(item.amount)}</span> </div> <div class="flex justify-between items-center mt-3 pt-3 border-t border-slate-600/50"> <p class="text-xs text-slate-400">Ödendi: ${dayjs(item.paidDate).format('DD MMMM YYYY, dddd')}</p> <button data-key="${item.key}" class="undo-pay-btn text-xs text-slate-500 hover:text-white">[Geri Al]</button> </div> </div>`; }); content += '</div>'; el.historyList.innerHTML = content; let paginationContent = ''; if (totalPages > 1) paginationContent = ` <button id="history-prev-btn" class="px-4 py-2 text-sm font-medium text-white bg-slate-600 rounded-md disabled:opacity-50" ${historyCurrentPage === 1 ? 'disabled' : ''}>Geri</button> <span class="text-sm text-slate-400">Sayfa ${historyCurrentPage} / ${totalPages}</span> <button id="history-next-btn" class="px-4 py-2 text-sm font-medium text-white bg-slate-600 rounded-md disabled:opacity-50" ${historyCurrentPage === totalPages ? 'disabled' : ''}>İleri</button> `; el.historyPagination.innerHTML = paginationContent; }
                
                function renderCategoryChart() {
                    if (!el.categoryChartCanvas) return;
                    const ctx = el.categoryChartCanvas.getContext('2d');
                    const chartType = document.querySelector('.chart-type-btn.active')?.dataset.type || 'pie';
                    if (categoryChartInstance) categoryChartInstance.destroy();
                    if(userSettings.privacyMode) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.font = "16px Inter"; ctx.fillStyle = '#94a3b8'; ctx.textAlign = "center"; ctx.fillText("Veriler Gizlilik Modu'nda gizlenmiştir.", ctx.canvas.width / 2, ctx.canvas.height / 2); return; }
                    const categoryTotals = purchases.reduce((acc, p) => { acc[p.category || 'Diğer'] = (acc[p.category || 'Diğer'] || 0) + parseFloat(p.totalAmount); return acc; }, {});
                    const labels = Object.keys(categoryTotals);
                    const data = Object.values(categoryTotals);
                    if (labels.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.font = "16px Inter"; ctx.fillStyle = '#94a3b8'; ctx.textAlign = "center"; ctx.fillText("Gösterilecek harcama verisi yok.", ctx.canvas.width / 2, ctx.canvas.height / 2); return; }
                    categoryChartInstance = new Chart(ctx, { type: chartType, data: { labels, datasets: [{ label: 'Harcama Dağılımı', data, backgroundColor: ['#ef4444','#f97316','#eab308','#84cc16','#22c55e','#14b8a6','#06b6d4','#3b82f6','#8b5cf6','#d946ef','#ec4899'], borderColor: '#1f2937', borderWidth: 2 }] }, options: { responsive: true, plugins: { legend: { position: chartType === 'pie' ? 'top' : 'none', labels: { color: '#e2e8f0' } }, tooltip: { callbacks: { label: (c) => `${c.dataset.label || ''}: ${formatCurrency(c.parsed.y || c.parsed)}` } } }, scales: chartType === 'bar' ? { y: { ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' } } } : {} } });
                }
                
                function renderSummary(schedule) { if (!el.summaryPanel) return; let thisMonthPayment = 0; let totalDebt = 0; let nextDueDateInfo = null; let nextStatementDateInfo = null; const today = dayjs(); const paidMonths = userSettings?.paidMonths || {}; Object.entries(schedule).forEach(([monthKey, monthData]) => { Object.entries(monthData.details).forEach(([cardId, cardData]) => { const paymentKey = `${monthKey}_${cardId}`; if (!paidMonths[paymentKey]) { const amount = cardData.amount; const dueDate = dayjs(cardData.dueDate); totalDebt += amount; if (dueDate.format('YYYY-MM') === today.format('YYYY-MM')) thisMonthPayment += amount; if (dueDate.isAfter(today) && (!nextDueDateInfo || dueDate.isBefore(nextDueDateInfo.date))) { nextDueDateInfo = { date: dueDate, cardName: cardData.cardName }; } } }); }); cards.forEach(card => { const statementDay = parseInt(card.statementDay); if (isNaN(statementDay)) return; let nextStatementDate = today.date(statementDay); if (today.isSameOrAfter(nextStatementDate, 'day')) nextStatementDate = nextStatementDate.add(1, 'month'); if (!nextStatementDateInfo || nextStatementDate.isBefore(nextStatementDateInfo.date)) nextStatementDateInfo = { date: nextStatementDate, cardName: card.cardName }; }); el.summaryPanel.innerHTML = `<h2 class="text-xl font-bold mb-4">Durum Özeti</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"><div><p class="text-sm opacity-80">Bu Ay Kalan Ödeme</p><p class="text-2xl font-bold">${formatCurrency(thisMonthPayment)}</p></div><div><p class="text-sm opacity-80">En Yakın Son Ödeme</p><p class="text-2xl font-bold">${nextDueDateInfo ? nextDueDateInfo.date.format('DD.MM.YYYY') : '-'}</p><p class="text-xs opacity-80">${nextDueDateInfo ? nextDueDateInfo.cardName : ''}</p></div><div><p class="text-sm opacity-80">En Yakın Kesim Tarihi</p><p class="text-2xl font-bold">${nextStatementDateInfo ? nextStatementDateInfo.date.format('DD.MM.YYYY') : '-'}</p><p class="text-xs opacity-80">${nextStatementDateInfo ? nextStatementDateInfo.cardName : ''}</p></div><div><p class="text-sm opacity-80">Toplam Kalan Borç</p><p class="text-2xl font-bold">${formatCurrency(totalDebt)}</p></div></div>`; }
                
                function findDefaultPaymentMonth(schedule) { const today = dayjs(); const nextMonthKey = today.add(1, 'month').format('YYYY-MM'); const sortedUnpaidMonths = Object.keys(schedule).filter(m => schedule[m].unpaidTotal > 0).sort(); if (sortedUnpaidMonths.includes(nextMonthKey)) return nextMonthKey; const currentMonthKey = today.format('YYYY-MM'); if(sortedUnpaidMonths.includes(currentMonthKey)) return currentMonthKey; for (const monthKey of sortedUnpaidMonths) { if (dayjs(monthKey).isAfter(today, 'month')) return monthKey; } return sortedUnpaidMonths.length > 0 ? sortedUnpaidMonths[0] : 'all'; }
                function populateCardFilterSelect() { const select = document.getElementById('filter-card'); if (!select) return; const currentVal = select.value; select.innerHTML = '<option value="">Tüm Kartlar</option>'; cards.forEach(card => select.add(new Option(card.cardName, card.id))); if (cards.find(c => c.id === currentVal)) { select.value = currentVal; } }
                function updateCardSelects() { document.querySelectorAll('#card-select, #edit-card-select').forEach(select => { if (!select) return; const currentVal = select.value; select.innerHTML = '<option value="">Kart Seçin</option>'; cards.forEach(card => select.add(new Option(card.cardName, card.id))); if (cards.find(c => c.id === currentVal)) select.value = currentVal; }); }
                function populateCategorySelects() { document.querySelectorAll('#purchase-category, #edit-purchase-category, #filter-category').forEach(select => { if (!select) return; const isFilter = select.id === 'filter-category'; select.innerHTML = `<option value="">${isFilter ? 'Tüm Kategoriler' : 'Kategori Seçin'}</option>`; CATEGORIES.forEach(cat => select.add(new Option(cat, cat))); }); }
                function handleQuickReportRange(range) { const endDateInput = document.getElementById('end-date'); const startDateInput = document.getElementById('start-date'); const today = dayjs(); endDateInput.value = today.format('YYYY-MM-DD'); let startDate; if (range === 'week') startDate = today.subtract(7, 'day'); else if (range === 'month') startDate = today.subtract(1, 'month'); else if (range === 'year') startDate = today.subtract(1, 'year'); if (startDate) { startDateInput.value = startDate.format('YYYY-MM-DD'); handleGenerateReport(); } }
                function handleGenerateReport() { const startDate = document.getElementById('start-date').value; const endDate = document.getElementById('end-date').value; if (!startDate || !endDate) { showInfoModal('Lütfen bir başlangıç ve bitiş tarihi seçin.', 'Uyarı', 'error'); return; } currentReportData = purchases.filter(p => dayjs(p.purchaseDate).isBetween(startDate, endDate, null, '[]')).sort((a,b) => dayjs(b.purchaseDate) - dayjs(a.purchaseDate)); reportCurrentPage = 1; renderReportPage(); }
                function renderReportPage() { if (!el.reportList) return; if (currentReportData.length === 0) { el.reportList.innerHTML = '<p class="text-center text-slate-400">Seçili tarih aralığında raporlanacak veri bulunamadı.</p>'; el.reportSummary.innerHTML = ''; el.reportPagination.innerHTML = ''; el.reportExport.innerHTML = ''; return; } const totalPages = Math.ceil(currentReportData.length / REPORT_ITEMS_PER_PAGE); reportCurrentPage = Math.max(1, Math.min(reportCurrentPage, totalPages)); const startIndex = (reportCurrentPage - 1) * REPORT_ITEMS_PER_PAGE; const pageItems = currentReportData.slice(startIndex, startIndex + REPORT_ITEMS_PER_PAGE); el.reportList.innerHTML = pageItems.map(p => { const card = cards.find(c => c.id === p.cardId); return `<div class="bg-slate-700 p-4 rounded-lg"><p class="font-semibold">${p.purchaseName}</p><p class="text-sm text-slate-300">${p.category||'Diğer'} - ${formatCurrency(p.totalAmount)}</p><p class="text-xs text-slate-400">${dayjs(p.purchaseDate).format('DD.MM.YYYY')} - ${card?.cardName||'Bilinmeyen'}</p></div>`;}).join(''); const total = currentReportData.reduce((sum, p) => sum + parseFloat(p.totalAmount), 0); el.reportSummary.innerHTML = `Toplam Harcama: ${formatCurrency(total)}`; el.reportExport.innerHTML = `<button id="export-pdf-btn" class="bg-red-600 text-white py-2 px-4 rounded-md font-semibold">PDF İndir</button>`; let paginationContent = ''; if (totalPages > 1) { paginationContent = `<button id="report-prev-btn" class="px-4 py-2 text-sm bg-slate-600 rounded-md disabled:opacity-50" ${reportCurrentPage===1?'disabled':''}>Geri</button><span class="text-sm">${reportCurrentPage}/${totalPages}</span><button id="report-next-btn" class="px-4 py-2 text-sm bg-slate-600 rounded-md disabled:opacity-50" ${reportCurrentPage===totalPages?'disabled':''}>İleri</button>`; } el.reportPagination.innerHTML = paginationContent; }
                function exportReportAsPDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFont('Helvetica', 'normal'); doc.text("Harcama Raporu", 14, 22); const tableColumn = ["Tarih", "Aciklama", "Kategori", "Kart", "Tutar (TL)"]; const tableRows = []; let totalAmount = 0; currentReportData.forEach(p => { const card = cards.find(c => c.id === p.cardId); const purchaseData = [ dayjs(p.purchaseDate).format('DD.MM.YYYY'), p.purchaseName, p.category || 'Diger', card ? card.cardName : 'Bilinmiyor', parseFloat(p.totalAmount).toFixed(2) ]; tableRows.push(purchaseData); totalAmount += parseFloat(p.totalAmount); }); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 35 }); doc.text(`Toplam Harcama: ${totalAmount.toFixed(2)} TL`, 14, doc.lastAutoTable.finalY + 15); doc.save(`harcama-raporu.pdf`); }
                function handleBackupData() { if (!currentUser) return; const backupData = { cards, purchases, settings: userSettings, debts }; const jsonString = JSON.stringify(backupData, null, 2); const blob = new Blob([jsonString], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `mak-taksit-yedek.json`; a.click(); URL.revokeObjectURL(a.href); }
                function handleRestoreData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (data.cards && data.purchases && data.settings) { showConfirmModal('Mevcut tüm verileriniz silinecek ve yedekten geri yüklenecektir. Emin misiniz?', 'Yedekten Geri Yükle', () => processRestore(data)); } else { showInfoModal('Geçersiz yedek dosyası.', 'Hata', 'error'); } } catch (err) { showInfoModal('Yedek dosyası okunurken hata oluştu.', 'Hata', 'error'); } }; reader.readAsText(file); }
                async function processRestore(data) { if (!currentUser) return; const batch = writeBatch(db); const collectionsToWipe = ['cards','purchases','debts']; for(const coll of collectionsToWipe){ const snapshot = await getDocs(collection(db, 'users', currentUser.uid, coll)); snapshot.forEach(doc => batch.delete(doc.ref)); } data.cards?.forEach(item=>batch.set(doc(collection(db,'users',currentUser.uid,'cards')),item)); data.purchases?.forEach(item=>batch.set(doc(collection(db,'users',currentUser.uid,'purchases')),item)); data.debts?.forEach(item=>batch.set(doc(collection(db,'users',currentUser.uid,'debts')),item)); batch.set(doc(db,'users',currentUser.uid,'settings','userProfile'), data.settings); await batch.commit(); showInfoModal('Veriler başarıyla geri yüklendi.', 'Başarılı', 'success'); }
                
                function suggestCategory() {
                    const name = el.purchaseNameInput.value.toLowerCase(); if (!name) return;
                    for (const category in CATEGORY_KEYWORDS) { for (const keyword of CATEGORY_KEYWORDS[category]) { if (name.includes(keyword)) { el.purchaseCategorySelect.value = category; return; } } }
                }

                function exportToCalendar() {
                    const monthKey = el.planMonthSelector.value; if (!monthKey || monthKey === 'all') { showInfoModal('Lütfen takvime aktarmak için belirli bir ay seçin.', 'Uyarı', 'error'); return; }
                    const schedule = calculatePaymentSchedule(); const monthData = schedule[monthKey]; if (!monthData || monthData.unpaidTotal === 0) { showInfoModal('Seçili ay için ödenecek ekstre bulunmuyor.', 'Bilgi'); return; }
                    let icsString = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//MAK Taksit Asistani//NONSGML v1.0//TR\n`;
                    Object.entries(monthData.details).forEach(([cardId, payment]) => {
                        const paymentKey = `${monthKey}_${cardId}`; if (userSettings?.paidMonths?.[paymentKey]) return;
                        const dueDate = dayjs(payment.dueDate);
                        icsString += `BEGIN:VEVENT\nUID:${monthKey}-${cardId}@maktaksit.com\nDTSTAMP:${dayjs().format('YYYYMMDDTHHmmss')}Z\nDTSTART;VALUE=DATE:${dueDate.format('YYYYMMDD')}\nDTEND;VALUE=DATE:${dueDate.add(1,'day').format('YYYYMMDD')}\nSUMMARY:${payment.cardName} Ekstre Ödemesi - ${formatCurrency(payment.amount)}\nDESCRIPTION:MAK Taksit Asistanı hatırlatması.\nEND:VEVENT\n`;
                    });
                    icsString += `END:VCALENDAR`;
                    const blob = new Blob([icsString], { type: 'text/calendar;charset=utf-8' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `odeme-plani-${monthKey}.ics`; a.click(); URL.revokeObjectURL(a.href);
                }
                
                // --- OLAY İŞLEYİCİLER (EVENT HANDLERS) ---
                async function handleFormSubmits(e) {
                    if (!currentUser) return;
                    e.preventDefault();
                    const form = e.target;
                    
                    if (form.id === 'add-purchase-form') { const newPurchase = { purchaseName: form.elements['purchase-name'].value, purchaseDate: form.elements['purchase-date'].value, totalAmount: parseFloat(form.elements['total-amount'].value), installmentsCount: parseInt(form.elements['installments-count'].value), cardId: form.elements['card-select'].value, category: form.elements['purchase-category'].value, isRecurring: form.elements['purchase-recurring'].checked, createdAt: serverTimestamp() }; if (form.elements['first-installment-month'].value) { newPurchase.firstInstallmentMonth = form.elements['first-installment-month'].value; } await addDoc(collection(db, 'users', currentUser.uid, 'purchases'), newPurchase); form.reset(); el.purchaseDateInput.valueAsDate = new Date(); } 
                    else if (form.id === 'add-card-form') { await addDoc(collection(db, 'users', currentUser.uid, 'cards'), { cardName: form.elements['card-name'].value, statementDay: parseInt(form.elements['statement-day'].value), cardLimit: parseFloat(form.elements['card-limit'].value), createdAt: serverTimestamp() }); form.reset(); } 
                    else if (form.id === 'edit-card-form') { await updateDoc(doc(db, 'users', currentUser.uid, 'cards', form.elements['edit-card-id'].value), { cardName: form.elements['edit-card-name'].value, statementDay: parseInt(form.elements['edit-statement-day'].value), cardLimit: parseFloat(form.elements['edit-card-limit'].value) }); closeEditCardModal(); } 
                    else if (form.id === 'edit-purchase-form') { const updatedPurchase = { purchaseName: form.elements['edit-purchase-name'].value, purchaseDate: form.elements['edit-purchase-date'].value, totalAmount: parseFloat(form.elements['edit-total-amount'].value), installmentsCount: parseInt(form.elements['edit-installments-count'].value), cardId: form.elements['edit-card-select'].value, category: form.elements['edit-purchase-category'].value, isRecurring: form.elements['edit-purchase-recurring'].checked, firstInstallmentMonth: form.elements['edit-first-installment-month'].value || null }; await updateDoc(doc(db, 'users', currentUser.uid, 'purchases', form.elements['edit-purchase-id'].value), updatedPurchase); closeEditPurchaseModal(); } 
                    else if (form.id === 'add-debt-form') { await addDoc(collection(db, 'users', currentUser.uid, 'debts'), { debtName: form.elements['debt-name'].value, totalAmount: parseFloat(form.elements['debt-total-amount'].value), monthlyPayment: parseFloat(form.elements['debt-monthly-payment'].value), dueDay: parseInt(form.elements['debt-due-day'].value), paidAmount: 0, createdAt: serverTimestamp() }); form.reset(); } 
                }
                
                function bindEventListeners() {
                    document.body.addEventListener('submit', handleFormSubmits);
                    document.body.addEventListener('input', e => { if (e.target.id === 'search-input') renderPurchasesList(); if (e.target.id === 'custom-theme-picker') updateSettings({ theme: 'custom', customThemeColor: e.target.value }); });
                    document.body.addEventListener('change', e => { if (e.target.id === 'filter-category' || e.target.id === 'filter-card') renderPurchasesList(); if (e.target.id === 'privacy-mode-toggle') updateSettings({ privacyMode: e.target.checked }); if (e.target.id === 'plan-month-selector') { selectedPlanMonth = e.target.value; renderPaymentPlan(calculatePaymentSchedule(), selectedPlanMonth); } if (e.target.id === 'restore-file-input') handleRestoreData(e); });
                    document.body.addEventListener('click', handleBodyClicks);
                    el.purchaseNameInput.addEventListener('blur', suggestCategory);
                    el.onboardingNext.addEventListener('click', () => { currentStep++; showStep(currentStep); });
                    el.onboardingSkip.addEventListener('click', endOnboarding);
                    document.getElementById('chart-type-selector').addEventListener('click', e => {
                        const btn = e.target.closest('.chart-type-btn');
                        if (btn && !btn.classList.contains('active')) {
                            document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active', 'bg-slate-900', 'text-white'));
                            btn.classList.add('active', 'bg-slate-900', 'text-white');
                            renderCategoryChart();
                        }
                    });
                }

                async function handleBodyClicks(e) {
                    const btn = e.target.closest('button');
                    if (!btn || !currentUser) return;
                    const id = btn.dataset.id, key = btn.dataset.key;
                    
                    const actions = {
                        '.pay-btn': async () => { const newPaidStatus = { ...userSettings.paidMonths, [key]: { paidDate: dayjs().toISOString() } }; await updateSettings({ paidMonths: newPaidStatus }); selectedPlanMonth = findDefaultPaymentMonth(calculatePaymentSchedule()); },
                        '.undo-pay-btn': async () => { const newPaidStatus = { ...userSettings.paidMonths }; delete newPaidStatus[key]; await updateSettings({ paidMonths: newPaidStatus }); selectedPlanMonth = key.split('_')[0]; },
                        '#history-prev-btn': () => { if(historyCurrentPage > 1) { historyCurrentPage--; renderHistory(calculatePaymentSchedule()); } },
                        '#history-next-btn': () => { const totalPages = Math.ceil(Object.keys(userSettings?.paidMonths || {}).length / HISTORY_ITEMS_PER_PAGE); if(historyCurrentPage < totalPages) { historyCurrentPage++; renderHistory(calculatePaymentSchedule()); } },
                        '#report-prev-btn': () => { if(reportCurrentPage > 1) { reportCurrentPage--; renderReportPage(); } },
                        '#report-next-btn': () => { const totalPages = Math.ceil(currentReportData.length / REPORT_ITEMS_PER_PAGE); if(reportCurrentPage < totalPages) { reportCurrentPage++; renderReportPage(); } },
                        '[data-panel]': () => { if(btn.closest('#bottom-nav')) { document.querySelectorAll('.bottom-nav-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); document.querySelectorAll('.main-panel').forEach(p => p.classList.remove('active')); document.getElementById(`panel-${btn.dataset.panel}`).classList.add('active'); } },
                        '[data-theme]': () => { if(btn.closest('#theme-selector')) updateSettings({ theme: btn.dataset.theme, customThemeColor: null }); },
                        '.quick-range-btn': () => handleQuickReportRange(btn.dataset.range),
                        '#generate-report-btn': () => handleGenerateReport(),
                        '#export-pdf-btn': () => exportReportAsPDF(),
                        '#backup-data-btn': () => handleBackupData(),
                        '#restore-data-btn': () => el.restoreFileInput.click(),
                        '#delete-all-data-btn': () => handleDeleteAllData(),
                        '#cancel-delete-btn': () => closeDeleteModal(),
                        '#cancel-edit-purchase-btn': () => closeEditPurchaseModal(),
                        '#cancel-edit-card-btn': () => closeEditCardModal(),
                        '#confirm-delete-btn': () => handleConfirmDelete(),
                        '.delete-card-btn': () => { const card = cards.find(c => c.id === id); if(card) openDeleteModal(id, 'card', card.cardName, btn.closest('.bg-slate-700')); },
                        '.delete-purchase-btn': () => { const purchase = purchases.find(p => p.id === id); if(purchase) openDeleteModal(id, 'purchase', purchase.purchaseName, btn.closest('.flex')); },
                        '.edit-card-btn': () => openEditCardModal(id),
                        '.edit-purchase-btn': () => openEditPurchaseModal(id),
                        '#export-calendar-btn': () => exportToCalendar(),
                        '.pay-debt-btn': async () => { const debt = debts.find(d => d.id === id); if (debt) { const newPaidAmount = (parseFloat(debt.paidAmount) || 0) + parseFloat(debt.monthlyPayment); await updateDoc(doc(db, 'users', currentUser.uid, 'debts', id), { paidAmount: newPaidAmount }); } },
                        '.delete-debt-btn': () => { const debt = debts.find(d => d.id === id); if(debt) openDeleteModal(id, 'debt', debt.debtName, btn.closest('.bg-slate-700')); },
                    };
                    for (const selector in actions) { if (btn.matches(selector)) { actions[selector](); return; } }
                }
                
                async function handleConfirmDelete() {
                    if (!currentUser) return;
                    const { id, type, element } = { ...itemToDelete }; 
                    itemToDelete = {}; 
                    if (element) element.classList.add('item-fade-out');
                    setTimeout(async () => {
                        try {
                            const pathMap = { purchase: 'purchases', card: 'cards', debt: 'debts' };
                            if(type === 'card'){
                                const batch = writeBatch(db);
                                batch.delete(doc(db, 'users', currentUser.uid, 'cards', id));
                                const relatedPurchases = purchases.filter(p => p.cardId === id);
                                relatedPurchases.forEach(p => batch.delete(doc(db, 'users', currentUser.uid, 'purchases', p.id)));
                                await batch.commit();
                            } else if (pathMap[type]) {
                                await deleteDoc(doc(db, 'users', currentUser.uid, pathMap[type], id));
                            }
                        } catch (error) {
                            console.error("Silme hatası:", error);
                            showInfoModal("Öğe silinirken bir hata oluştu.", "Hata", "error");
                            if (element) element.classList.remove('item-fade-out');
                        } finally {
                            closeDeleteModal();
                        }
                    }, 300);
                }
                
                async function handleDeleteAllData() { showConfirmModal('<b>Tüm verileriniz kalıcı olarak silinecektir.</b> Bu işlem geri alınamaz. Emin misiniz?', 'Tüm Verileri Sil', async () => { if(!currentUser) return; const batch = writeBatch(db); const collectionsToWipe = ['cards', 'purchases', 'debts']; for (const collName of collectionsToWipe) { const snapshot = await getDocs(collection(db, 'users', currentUser.uid, collName)); snapshot.forEach(doc => batch.delete(doc.ref)); } await batch.commit(); showInfoModal('Tüm verileriniz başarıyla silindi.', 'Başarılı', 'success'); }, 'EVET, TÜMÜNÜ SİL'); }
                
                function init() {
                    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').catch(err => console.log('SW Registration Failed:', err)); }); }
                    bindEventListeners();
                    el.purchaseDateInput.valueAsDate = new Date();
                }
                init();
            });
        } catch (error) {
            console.error("Firebase başlatma hatası:", error);
            document.body.innerHTML = `<div class="flex items-center justify-center h-screen bg-gray-900 text-white"><div class="text-center"><h1 class="text-2xl font-bold text-red-500">Uygulama Başlatılamadı</h1><p class="mt-2 text-gray-400">Firebase yapılandırması eksik veya hatalı. Lütfen konsolu kontrol edin.</p></div></div>`;
        }
    </script>
</body>
</html>
